<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>FORGE â€” Gym Tracker</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2ecc71">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FORGE">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=Barlow+Condensed:wght@300;400;600;700&family=Barlow:wght@300;400;500&family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root {
  --bg:#080c09; --bg2:#0d1410; --bg3:#111a12;
  --panel:#131c14; --panel2:#182019;
  --border:#1e2e1f; --border2:#253527;
  --green:#2ecc71; --green2:#27ae60; --green3:#1a7a3f;
  --green-dim:#1d4a2a; --green-glow:#2ecc7133;
  --accent:#39ff8f; --text:#c8dcc9; --text2:#7a9e7e; --text3:#4a6a4e;
  --danger:#e74c3c; --warn:#f39c12; --white:#eaf4eb;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{
  background:var(--bg); color:var(--text);
  font-family:'Barlow',sans-serif; font-weight:300;
  min-height:100vh; overflow-x:hidden;
  padding-top:var(--safe-top);
  padding-bottom:calc(var(--safe-bot) + 64px);
}
body::before{
  content:''; position:fixed; inset:0;
  background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
  background-size:48px 48px; opacity:.3; pointer-events:none; z-index:0;
}

/* â”€â”€ LAYOUT â”€â”€ */
.app-shell{position:relative;z-index:2;max-width:640px;margin:0 auto;padding:0 16px;}

/* â”€â”€ AMBIENT SPOTLIGHT GLOW â”€â”€ */
body::before {
  content:'';
  position:fixed; inset:0; pointer-events:none; z-index:0;
  background: radial-gradient(
    ellipse 420px 340px at var(--glow-x, 50%) var(--glow-y, 40%),
    var(--green-glow, rgba(57,255,143,0.07)) 0%,
    transparent 70%
  );
  transition: background 0.15s ease;
  animation: ambientDrift 8s ease-in-out infinite alternate;
}
@keyframes ambientDrift {
  0%   { opacity: 0.7; }
  50%  { opacity: 1.0; }
  100% { opacity: 0.6; }
}

/* â”€â”€ HEADER â”€â”€ */
header{
  display:flex; align-items:center; justify-content:space-between;
  padding:20px 0 14px; border-bottom:1px solid var(--border2); margin-bottom:20px;
  position:sticky; top:0; z-index:50;
  background:linear-gradient(var(--bg) 85%,transparent);
  padding-top:calc(20px + var(--safe-top));
}
.logo{display:flex;align-items:baseline;gap:8px;}
.logo-word{
  font-family:'Bebas Neue',sans-serif; font-size:36px; letter-spacing:5px;
  color:var(--accent); text-shadow:0 0 20px var(--green-glow); line-height:1;
}
.logo-tag{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:1.5px;}
.header-right{display:flex;align-items:center;gap:10px;}
.status-pill{
  display:flex;align-items:center;gap:6px;
  background:var(--panel);border:1px solid var(--border2);
  border-radius:20px;padding:5px 12px;
  font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);letter-spacing:1px;
}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 8px var(--green);}50%{opacity:.5;box-shadow:0 0 3px var(--green);}}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{
  position:fixed; bottom:0; left:0; right:0;
  background:var(--bg2); border-top:1px solid var(--border2);
  display:flex; z-index:100;
  padding-bottom:var(--safe-bot);
}
.bnav-btn{
  flex:1; display:flex; flex-direction:column; align-items:center;
  gap:4px; padding:10px 6px; border:none; background:transparent;
  color:var(--text3); cursor:pointer; transition:all .2s;
  font-family:'Barlow Condensed',sans-serif;
  font-size:11px; font-weight:600; letter-spacing:1px; text-transform:uppercase;
}
.bnav-btn .bnav-icon{font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center;}
.bnav-btn .bnav-icon svg{width:22px;height:22px;stroke:currentColor;transition:stroke .2s,filter .2s;}
.bnav-btn.active,.bnav-btn:hover{color:var(--accent);}
.bnav-btn.active .bnav-icon svg{stroke:var(--accent);filter:drop-shadow(0 0 5px var(--accent));}
.bnav-btn{position:relative;overflow:hidden;}

/* â”€â”€ VIEWS â”€â”€ */
.view{display:none;}
.view.active{display:block;animation:fadeUp .3s ease both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

/* â”€â”€ VIEW SECTION HEADERS â”€â”€ */
.view-section-header{
  display:flex;align-items:center;gap:8px;
  margin:22px 0 10px;
}
.vsh-icon{font-size:15px;line-height:1;display:flex;align-items:center;color:var(--accent);transition:filter .25s,transform .2s;}
.view-section-header:hover .vsh-icon svg{filter:drop-shadow(0 0 5px var(--accent));transform:scale(1.12);}

/* â”€â”€ GLOBAL SVG ICON TRANSITIONS â”€â”€ */
svg{transition:filter .2s,stroke .2s,transform .2s;}

/* Edit layout button icon glow on hover/active */
.edit-layout-btn:hover svg{filter:drop-shadow(0 0 4px var(--accent));stroke:var(--accent);}
.edit-layout-btn:active svg{filter:drop-shadow(0 0 8px var(--accent));transform:scale(0.9);}

/* Mode toggle: icon glows when active */
.mode-toggle-btn svg.mode-icon{color:var(--text3);transition:filter .2s,color .2s,transform .2s;}
.mode-toggle-btn.active svg.mode-icon{color:var(--accent);filter:drop-shadow(0 0 6px var(--accent));}
.mode-toggle-btn:not(.active):hover svg.mode-icon{color:var(--text2);filter:drop-shadow(0 0 3px var(--text2));}

/* Coach tabs: icon glow on active/hover */
.coach-tab svg.ctab-icon{color:var(--text3);transition:filter .2s,color .2s;}
.coach-tab.active svg.ctab-icon{color:var(--accent);filter:drop-shadow(0 0 5px var(--accent));}
.coach-tab:hover svg.ctab-icon{color:var(--text2);}

/* Coach avatar: pulse glow animation */
@keyframes forge-brain-pulse{0%,100%{filter:drop-shadow(0 0 4px var(--accent));}50%{filter:drop-shadow(0 0 10px var(--accent)) drop-shadow(0 0 18px var(--accent));}}
.coach-avatar svg{animation:forge-brain-pulse 3s ease-in-out infinite;color:var(--accent);}

/* Profile avatar: hover glow */
.profile-avatar{transition:box-shadow .25s;}
.profile-avatar:hover{box-shadow:0 0 16px rgba(57,255,143,.35);}
.profile-avatar svg{color:var(--accent);}

/* Tip icons: accent color + hover scale */
.tip-icon{font-size:22px;flex-shrink:0;margin-top:1px;color:var(--accent);transition:filter .2s,transform .2s;}
.tip-card:hover .tip-icon svg{filter:drop-shadow(0 0 6px var(--accent));transform:scale(1.15);}

/* Hist muscle badge: hover glow */
.hist-muscle-badge{transition:box-shadow .2s,border-color .2s;}
.hist-item:hover .hist-muscle-badge{box-shadow:0 0 10px rgba(57,255,143,.3);border-color:var(--accent);}
.hist-muscle-badge svg{color:var(--accent);}

/* Save / CTA buttons: lightning bolt glow on hover */
#save-btn:hover .btn-icon-svg,
.mo-cta-btn:hover .btn-icon-svg{filter:drop-shadow(0 0 6px currentColor);animation:bolt-zap .35s ease-out;}
@keyframes bolt-zap{0%{transform:scale(1);}40%{transform:scale(1.4) rotate(-5deg);}100%{transform:scale(1);}}

/* Mission title icon: star glow */
.mission-title svg{color:var(--accent);filter:drop-shadow(0 0 4px var(--accent));animation:star-spin 6s linear infinite;}
@keyframes star-spin{0%{filter:drop-shadow(0 0 3px var(--accent));}50%{filter:drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 14px var(--accent));}100%{filter:drop-shadow(0 0 3px var(--accent));}}

/* View hero icons: glow ring */
.view-hero-icon{transition:filter .3s;}
.view-hero-icon svg{color:var(--accent);filter:drop-shadow(0 0 6px var(--accent));}

/* Steps panel icons */
.steps-title svg,.steps-sub-stat svg{color:var(--accent);}

/* Lmb (light mode) sun icon glow */
.lmb-icon svg{color:#f0a020;filter:drop-shadow(0 0 5px rgba(240,160,32,.5));animation:sun-rays 4s ease-in-out infinite;}
@keyframes sun-rays{0%,100%{filter:drop-shadow(0 0 4px rgba(240,160,32,.5));}50%{filter:drop-shadow(0 0 10px rgba(240,160,32,.8)) drop-shadow(0 0 18px rgba(240,160,32,.3));}}

/* Achievement popup icon */
.ach-emoji svg{color:var(--accent);filter:drop-shadow(0 0 8px var(--accent));animation:ach-pop .5s cubic-bezier(.175,.885,.32,1.275) forwards;}
@keyframes ach-pop{0%{transform:scale(0) rotate(-20deg);}80%{transform:scale(1.2) rotate(5deg);}100%{transform:scale(1) rotate(0);}}

/* Empty state icons: subtle pulse */
.empty-icon svg{color:var(--text3);animation:empty-pulse 3s ease-in-out infinite;}
@keyframes empty-pulse{0%,100%{opacity:.5;transform:scale(1);}50%{opacity:.8;transform:scale(1.05);}}

/* Mo-muscle-icon (overlay): accent glow */
.mo-muscle-icon svg{color:var(--accent);filter:drop-shadow(0 0 8px var(--accent));transition:filter .3s;}

/* Data/export button icons: color on hover */
.btn-ghost:hover svg{color:var(--accent);filter:drop-shadow(0 0 4px var(--accent));}
.btn-danger:hover svg{color:#fff;}

/* VSH section header icon: accent colored */
.vsh-icon svg{color:var(--accent);}
.vsh-title{
  font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:2.5px;text-transform:uppercase;color:var(--text3);
  white-space:nowrap;
}
.vsh-badge{
  font-family:'DM Mono',monospace;font-size:9px;padding:2px 7px;
  border-radius:4px;background:var(--green-dim);color:var(--green);
  letter-spacing:1px;white-space:nowrap;
}
.vsh-line{flex:1;height:1px;background:var(--border2);}

/* â”€â”€ VIEW HERO BANNERS â”€â”€ */
.view-hero{
  display:flex;align-items:center;gap:14px;
  background:linear-gradient(135deg,var(--panel) 0%,var(--panel2) 100%);
  border:1px solid var(--border2);border-radius:14px;
  padding:16px 18px;margin-bottom:4px;
  position:relative;overflow:hidden;
}
.view-hero::after{
  content:'';position:absolute;top:-40px;right:-40px;
  width:120px;height:120px;border-radius:50%;
  background:var(--green-glow);filter:blur(30px);
  pointer-events:none;
}
.view-hero-icon{font-size:36px;line-height:1;flex-shrink:0;}
.view-hero-title{
  font-family:'Bebas Neue',sans-serif;font-size:22px;
  letter-spacing:3px;color:var(--accent);line-height:1;
}
.view-hero-sub{
  font-family:'DM Mono',monospace;font-size:10px;
  color:var(--text3);letter-spacing:1px;margin-top:4px;
}

/* â”€â”€ BW STAT CARDS â”€â”€ */
.bw-stats-bar{margin-bottom:8px;}
.bw-card::before{background:var(--accent)!important;opacity:.6;}
.bw-top-ex{font-size:16px!important;letter-spacing:1px!important;}

/* â”€â”€ FILTER PANEL â”€â”€ */
.filter-body{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px 14px!important;}
.filter-row{display:flex;flex-direction:column;gap:4px;}
.filter-row:last-child{grid-column:1/-1;}

/* â”€â”€ LIGHT MODE BANNER â”€â”€ */
.light-mode-banner{
  display:flex;align-items:center;justify-content:space-between;
  background:linear-gradient(135deg,#1e2a1f 0%,#162018 100%);
  border:1px solid #c07000;border-radius:10px;
  padding:12px 14px;margin-bottom:14px;gap:12px;
}
body[data-theme="solar"] .light-mode-banner{
  background:linear-gradient(135deg,#fff3d0 0%,#fde8a0 100%);
  border-color:#c07000;
}
.lmb-left{display:flex;align-items:center;gap:10px;}
.lmb-icon{font-size:24px;line-height:1;}
.lmb-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#e8a820;}
body[data-theme="solar"] .lmb-title{color:#7a4500;}
.lmb-sub{font-family:'DM Mono',monospace;font-size:10px;color:#a07830;margin-top:2px;}
body[data-theme="solar"] .lmb-sub{color:#b06020;}

/* â”€â”€ TOGGLE ROW SUB-TEXT â”€â”€ */
.toggle-sub{font-size:12px;color:var(--text3);margin-top:2px;}

/* â”€â”€ STAT CARDS â”€â”€ */
.stats-bar{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;}
.stat-card{
  background:var(--panel);border:1px solid var(--border2);border-radius:10px;
  padding:14px 16px;position:relative;overflow:hidden;
}
.stat-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--green);}
.stat-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:6px;}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--white);line-height:1;letter-spacing:2px;}
.stat-unit{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);margin-left:3px;}
.stat-delta{font-family:'DM Mono',monospace;font-size:10px;margin-top:4px;}
.stat-delta.up{color:var(--green);}
.stat-delta.neutral{color:var(--text3);}

/* â”€â”€ PANELS â”€â”€ */
.panel{background:var(--panel);border:1px solid var(--border2);border-radius:12px;overflow:hidden;margin-bottom:14px;}
.panel-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 16px;border-bottom:1px solid var(--border);background:var(--panel2);
}
.panel-title{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text);}
.panel-badge{font-family:'DM Mono',monospace;font-size:9px;padding:3px 8px;border-radius:4px;background:var(--green-dim);color:var(--green);letter-spacing:1px;}
.panel-body{padding:16px;}

/* â”€â”€ FORM â”€â”€ */
.form-group{margin-bottom:14px;}
label{display:block;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:6px;}
input,select,textarea{
  width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;
  padding:11px 13px;color:var(--text);font-family:'Barlow',sans-serif;font-size:16px;
  outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;
  /* iOS font-size fix â€” prevents auto-zoom */
}
input:focus,select:focus{border-color:var(--green3);box-shadow:0 0 0 3px var(--green-glow);}
select option{background:var(--bg2);}

/* â”€â”€ MUSCLE GRID â”€â”€ */
.muscle-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.muscle-btn{
  background:var(--bg3);border:1px solid var(--border2);border-radius:8px;
  padding:12px 6px;text-align:center;cursor:pointer;transition:all .2s;
  color:var(--text2);font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:600;letter-spacing:1px;text-transform:uppercase;
  display:flex;flex-direction:column;align-items:center;gap:5px;
  -webkit-tap-highlight-color:transparent;
}
.muscle-btn .m-icon{font-size:22px;line-height:1;}
.muscle-btn:active{transform:scale(.96);}
.muscle-btn.selected{border-color:var(--green);color:var(--accent);background:var(--green-dim);box-shadow:0 0 10px var(--green-glow);}

/* â”€â”€ SETS â”€â”€ */
.sets-header{display:grid;grid-template-columns:36px 1fr 1fr 60px 34px;gap:6px;padding:0 0 7px;border-bottom:1px solid var(--border);margin-bottom:7px;}
.sets-header span{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text3);}
.set-row{display:grid;grid-template-columns:36px 1fr 1fr 60px 34px;gap:6px;align-items:center;margin-bottom:7px;animation:slideIn .2s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}
.set-num{font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--green);text-align:center;}
.set-row input{padding:8px;font-size:16px;text-align:center;min-height:44px;}
.set-row select{padding:8px 4px;font-size:16px;min-height:44px;}
.btn-icon{
  width:30px;height:30px;border-radius:6px;border:1px solid var(--border2);
  background:var(--bg);color:var(--text3);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s;
}
.btn-icon:hover{border-color:var(--danger);color:var(--danger);}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:12px 18px;border-radius:8px;border:none;
  font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .2s;
  -webkit-tap-highlight-color:transparent;
}
.btn-primary{background:var(--green);color:var(--bg);width:100%;font-size:16px;padding:14px;box-shadow:0 0 20px var(--green-glow);}
.btn-primary:hover{background:var(--accent);box-shadow:0 0 30px rgba(46,204,113,.4);transform:translateY(-1px);}
.btn-primary:active{transform:scale(.98);}
.btn-primary.loading{opacity:.7;pointer-events:none;}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--text2);}
.btn-ghost:hover{border-color:var(--green3);color:var(--green);}
.btn-add{background:transparent;border:1px dashed var(--border2);color:var(--text3);width:100%;padding:9px;font-size:11px;margin-top:4px;}
.btn-add:hover{border-color:var(--green3);color:var(--green);}
.btn-sm{padding:7px 14px;font-size:12px;}
.btn-danger{background:transparent;border:1px solid var(--danger);color:var(--danger);}

/* â”€â”€ CHARTS â”€â”€ */
.chart-inner{padding:14px;position:relative;}
.chart-inner.h180{height:180px;}
.chart-inner.h220{height:220px;}
.chart-inner.h260{height:260px;}

/* â”€â”€ HISTORY â”€â”€ */
.history-list{display:flex;flex-direction:column;gap:10px;}
.hist-item{
  background:var(--bg3);border:1px solid var(--border);border-radius:9px;
  padding:12px 14px;display:flex;align-items:center;gap:12px;
  transition:border-color .2s;
}
.hist-item:active{border-color:var(--green3);}
.hist-muscle-badge{width:40px;height:40px;border-radius:8px;background:var(--green-dim);border:1px solid var(--green3);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.hist-info{flex:1;min-width:0;}
.hist-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;letter-spacing:1px;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-meta{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);margin-top:2px;}
.hist-stats{display:flex;gap:12px;align-items:center;}
.hist-stat-val{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--green);line-height:1;}
.hist-stat-lbl{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;}
.trend-arrow{font-size:16px;}
.trend-arrow.up{color:var(--green);}
.trend-arrow.same{color:var(--text3);}
.trend-arrow.down{color:var(--danger);}

/* â”€â”€ TIPS â”€â”€ */
.tips-list{display:flex;flex-direction:column;gap:10px;}
.tip-card{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;gap:12px;transition:border-color .2s;}
.tip-card:hover{border-color:var(--accent);}
.tip-icon{font-size:22px;flex-shrink:0;margin-top:1px;}
.tip-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--accent);margin-bottom:3px;}
.tip-text{font-size:13px;color:var(--text2);line-height:1.5;}

/* â”€â”€ PROGRESS BARS â”€â”€ */
.prog-bar-wrap{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-top:8px;}
.prog-bar-fill{height:100%;background:linear-gradient(90deg,var(--green2),var(--accent));border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1);}
.vol-list{display:flex;flex-direction:column;gap:10px;padding:14px;}
.vol-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.vol-name{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text);}
.vol-val{font-family:'DM Mono',monospace;font-size:11px;color:var(--green);}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state{text-align:center;padding:40px 16px;color:var(--text3);}
.empty-icon{font-size:42px;margin-bottom:10px;opacity:.4;}
.empty-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;}
.empty-sub{font-size:12px;}

/* â”€â”€ TOAST â”€â”€ */
.toast{
  position:fixed;bottom:calc(80px + var(--safe-bot));left:50%;
  transform:translateX(-50%) translateY(60px);
  background:var(--green);color:var(--bg);
  font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;
  padding:10px 24px;border-radius:30px;
  box-shadow:0 0 30px var(--green-glow);
  z-index:999;transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;
}
.toast.show{transform:translateX(-50%) translateY(0);}

/* â”€â”€ TIMER WIDGET â”€â”€ */
.timer-widget{
  background:var(--panel);border:1px solid var(--border2);border-radius:12px;
  padding:16px;display:flex;align-items:center;justify-content:space-between;
  margin-bottom:14px;
}
.timer-display{font-family:'Bebas Neue',sans-serif;font-size:44px;color:var(--accent);letter-spacing:4px;line-height:1;}
.timer-display.rest{color:var(--warn);}
.timer-display.done{color:var(--green);}
.timer-controls{display:flex;flex-direction:column;gap:8px;align-items:flex-end;}
.timer-preset-row{display:flex;gap:6px;}
.timer-preset-btn{
  background:var(--bg3);border:1px solid var(--border2);border-radius:6px;
  padding:5px 10px;color:var(--text2);cursor:pointer;font-family:'DM Mono',monospace;
  font-size:11px;transition:all .15s;
}
.timer-preset-btn:hover,.timer-preset-btn.active{border-color:var(--green3);color:var(--green);background:var(--green-dim);}

/* â”€â”€ BODY MAP â”€â”€ */
.body-map-wrap{display:flex;justify-content:center;padding:12px;}
.body-map-svg .muscle-zone{fill:#1d4a2a;stroke:#253527;stroke-width:1;cursor:pointer;transition:fill .2s;}
.body-map-svg .muscle-zone:hover{fill:#27ae60;}
.body-map-svg .muscle-zone.trained{fill:#2ecc71;}
.body-map-svg .muscle-zone.selected{fill:#39ff8f;}

/* â”€â”€ INTERACTIVE BODY SVG â”€â”€ */
.body-map-container{display:flex;justify-content:center;}
.body-svg{width:160px;height:auto;cursor:default;}
.body-zone{
  fill:#1e3422;stroke:#2a4a2e;stroke-width:1;
  cursor:pointer;transition:fill .18s,filter .18s;
}
.body-zone:hover{fill:#2ecc71;filter:drop-shadow(0 0 5px #2ecc7188);}
.body-zone.zone-selected{fill:#39ff8f;filter:drop-shadow(0 0 8px #39ff8faa);}
.body-label{
  font-family:'Bebas Neue',sans-serif;font-size:8px;letter-spacing:1px;
  fill:#4a6a4e;text-anchor:middle;dominant-baseline:middle;pointer-events:none;
}
.body-label.sm{font-size:6.5px;}
.body-view-btn{
  flex:1;padding:7px 0;border-radius:6px;border:1px solid var(--border2);
  background:var(--bg3);color:var(--text2);cursor:pointer;
  font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;
  letter-spacing:1.5px;text-transform:uppercase;transition:all .2s;
}
.body-view-btn.active{background:var(--green-dim);border-color:var(--green3);color:var(--accent);}
.body-view-btn:hover:not(.active){border-color:var(--green3);color:var(--green);}

/* â”€â”€ MUSCLE HISTORY â”€â”€ */
.mh-exercise-block{border-bottom:1px solid var(--border);padding:12px 16px;}
.mh-exercise-block:last-child{border-bottom:none;}
.mh-ex-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.mh-ex-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;letter-spacing:1px;color:var(--white);}
.mh-ex-count{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;}
.mh-sessions{display:flex;flex-direction:column;gap:8px;}
.mh-session{background:var(--bg3);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.mh-session-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--panel2);}
.mh-session-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--green);letter-spacing:1px;}
.mh-session-vol{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);}
.mh-session-pr{display:inline-flex;align-items:center;gap:3px;background:#2d1f00;border:1px solid var(--warn);border-radius:10px;padding:1px 7px;font-family:'DM Mono',monospace;font-size:9px;color:var(--warn);}
.mh-sets-table{padding:8px 12px;display:flex;flex-direction:column;gap:4px;}
.mh-set-row{display:grid;grid-template-columns:28px 1fr 1fr 1fr;gap:6px;align-items:center;}
.mh-set-num{font-family:'Bebas Neue',sans-serif;font-size:14px;color:var(--green3);text-align:center;}
.mh-set-val{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);}
.mh-set-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;}
.mh-set-header{display:grid;grid-template-columns:28px 1fr 1fr 1fr;gap:6px;padding:4px 12px 0;margin-bottom:2px;}
.mh-session-notes{padding:0 12px 8px;font-size:12px;color:var(--text3);font-style:italic;}
.mh-collapse-btn{font-size:11px;color:var(--text3);background:none;border:none;cursor:pointer;padding:0;letter-spacing:1px;font-family:'DM Mono',monospace;}
.mh-empty{text-align:center;padding:28px 16px;color:var(--text3);}
.mh-empty-icon{font-size:32px;margin-bottom:8px;opacity:.4;}
.mh-load-more{width:100%;padding:10px;background:transparent;border:none;border-top:1px solid var(--border);color:var(--text3);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;cursor:pointer;transition:color .2s;}
.mh-load-more:hover{color:var(--green);}

/* â”€â”€ EXERCISE AUTOCOMPLETE â”€â”€ */
.ex-autocomplete{
  position:absolute;top:100%;left:0;right:0;z-index:60;
  background:var(--bg2);border:1px solid var(--green3);border-top:none;
  border-radius:0 0 8px 8px;max-height:180px;overflow-y:auto;
  box-shadow:0 8px 24px rgba(0,0,0,.5);
}
.ex-ac-item{
  padding:10px 13px;font-size:14px;color:var(--text);cursor:pointer;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);transition:background .15s;
  -webkit-tap-highlight-color:transparent;
}
.ex-ac-item:last-child{border-bottom:none;}
.ex-ac-item:hover,.ex-ac-item:active{background:var(--green-dim);}
.ex-ac-item .ac-muscle{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;}

/* â”€â”€ WATER TRACKER â”€â”€ */
.water-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;padding:14px;}
.water-cup{
  aspect-ratio:1;border-radius:6px;border:1.5px solid var(--border2);
  background:var(--bg3);display:flex;align-items:center;justify-content:center;
  font-size:18px;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent;
}
.water-cup.filled{background:rgba(46,204,113,.2);border-color:var(--green3);}
.water-cup.filled::after{content:'ğŸ’§';}
.water-cup:not(.filled)::after{content:'â—‹';}
.water-cup:not(.filled)::after{font-size:12px;color:var(--text3);}

/* â”€â”€ BODY WEIGHT LOG â”€â”€ */
.bw-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.bw-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);min-width:70px;}
.bw-val{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--green);line-height:1;}
.bw-delta{font-family:'DM Mono',monospace;font-size:10px;}
.bw-delta.up{color:var(--danger);}
.bw-delta.down{color:var(--green);}
.bw-delta.same{color:var(--text3);}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);
  z-index:200;align-items:flex-end;justify-content:center;
}
.modal-overlay.open{display:flex;}
.modal-sheet{
  background:var(--bg2);border:1px solid var(--border2);
  border-radius:20px 20px 0 0;width:100%;max-width:640px;
  padding:20px 20px calc(20px + var(--safe-bot));
  animation:slideUp .3s cubic-bezier(.34,1.2,.64,1);
  max-height:90vh;overflow-y:auto;
}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px;}

/* â”€â”€ PR BADGE â”€â”€ */
.pr-badge{
  display:inline-flex;align-items:center;gap:5px;
  background:#2d1f00;border:1px solid #f39c12;border-radius:20px;
  padding:3px 10px;
  font-family:'DM Mono',monospace;font-size:10px;color:var(--warn);letter-spacing:1px;
}

/* â”€â”€ SECTION DIVIDER â”€â”€ */
.section-label{
  font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;
  text-transform:uppercase;color:var(--text3);
  padding:6px 0 8px;margin-bottom:6px;
  border-bottom:1px solid var(--border);
}

/* â”€â”€ WORKOUT TEMPLATE â”€â”€ */
.template-btn{
  background:var(--bg3);border:1px solid var(--border2);border-radius:8px;
  padding:12px;cursor:pointer;transition:all .2s;display:flex;gap:10px;align-items:center;
  margin-bottom:8px;-webkit-tap-highlight-color:transparent;width:100%;text-align:left;
}
.template-btn:hover,.template-btn:active{border-color:var(--green3);}
.template-icon{font-size:22px;flex-shrink:0;color:var(--accent);display:flex;align-items:center;}
.template-name{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--white);}
.template-sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);margin-top:2px;}

/* â”€â”€ SETTINGS TOGGLE â”€â”€ */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
.toggle-label{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;color:var(--text);}
.toggle-switch{position:relative;width:44px;height:24px;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-thumb{
  position:absolute;inset:0;background:var(--bg3);border:1px solid var(--border2);
  border-radius:12px;cursor:pointer;transition:.25s;
}
.toggle-thumb::before{content:'';position:absolute;width:18px;height:18px;left:2px;top:2px;background:var(--text3);border-radius:50%;transition:.25s;}
input:checked+.toggle-thumb{background:var(--green-dim);border-color:var(--green3);}
input:checked+.toggle-thumb::before{transform:translateX(20px);background:var(--green);}

/* â”€â”€ RESPONSIVE FIX â”€â”€ */
@media(max-width:380px){
  .muscle-grid{grid-template-columns:repeat(3,1fr);}
  .stats-bar{grid-template-columns:repeat(2,1fr);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAMIFICATION â€” XP BAR & LEVEL BADGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.xp-bar-wrap{
  padding:0 0 4px;margin-bottom:0;
}
.xp-top-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.level-badge{
  display:flex;align-items:center;gap:7px;
  background:linear-gradient(135deg,#1d4a2a,#0d2a16);
  border:1px solid var(--green3);border-radius:20px;
  padding:5px 14px 5px 8px;
  box-shadow:0 0 12px rgba(46,204,113,.15);
}
.level-icon{font-size:20px;line-height:1;}
.level-text{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:2.5px;color:var(--accent);}
.xp-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);letter-spacing:1px;}
.xp-track{
  height:10px;border-radius:5px;overflow:hidden;position:relative;
  background:linear-gradient(90deg,#0a1a0d,#0d2218);
  border:1px solid var(--border2);
  box-shadow:inset 0 1px 3px rgba(0,0,0,.5);
}
.xp-fill{
  height:100%;border-radius:5px;
  background:linear-gradient(90deg,#1a7a3f,#2ecc71,#39ff8f);
  transition:width 1.2s cubic-bezier(.4,0,.2,1);
  position:relative;min-width:3px;
  box-shadow:0 0 8px rgba(57,255,143,.5);
}
.xp-fill::after{
  content:'';position:absolute;top:0;right:0;width:40px;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.4));
  animation:xp-shine 2.5s infinite;
}
@keyframes xp-shine{0%,100%{opacity:0;transform:translateX(-10px);}50%{opacity:1;transform:translateX(0);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TODAY'S MISSION PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mission-panel{
  background:linear-gradient(135deg,#0d2218,#0f1c13);
  border:1px solid rgba(46,204,113,.25);border-radius:14px;
  padding:16px;margin-bottom:14px;position:relative;overflow:hidden;
  box-shadow:0 0 20px rgba(46,204,113,.05),inset 0 1px 0 rgba(57,255,143,.08);
}
.mission-panel::before{
  content:'';position:absolute;top:-50px;right:-50px;
  width:150px;height:150px;border-radius:50%;
  background:radial-gradient(circle,rgba(46,204,113,.15),transparent 70%);
  pointer-events:none;
}
.mission-panel::after{
  content:'';position:absolute;bottom:-30px;left:-30px;
  width:100px;height:100px;border-radius:50%;
  background:radial-gradient(circle,rgba(57,255,143,.06),transparent 70%);
  pointer-events:none;
}
.mission-title{
  display:flex;align-items:center;justify-content:space-between;
  font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:3px;
  color:var(--text3);margin-bottom:12px;
}
.mission-title-done{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--text3);}
.mission-items{display:flex;flex-direction:column;gap:8px;}
.mission-item{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:8px;
  background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.04);
  transition:background .2s,border-color .2s;
}
.mission-item.done-item{opacity:.6;}
.mission-check{
  width:22px;height:22px;border-radius:6px;border:1.5px solid var(--border2);
  background:var(--bg);display:flex;align-items:center;justify-content:center;
  font-size:12px;flex-shrink:0;transition:all .3s;
}
.mission-check.done{
  background:var(--green-dim);border-color:var(--green);
  box-shadow:0 0 8px rgba(46,204,113,.3);
}
.mission-text{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:600;letter-spacing:.5px;color:var(--text);flex:1;}
.mission-text.done{color:var(--text3);text-decoration:line-through;}
.mission-xp{
  font-family:'DM Mono',monospace;font-size:9px;color:var(--accent);
  letter-spacing:1px;background:rgba(57,255,143,.1);
  border:1px solid rgba(57,255,143,.2);
  padding:2px 7px;border-radius:4px;flex-shrink:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART INDICATORS (4-up grid)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.indicators-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
.ind-card{
  background:linear-gradient(145deg,var(--panel),var(--panel2));
  border:1px solid var(--border2);border-radius:12px;
  padding:14px 15px;position:relative;overflow:hidden;
  transition:border-color .2s,box-shadow .2s;
}
.ind-card:hover{
  border-color:var(--ind-color,var(--green));
  box-shadow:0 0 16px rgba(0,0,0,.3), 0 0 0 1px rgba(var(--ind-color,46,204,113),.1);
}
.ind-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--ind-color,var(--green)),transparent);
  opacity:.3;
}
.ind-card::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:3px;
  background:var(--ind-color,var(--green));
  box-shadow:0 0 8px var(--ind-color,var(--green));opacity:.8;
}
.ind-icon{font-size:22px;margin-bottom:7px;line-height:1;}
.ind-value{font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--white);line-height:1;letter-spacing:1px;}
.ind-value .ind-unit{font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);margin-left:3px;}
.ind-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-top:3px;}
.ind-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);margin-top:5px;}
.ind-sub.good{color:var(--green);}
.ind-sub.warn{color:var(--warn);}
.ind-sub.bad{color:var(--danger);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COACH PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.coach-panel{
  background:var(--panel);border:1px solid var(--border2);border-radius:14px;
  margin-bottom:14px;overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.coach-header{
  padding:14px 16px;
  background:linear-gradient(90deg,#0a1e10,#0d2218,var(--panel2));
  border-bottom:1px solid rgba(46,204,113,.1);
  display:flex;align-items:center;gap:12px;
}
.coach-avatar{
  width:38px;height:38px;border-radius:10px;
  background:linear-gradient(135deg,#0d3a1f,#1a7a3f);
  border:1px solid rgba(57,255,143,.3);
  display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;
  box-shadow:0 0 12px rgba(46,204,113,.2);
}
.coach-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;color:var(--accent);}
.coach-status{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;margin-top:2px;}
.coach-body{padding:14px 16px;display:flex;flex-direction:column;gap:10px;}
.coach-insight{
  background:rgba(0,0,0,.25);border-left:3px solid var(--green3);border-radius:0 10px 10px 0;
  padding:11px 13px;display:flex;gap:11px;align-items:flex-start;
  transition:border-left-color .2s;
}
.coach-insight.warn{border-left-color:var(--warn);background:rgba(243,156,18,.04);}
.coach-insight.danger{border-left-color:var(--danger);background:rgba(231,76,60,.04);}
.coach-insight.pr{border-left-color:#f39c12;background:rgba(243,156,18,.04);}
.ci-icon{font-size:20px;flex-shrink:0;margin-top:1px;}
.ci-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--white);margin-bottom:3px;}
.ci-text{font-size:12px;color:var(--text2);line-height:1.6;}
.ci-action{
  display:inline-block;margin-top:7px;
  font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--accent);border-bottom:1px dashed rgba(57,255,143,.4);cursor:pointer;
  transition:color .2s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACHIEVEMENT UNLOCK POPUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.achievement-popup{
  position:fixed;top:calc(80px + var(--safe-top));left:50%;
  transform:translateX(-50%) translateY(-140px) scale(.7);
  background:linear-gradient(145deg,#1e3d1a,#0f2210,#1a3820);
  border:1px solid rgba(243,156,18,.7);border-radius:18px;
  padding:16px 24px;z-index:9999;
  box-shadow:0 0 60px rgba(243,156,18,.4), 0 0 20px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.08);
  transition:transform .6s cubic-bezier(.34,1.56,.64,1),opacity .4s;
  opacity:0;pointer-events:none;text-align:center;min-width:240px;
}
.achievement-popup.show{transform:translateX(-50%) translateY(0) scale(1);opacity:1;}
@keyframes achPop{0%{transform:translateX(-50%) translateY(0) scale(1);}
  10%{transform:translateX(-50%) translateY(0) scale(1.04);}
  20%{transform:translateX(-50%) translateY(0) scale(1);}
}
.achievement-popup.show{animation:achPop .6s .1s ease forwards;}
.ach-emoji{font-size:40px;line-height:1;margin-bottom:8px;display:block;filter:drop-shadow(0 0 8px rgba(243,156,18,.6));}
.ach-title{font-family:'Bebas Neue',sans-serif;font-size:10px;letter-spacing:4px;color:#f39c12;margin-bottom:4px;opacity:.8;}
.ach-name{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;letter-spacing:1px;color:var(--white);}
.ach-desc{font-family:'DM Mono',monospace;font-size:9px;color:var(--text2);margin-top:4px;line-height:1.5;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLOAD STRATEGY ROW (inside coach)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overload-row{
  display:flex;align-items:center;gap:0;border-radius:8px;overflow:hidden;
  border:1px solid var(--border2);
}
.overload-step{
  flex:1;padding:8px 4px;text-align:center;background:var(--bg3);
  border-right:1px solid var(--border);position:relative;
}
.overload-step:last-child{border-right:none;}
.overload-step.active-step{background:var(--green-dim);}
.overload-step.active-step::before{
  content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--green);
}
.os-val{font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--white);line-height:1;}
.os-val.green{color:var(--accent);}
.os-label{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:1px;margin-top:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEEKLY BALANCE BARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.balance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:14px;}
.balance-item{text-align:center;}
.balance-bar-wrap{height:60px;background:var(--bg3);border-radius:4px;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-end;position:relative;}
.balance-bar-fill{border-radius:4px 4px 0 0;transition:height .8s cubic-bezier(.4,0,.2,1);min-height:3px;}
.balance-name{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:1px;margin-top:5px;text-transform:uppercase;}
.balance-sessions{font-family:'Bebas Neue',sans-serif;font-size:14px;color:var(--text2);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAK FLAME ANIMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes flamePulse{
  0%,100%{transform:scale(1) rotate(-2deg);}
  50%{transform:scale(1.15) rotate(2deg);}
}
.streak-flame{display:inline-block;animation:flamePulse 1.5s ease-in-out infinite;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SET ROW ENHANCEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.set-vol-display{
  font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);
  text-align:center;margin-top:2px;transition:color .2s;
}
.set-vol-display.personal-best{color:var(--warn);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOG WORKOUT BUTTON PULSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes readyPulse{
  0%,100%{box-shadow:0 4px 20px rgba(46,204,113,.3);}
  50%{box-shadow:0 4px 40px rgba(57,255,143,.6), 0 0 80px rgba(46,204,113,.25);}
}
.btn-primary.ready{animation:readyPulse 2.5s ease-in-out infinite;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXTRA POLISH â€” GLOWS, TRANSITIONS, MICRO-FX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Smooth panel entrance */
@keyframes fadeSlideUp{
  from{opacity:0;transform:translateY(12px);}
  to{opacity:1;transform:translateY(0);}
}
.mission-panel{animation:fadeSlideUp .4s ease both;}
.coach-panel{animation:fadeSlideUp .4s .1s ease both;}
.indicators-grid{animation:fadeSlideUp .3s ease both;}

/* XP level-up flash */
@keyframes levelFlash{
  0%,100%{background:linear-gradient(135deg,#1d4a2a,#0d2a16);}
  50%{background:linear-gradient(135deg,#2a6a3a,#1a4a28);box-shadow:0 0 24px rgba(57,255,143,.5);}
}
.level-badge.leveled-up{animation:levelFlash .6s ease 3;}

/* Mission item complete flash */
@keyframes missionComplete{
  0%{background:rgba(46,204,113,.15);border-color:rgba(46,204,113,.4);}
  100%{background:rgba(0,0,0,.2);border-color:rgba(255,255,255,.04);}
}
.mission-item.just-done{animation:missionComplete .8s ease forwards;}

/* Indicator card number pop */
@keyframes numPop{
  0%{transform:scale(1);}50%{transform:scale(1.12);}100%{transform:scale(1);}
}
.ind-value.updated{animation:numPop .3s ease;}

/* Coach insight slide in */
@keyframes insightIn{
  from{opacity:0;transform:translateX(-8px);}
  to{opacity:1;transform:translateX(0);}
}
.coach-insight{animation:insightIn .35s ease both;}
.coach-insight:nth-child(2){animation-delay:.06s;}
.coach-insight:nth-child(3){animation-delay:.12s;}
.coach-insight:nth-child(4){animation-delay:.18s;}

/* Set row shimmer on add */
@keyframes setRowIn{
  from{opacity:0;transform:translateX(-6px);}
  to{opacity:1;transform:translateX(0);}
}
.set-row{animation:setRowIn .25s ease both;}

/* Active overload step pulse */
@keyframes stepPulse{
  0%,100%{box-shadow:inset 0 0 0 rgba(46,204,113,0);}
  50%{box-shadow:inset 0 0 12px rgba(46,204,113,.15);}
}
.overload-step.active-step{animation:stepPulse 2s ease-in-out infinite;}

/* Streak flame bigger on high streak */
.streak-high .streak-flame{font-size:26px;}

/* Header glow pulse on high XP */
@keyframes headerGlow{
  0%,100%{box-shadow:0 2px 20px rgba(46,204,113,.05);}
  50%{box-shadow:0 2px 30px rgba(46,204,113,.12);}
}
header{animation:headerGlow 4s ease-in-out infinite;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MUSCLE DETAIL OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.muscle-overlay{
  position:fixed;inset:0;z-index:200;
  background:var(--bg);
  display:flex;flex-direction:column;
  transform:translateY(100%);
  transition:transform .38s cubic-bezier(.4,0,.2,1);
  overflow:hidden;
  padding-top:var(--safe-top);
  padding-bottom:var(--safe-bot);
}
.muscle-overlay.open{transform:translateY(0);}

.mo-header{
  display:flex;align-items:center;gap:14px;
  padding:20px 20px 16px;
  background:linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);
  border-bottom:1px solid var(--border2);
  flex-shrink:0;
}
.mo-muscle-icon{
  width:52px;height:52px;border-radius:14px;
  background:linear-gradient(135deg,#0d2a16,#1a4a28);
  border:1.5px solid rgba(57,255,143,.3);
  display:flex;align-items:center;justify-content:center;
  font-size:26px;flex-shrink:0;
  box-shadow:0 0 20px rgba(46,204,113,.2);
}
.mo-muscle-name{
  font-family:'Bebas Neue',sans-serif;
  font-size:28px;letter-spacing:3px;color:var(--white);line-height:1;
}
.mo-muscle-sub{
  font-family:'DM Mono',monospace;font-size:10px;
  color:var(--text3);letter-spacing:1px;margin-top:3px;
}
.mo-close-btn{
  margin-left:auto;background:var(--bg3);border:1px solid var(--border2);
  color:var(--text2);width:36px;height:36px;border-radius:10px;
  font-size:16px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .2s;flex-shrink:0;
}
.mo-close-btn:hover{background:var(--danger);color:#fff;border-color:var(--danger);}

.mo-stats-strip{
  display:grid;grid-template-columns:repeat(4,1fr);
  border-bottom:1px solid var(--border);flex-shrink:0;
  background:var(--panel);
}
.mo-stat{
  padding:12px 4px;text-align:center;
  border-right:1px solid var(--border);
}
.mo-stat:last-child{border-right:none;}
.mo-stat-val{
  font-family:'Bebas Neue',sans-serif;font-size:20px;
  color:var(--accent);line-height:1;
}
.mo-stat-lbl{
  font-family:'DM Mono',monospace;font-size:8px;
  color:var(--text3);letter-spacing:1px;margin-top:3px;
  text-transform:uppercase;
}

.mo-tabs{
  display:flex;border-bottom:1px solid var(--border);
  background:var(--bg2);flex-shrink:0;
}
.mo-tab{
  flex:1;padding:12px 4px;
  font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;
  letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);
  background:none;border:none;cursor:pointer;
  border-bottom:2px solid transparent;transition:all .2s;
}
.mo-tab.active{color:var(--green);border-bottom-color:var(--green);}

.mo-content{
  flex:1;overflow-y:auto;padding:16px;
  -webkit-overflow-scrolling:touch;
}

.mo-history-list{display:flex;flex-direction:column;gap:12px;}
.mo-history-exercise{
  background:var(--panel);border:1px solid var(--border2);border-radius:12px;
  overflow:hidden;
}
.mo-ex-title-bar{
  padding:12px 14px;display:flex;align-items:center;justify-content:space-between;
  background:linear-gradient(90deg,var(--panel2),var(--panel));
  border-bottom:1px solid var(--border);
}
.mo-ex-title-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;letter-spacing:1px;color:var(--white);}
.mo-ex-title-count{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;}
.mo-session-card{padding:12px 14px;border-bottom:1px solid var(--border);}
.mo-session-card:last-child{border-bottom:none;}
.mo-session-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.mo-session-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);}
.mo-session-vol{font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--green);}
.mo-session-pr{
  background:linear-gradient(90deg,#7a4e00,#b37000);
  color:#f8d06b;border-radius:4px;padding:2px 7px;
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;
}
.mo-sets-grid{
  display:grid;grid-template-columns:30px 1fr 1fr 1fr;
  gap:4px;font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);
}
.mo-sets-grid-hdr{
  display:grid;grid-template-columns:30px 1fr 1fr 1fr;
  gap:4px;font-family:'DM Mono',monospace;font-size:8px;
  color:var(--text3);letter-spacing:1px;margin-bottom:4px;
}
.mo-set-num{color:var(--text3);}
.mo-set-val{text-align:center;}
.mo-show-more{
  width:100%;padding:10px;background:none;border:none;
  font-family:'DM Mono',monospace;font-size:10px;
  color:var(--green);letter-spacing:1px;cursor:pointer;
  border-top:1px solid var(--border);text-align:center;
}
.mo-empty{
  text-align:center;padding:48px 20px;
  font-family:'Barlow Condensed',sans-serif;font-size:15px;
  letter-spacing:2px;color:var(--text3);
}
.mo-empty-icon{font-size:48px;margin-bottom:12px;opacity:.5;}

.mo-tips-list{display:flex;flex-direction:column;gap:10px;}

.mo-exercises-list{display:flex;flex-direction:column;gap:8px;}
.mo-ex-item{
  background:var(--panel);border:1px solid var(--border2);border-radius:10px;
  padding:12px 14px;display:flex;justify-content:space-between;align-items:center;
}
.mo-ex-name{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;color:var(--white);}
.mo-ex-stats{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);}
.mo-ex-pr{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);}

.mo-cta{
  padding:16px;border-top:1px solid var(--border);
  background:var(--bg);flex-shrink:0;
  padding-bottom:calc(16px + var(--safe-bot));
}
.mo-cta-btn{
  width:100%;padding:16px;border-radius:12px;border:none;
  background:linear-gradient(90deg,var(--green3),var(--green2),var(--green));
  color:#080c09;font-family:'Bebas Neue',sans-serif;font-size:20px;
  letter-spacing:3px;cursor:pointer;
  box-shadow:0 0 24px rgba(46,204,113,.35);
  transition:all .2s;
}
.mo-cta-btn:active{transform:scale(.97);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER PROFILE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.profile-panel .panel-header{
  background:linear-gradient(90deg,#091a0d,#0d2218,var(--panel2));
}
.profile-avatar-row{
  display:flex;align-items:center;gap:14px;
  padding:4px 0 16px;border-bottom:1px solid var(--border);margin-bottom:16px;
}
.profile-avatar{
  width:56px;height:56px;border-radius:16px;
  background:linear-gradient(135deg,#0d3a1f,#1a5a30);
  border:2px solid rgba(57,255,143,.3);
  display:flex;align-items:center;justify-content:center;
  font-size:28px;flex-shrink:0;
  box-shadow:0 0 20px rgba(46,204,113,.15);
}
.profile-name{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--white);}
.profile-xp-mini{font-family:'DM Mono',monospace;font-size:10px;color:var(--green);margin-top:3px;}
.profile-level-badge{
  font-family:'Bebas Neue',sans-serif;
  background:linear-gradient(90deg,#0d3a1f,#1a5a30);
  border:1px solid rgba(57,255,143,.3);
  color:var(--accent);letter-spacing:2px;font-size:11px;
}

.profile-fields{display:flex;flex-direction:column;gap:12px;}
.profile-field{display:flex;flex-direction:column;gap:4px;}
.pf-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);}
.pf-input{
  background:var(--bg2);border:1px solid var(--border2);
  border-radius:8px;color:var(--white);padding:10px 12px;
  font-family:'Barlow',sans-serif;font-size:14px;width:100%;
  transition:border-color .2s;
}
.pf-input:focus{border-color:var(--green);outline:none;}
.pf-hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--accent);margin-top:2px;min-height:14px;}

.profile-computed{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;
  margin-top:16px;padding-top:16px;border-top:1px solid var(--border);
}
.pc-item{
  background:var(--bg2);border:1px solid var(--border2);border-radius:10px;
  padding:12px 8px;text-align:center;
}
.pc-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);text-transform:uppercase;display:block;margin-bottom:4px;}
.pc-val{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BODY COMPOSITION FIELDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bcomp-row{
  display:flex;align-items:center;gap:10px;
  padding:8px 0;border-bottom:1px solid var(--border);
}
.bcomp-row:last-of-type{border-bottom:none;margin-bottom:8px;}
.bcomp-field-label{
  font-family:'DM Mono',monospace;font-size:10px;
  color:var(--text2);letter-spacing:.5px;
  flex:0 0 110px;
}
.bcomp-inputs{display:flex;gap:6px;flex:1;align-items:center;}
.bcomp-inputs input{flex:1;min-width:0;}
.bcomp-inputs select{flex:0 0 60px;}
.bcomp-unit-label{
  font-family:'DM Mono',monospace;font-size:12px;
  color:var(--text3);flex:0 0 24px;text-align:center;
}
.bcomp-chart-tabs{
  display:flex;border-top:1px solid var(--border);
  border-bottom:1px solid var(--border);background:var(--bg2);
}
.bcomp-tab{
  flex:1;padding:10px 4px;background:none;border:none;
  font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;color:var(--text3);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .2s;
}
.bcomp-tab.active{color:var(--green);border-bottom-color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BODY COMPOSITION SUMMARY CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.comp-cards{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;
}
.comp-card{
  background:var(--bg2);border:1px solid var(--border2);border-radius:10px;
  padding:10px 8px;text-align:center;
}
.comp-card.accent{border-color:rgba(243,156,18,.3);}
.comp-card.green{border-color:rgba(46,204,113,.3);}
.comp-card-val{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--white);line-height:1;}
.comp-card.accent .comp-card-val{color:#f39c12;}
.comp-card.green .comp-card-val{color:var(--accent);}
.comp-card-lbl{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:1px;margin-top:4px;text-transform:uppercase;}
.comp-card-trend{font-family:'DM Mono',monospace;font-size:9px;min-height:12px;margin-top:2px;}
.bw-history-inner{max-height:300px;overflow-y:auto;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BODY MAP â€” tap ripple & pulse
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.body-zone{cursor:pointer;transition:opacity .15s,fill .2s;}
.body-zone:hover{opacity:.8;}
@keyframes zonePop{
  0%{transform:scale(1);}
  40%{transform:scale(1.08);}
  100%{transform:scale(1);}
}
.body-zone.zone-selected{
  filter:drop-shadow(0 0 8px var(--accent));
  animation:zonePop .25s ease;
}
/* Body map wrapper hint label */
.body-tap-hint{
  text-align:center;
  font-family:'DM Mono',monospace;font-size:9px;
  color:var(--text3);letter-spacing:2px;
  text-transform:uppercase;margin-top:6px;
  animation:fadeSlideUp .4s ease both;
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVENESS ENHANCEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 420px) {
  .app-shell{padding:0 12px;}
  .indicators-grid{grid-template-columns:repeat(2,1fr);}
  .ind-value{font-size:26px;}
  .logo-text{font-size:26px;}
  .stat-grid{grid-template-columns:repeat(2,1fr);}
  .mo-stats-strip{grid-template-columns:repeat(2,1fr);}
  .mo-stat:nth-child(2){border-right:none;}
  .mo-stat:nth-child(3){border-top:1px solid var(--border);}
  .mo-stat:nth-child(4){border-top:1px solid var(--border);border-right:none;}
  .profile-computed{grid-template-columns:repeat(3,1fr);}
  .comp-cards{grid-template-columns:repeat(3,1fr);}
  .bcomp-field-label{flex:0 0 90px;font-size:9px;}
}
@media (min-width: 600px) {
  .profile-fields{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .bcomp-row{gap:14px;}
}
/* Improve tap targets on mobile */
.bnav-btn{min-height:52px;padding:8px 4px 10px;}
select, input[type="number"], input[type="text"], input[type="date"]{
  font-size:16px; /* prevents iOS zoom */
}
.btn{min-height:44px;}
.set-reps, .set-weight{min-height:44px;}
.btn-icon{min-height:44px;min-width:44px;}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENTRANCE ANIMATIONS FOR OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes overlayFadeIn{
  from{opacity:0;transform:translateY(20px);}
  to{opacity:1;transform:translateY(0);}
}
.muscle-overlay.open .mo-header{animation:overlayFadeIn .3s ease both;}
.muscle-overlay.open .mo-stats-strip{animation:overlayFadeIn .3s .05s ease both;}
.muscle-overlay.open .mo-tabs{animation:overlayFadeIn .3s .1s ease both;}
.muscle-overlay.open .mo-content{animation:overlayFadeIn .3s .15s ease both;}
.muscle-overlay.open .mo-cta{animation:overlayFadeIn .3s .2s ease both;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME SYSTEM â€” data-theme on <body>
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* EMBER â€” warm volcanic dark */
body[data-theme="ember"] {
  --bg:#0e0a08; --bg2:#150f0b; --bg3:#1c1410;
  --panel:#1a1209; --panel2:#221810;
  --border:#2e1e14; --border2:#3d2a1a;
  --green:#ff6b35; --green2:#e85d2a; --green3:#a33d1a;
  --green-dim:#3d1e0e; --green-glow:#ff6b3533;
  --accent:#ff9f5a; --text:#e8cbb8; --text2:#9a7060; --text3:#5a3a2a;
  --danger:#e74c3c; --warn:#f39c12; --white:#f5e8e0;
}
body[data-theme="ember"] body::before,
body[data-theme="ember"]::before {
  background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
}

/* FROST â€” icy blue monochrome */
body[data-theme="frost"] {
  --bg:#07090e; --bg2:#0b0f18; --bg3:#0f1520;
  --panel:#111825; --panel2:#16202e;
  --border:#1a2535; --border2:#243348;
  --green:#4fc3f7; --green2:#039be5; --green3:#0277bd;
  --green-dim:#0a2035; --green-glow:#4fc3f733;
  --accent:#81d4fa; --text:#b8d4e8; --text2:#5a8aaa; --text3:#2a4a6a;
  --danger:#ef5350; --warn:#ffa726; --white:#e0f0ff;
}

/* NEON â€” cyberpunk purple/magenta */
body[data-theme="neon"] {
  --bg:#08050e; --bg2:#0e0818; --bg3:#130c1f;
  --panel:#160e24; --panel2:#1c1230;
  --border:#251840; --border2:#32204e;
  --green:#b447ff; --green2:#9333ea; --green3:#6d28d9;
  --green-dim:#2a0f4a; --green-glow:#b447ff33;
  --accent:#e879f9; --text:#d4b8e8; --text2:#8a5aaa; --text3:#4a2a6a;
  --danger:#f43f5e; --warn:#fbbf24; --white:#f0e0ff;
}

/* FORGE (default) â€” already defined in :root */
/* MIDNIGHT â€” pure obsidian monochrome */
body[data-theme="midnight"] {
  --bg:#000000; --bg2:#080808; --bg3:#0f0f0f;
  --panel:#111111; --panel2:#161616;
  --border:#1f1f1f; --border2:#282828;
  --green:#e8e8e8; --green2:#c0c0c0; --green3:#888888;
  --green-dim:#1a1a1a; --green-glow:#ffffff22;
  --accent:#ffffff; --text:#d0d0d0; --text2:#707070; --text3:#404040;
  --danger:#ff4444; --warn:#ffaa00; --white:#ffffff;
}

/* SOLAR â€” warm golden sand light mode */
body[data-theme="solar"] {
  --bg:#faf6f0; --bg2:#f2ece2; --bg3:#ede4d5;
  --panel:#ffffff; --panel2:#f7f2ea;
  --border:#e0d5c5; --border2:#c8bfae;
  --green:#d4820a; --green2:#b56b08; --green3:#8a5005;
  --green-dim:#fdedc8; --green-glow:#d4820a22;
  --accent:#c07000; --text:#2a1f10; --text2:#6a5040; --text3:#9a8878;
  --danger:#c0392b; --warn:#e67e22; --white:#1a1008;
}
body[data-theme="solar"] body::before,
body[data-theme="solar"]::before { opacity:.15; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOLAR THEME â€” COMPONENT OVERRIDES
   (sections that use hardcoded dark colors)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* TODAY'S MISSION PANEL */
body[data-theme="solar"] .mission-panel {
  background: linear-gradient(135deg,#fff8e8,#fdf0cc);
  border-color: rgba(192,112,0,.3);
  box-shadow: 0 0 20px rgba(212,130,10,.08), inset 0 1px 0 rgba(255,200,0,.15);
}
body[data-theme="solar"] .mission-panel::before {
  background: radial-gradient(circle,rgba(212,130,10,.12),transparent 70%);
}
body[data-theme="solar"] .mission-panel::after {
  background: radial-gradient(circle,rgba(212,130,10,.06),transparent 70%);
}
body[data-theme="solar"] .mission-item {
  background: rgba(192,112,0,.06);
  border-color: rgba(192,112,0,.15);
}
body[data-theme="solar"] .mission-check {
  background: #fff8e8;
  border-color: var(--border2);
}
body[data-theme="solar"] .mission-check.done {
  background: var(--green-dim);
  border-color: var(--green);
  box-shadow: 0 0 8px rgba(212,130,10,.25);
}
body[data-theme="solar"] .mission-xp {
  background: rgba(192,112,0,.1);
  border-color: rgba(192,112,0,.25);
}

/* COACH PANEL */
body[data-theme="solar"] .coach-header {
  background: linear-gradient(90deg,#fdf0d0,#fae8b8,var(--panel2));
  border-bottom-color: rgba(192,112,0,.15);
}
body[data-theme="solar"] .coach-avatar {
  background: linear-gradient(135deg,#fdeaa0,#f5c842);
  border-color: rgba(192,112,0,.4);
  box-shadow: 0 0 12px rgba(212,130,10,.2);
}
body[data-theme="solar"] .coach-insight {
  background: rgba(192,112,0,.05);
  border-left-color: var(--green3);
}

/* BODY MAP SVG â€” zones & skeleton shapes */
body[data-theme="solar"] .body-zone {
  fill: #e8d5a0;
  stroke: #c8aa60;
}
body[data-theme="solar"] .body-zone:hover {
  fill: #d4820a;
  filter: drop-shadow(0 0 5px rgba(212,130,10,.5));
}
body[data-theme="solar"] .body-zone.zone-selected {
  fill: #c07000;
  filter: drop-shadow(0 0 8px rgba(192,112,0,.7));
}
body[data-theme="solar"] .body-label {
  fill: #9a8060;
}
/* SVG skeleton fill shapes (head, neck, torso outlines) */
body[data-theme="solar"] .body-svg ellipse,
body[data-theme="solar"] .body-svg rect,
body[data-theme="solar"] .body-svg path:not(.body-zone) {
  fill: #ede0c0 !important;
  stroke: #c8aa60 !important;
}
/* FRONT/BACK toggle buttons */
body[data-theme="solar"] .body-view-btn {
  background: var(--bg3);
  border-color: var(--border2);
  color: var(--text2);
}
body[data-theme="solar"] .body-view-btn.active {
  background: var(--green-dim);
  border-color: var(--green3);
  color: var(--accent);
}

/* OVERLOAD STRATEGY STEPS */
body[data-theme="solar"] .overload-step { background: var(--bg3); }
body[data-theme="solar"] .overload-step.active-step { background: var(--green-dim); }

/* PANEL INNER DARK BACKGROUNDS */
body[data-theme="solar"] .coach-insight.warn { background: rgba(230,126,34,.06); }
body[data-theme="solar"] .coach-insight.danger { background: rgba(192,57,43,.06); }
body[data-theme="solar"] .coach-insight.pr { background: rgba(230,126,34,.06); }

/* STEP TRACKER PANEL */
body[data-theme="solar"] .steps-panel {
  background: linear-gradient(135deg,#fff8e8,#fdf0cc);
  border-color: rgba(192,112,0,.25);
}
body[data-theme="solar"] .steps-panel::before {
  background: radial-gradient(circle,rgba(212,130,10,.1),transparent 70%);
}
body[data-theme="solar"] .steps-bar-wrap {
  background: rgba(192,112,0,.12);
  border-color: rgba(192,112,0,.2);
}
body[data-theme="solar"] .steps-bar-fill {
  box-shadow: 0 0 8px rgba(212,130,10,.4);
}
body[data-theme="solar"] .steps-input-row input {
  background: #fff8e8;
  border-color: var(--border2);
  color: var(--text);
}
body[data-theme="solar"] .steps-input-row input:focus {
  border-color: var(--green3);
}

/* XP BAR & LEVEL BADGE */
body[data-theme="solar"] .level-badge {
  background: linear-gradient(135deg,#fdedc8,#f5d98a);
  border-color: var(--green3);
  box-shadow: 0 0 12px rgba(212,130,10,.2);
}
body[data-theme="solar"] .xp-track {
  background: linear-gradient(90deg,#f0e0b0,#edd9a0);
  border-color: var(--border2);
  box-shadow: inset 0 1px 3px rgba(0,0,0,.1);
}
body[data-theme="solar"] .xp-fill {
  background: linear-gradient(90deg,#b56b08,#d4820a,#f0a020) !important;
  box-shadow: 0 0 8px rgba(212,130,10,.5);
}

/* â”€â”€ THEME PICKER UI â”€â”€ */
.theme-picker-section { margin-bottom:16px; }
.theme-picker-label {
  font-family:'DM Mono',monospace; font-size:9px; letter-spacing:2px;
  text-transform:uppercase; color:var(--text3); margin-bottom:10px; display:block;
}
.theme-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
}
.theme-swatch {
  border-radius:10px; padding:10px 8px; cursor:pointer;
  border:2px solid transparent; transition:all .2s;
  display:flex; flex-direction:column; align-items:center; gap:5px;
  -webkit-tap-highlight-color:transparent; position:relative; overflow:hidden;
}
.theme-swatch.active { border-color:var(--accent); }
.theme-swatch::before {
  content:''; position:absolute; inset:0; opacity:.07;
  background:linear-gradient(135deg,#fff,transparent);
}
.theme-swatch-dots {
  display:flex; gap:3px; margin-bottom:2px;
}
.theme-dot { width:10px; height:10px; border-radius:50%; }
.theme-swatch-name {
  font-family:'Barlow Condensed',sans-serif; font-size:11px;
  font-weight:700; letter-spacing:1.5px; text-transform:uppercase;
  color:var(--white);
}
.theme-swatch-check {
  position:absolute; top:5px; right:5px; font-size:10px;
  opacity:0; transition:opacity .2s;
}
.theme-swatch.active .theme-swatch-check { opacity:1; }

/* Accent color row */
.accent-row {
  display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;
}
.accent-dot-btn {
  width:28px; height:28px; border-radius:50%; border:2px solid transparent;
  cursor:pointer; transition:all .2s; -webkit-tap-highlight-color:transparent;
  position:relative;
}
.accent-dot-btn.active::after {
  content:'âœ“'; position:absolute; inset:0; display:flex;
  align-items:center; justify-content:center;
  font-size:12px; font-weight:900; color:#fff;
  text-shadow:0 1px 2px rgba(0,0,0,.8);
}
.accent-dot-btn.active { border-color:#fff; transform:scale(1.15); }

/* â”€â”€ COACH TABS â”€â”€ */
.coach-tabs {
  display:flex; border-bottom:1px solid var(--border);
  background:var(--panel2);
}
.coach-tab {
  flex:1; padding:10px 4px; border:none; background:transparent;
  font-family:'DM Mono',monospace; font-size:9px; letter-spacing:1.5px;
  text-transform:uppercase; color:var(--text3); cursor:pointer;
  border-bottom:2px solid transparent; transition:all .2s;
}
.coach-tab.active { color:var(--accent); border-bottom-color:var(--accent); }

/* â”€â”€ COACH WEEKLY PLAN â”€â”€ */
.week-plan-grid {
  display:grid; grid-template-columns:repeat(7,1fr); gap:4px;
  padding:14px 16px;
}
.week-day {
  display:flex; flex-direction:column; align-items:center; gap:4px;
}
.week-day-label {
  font-family:'DM Mono',monospace; font-size:8px; letter-spacing:1px;
  text-transform:uppercase; color:var(--text3);
}
.week-day-pill {
  width:100%; padding:6px 2px; border-radius:6px; text-align:center;
  background:var(--bg3); border:1px solid var(--border);
  font-size:14px; line-height:1; min-height:34px;
  display:flex; align-items:center; justify-content:center;
  transition:all .2s; cursor:pointer; position:relative;
}
.week-day-pill.rest { opacity:.4; }
.week-day-pill.done { background:var(--green-dim); border-color:var(--green3); }
.week-day-pill.today { border-color:var(--accent); box-shadow:0 0 8px var(--green-glow); }
.week-day-pill.recommended { border-color:var(--warn); }
.week-day-muscle {
  font-family:'DM Mono',monospace; font-size:7px; letter-spacing:.5px;
  text-transform:uppercase; color:var(--text3); text-align:center;
  margin-top:2px; line-height:1.2;
}

/* â”€â”€ COACH NUTRITION CARD â”€â”€ */
.nutrition-grid {
  display:grid; grid-template-columns:repeat(2,1fr); gap:10px;
  padding:14px 16px;
}
.nutr-card {
  background:var(--bg3); border:1px solid var(--border); border-radius:10px;
  padding:12px; text-align:center;
}
.nutr-val {
  font-family:'Bebas Neue',sans-serif; font-size:28px; color:var(--accent);
  line-height:1; letter-spacing:1px;
}
.nutr-unit {
  font-family:'DM Mono',monospace; font-size:9px; color:var(--text3);
  letter-spacing:1px;
}
.nutr-label {
  font-family:'Barlow Condensed',sans-serif; font-size:11px; font-weight:700;
  letter-spacing:1.5px; text-transform:uppercase; color:var(--text2);
  margin-top:4px;
}
.nutr-tip {
  font-family:'DM Mono',monospace; font-size:9px; color:var(--text3);
  margin-top:2px; line-height:1.4;
}
.macro-bar-wrap {
  height:6px; background:var(--bg3); border-radius:3px; overflow:hidden;
  margin:8px 16px 0;
}
.macro-bar-segments {
  display:flex; height:100%; border-radius:3px; overflow:hidden;
}
.macro-seg { height:100%; transition:width .8s cubic-bezier(.4,0,.2,1); }

/* â”€â”€ COACH PR TRACKER â”€â”€ */
.pr-exercise-row {
  padding:12px 16px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.pr-exercise-row:last-child { border-bottom:none; }
.pr-muscle-icon {
  width:36px; height:36px; border-radius:8px;
  background:var(--green-dim); border:1px solid var(--green3);
  display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;
}
.pr-ex-name {
  font-family:'Barlow Condensed',sans-serif; font-size:14px;
  font-weight:700; letter-spacing:1px; color:var(--white);
}
.pr-ex-val {
  font-family:'Bebas Neue',sans-serif; font-size:22px;
  color:var(--accent); line-height:1; margin-left:auto;
}
.pr-ex-date {
  font-family:'DM Mono',monospace; font-size:9px; color:var(--text3); letter-spacing:1px;
}
.pr-progress-bar {
  height:3px; background:var(--bg3); border-radius:2px; overflow:hidden; margin-top:4px;
}
.pr-progress-fill {
  height:100%; background:linear-gradient(90deg,var(--green2),var(--accent));
  border-radius:2px; transition:width .8s cubic-bezier(.4,0,.2,1);
}

/* â”€â”€ COACH INSIGHT CATEGORIES â”€â”€ */
.coach-insight.tip { border-left-color:#4fc3f7; background:rgba(79,195,247,.04); }
.coach-insight.success { border-left-color:var(--green); background:rgba(46,204,113,.04); }

/* â”€â”€ COACH SCORE RING â”€â”€ */
.coach-score-wrap {
  display:flex; align-items:center; gap:16px;
  padding:14px 16px; border-bottom:1px solid var(--border);
}
.score-ring-svg { flex-shrink:0; }
.score-ring-track { fill:none; stroke:var(--bg3); stroke-width:6; }
.score-ring-fill {
  fill:none; stroke-width:6; stroke-linecap:round;
  transition:stroke-dashoffset 1.2s cubic-bezier(.4,0,.2,1);
}
.score-ring-text {
  font-family:'Bebas Neue',sans-serif; font-size:22px;
  fill:var(--accent); text-anchor:middle; dominant-baseline:central;
}
.score-label-text {
  font-family:'DM Mono',monospace; font-size:7px;
  fill:var(--text3); text-anchor:middle; dominant-baseline:central;
  letter-spacing:1px; text-transform:uppercase;
}
.score-details { flex:1; }
.score-title {
  font-family:'Barlow Condensed',sans-serif; font-size:17px; font-weight:700;
  letter-spacing:2px; text-transform:uppercase; color:var(--white); margin-bottom:6px;
}
.score-breakdown {
  display:flex; flex-direction:column; gap:4px;
}
.score-row {
  display:flex; align-items:center; justify-content:space-between;
  font-family:'DM Mono',monospace; font-size:9px; color:var(--text3); letter-spacing:1px;
}
.score-bar-mini { height:3px; flex:1; background:var(--bg3); border-radius:2px; margin:0 8px; overflow:hidden; }
.score-bar-mini-fill { height:100%; border-radius:2px; transition:width .8s ease; }

/* â”€â”€ CHAT BUBBLE (coach response) â”€â”€ */
.coach-chat-wrap { padding:14px 16px; display:flex; flex-direction:column; gap:8px; }
.coach-bubble {
  background:rgba(0,0,0,.25); border-left:3px solid var(--green3);
  border-radius:0 10px 10px 0; padding:11px 13px;
  font-size:12px; color:var(--text2); line-height:1.6;
  animation:overlayFadeIn .3s ease both;
}
.coach-bubble strong { color:var(--accent); font-family:'Barlow Condensed',sans-serif; font-size:13px; letter-spacing:1px; }
.coach-bubble.alert { border-left-color:var(--danger); background:rgba(231,76,60,.05); }
.coach-bubble.warn { border-left-color:var(--warn); background:rgba(243,156,18,.05); }
.coach-bubble.good { border-left-color:var(--green); background:rgba(46,204,113,.05); }

/* â”€â”€ READINESS INDICATORS â”€â”€ */
.readiness-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
  padding:0 16px 14px;
}
.readiness-item {
  background:var(--bg3); border:1px solid var(--border); border-radius:8px;
  padding:10px 8px; text-align:center;
}
.readiness-icon { font-size:20px; margin-bottom:4px; }
.readiness-label {
  font-family:'DM Mono',monospace; font-size:8px; letter-spacing:1px;
  text-transform:uppercase; color:var(--text3);
}
.readiness-val {
  font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:700;
  letter-spacing:1px; margin-top:2px;
}
.readiness-val.good { color:var(--green); }
.readiness-val.warn { color:var(--warn); }
.readiness-val.bad { color:var(--danger); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIPPLE EFFECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ripple-host { position:relative; overflow:hidden; }
.ripple {
  position:absolute; border-radius:50%;
  background:var(--accent); opacity:0.25;
  transform:scale(0); pointer-events:none;
  animation:rippleAnim .55s ease-out forwards;
}
@keyframes rippleAnim {
  to { transform:scale(4); opacity:0; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLE CANVAS (fixed overlay)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#fx-canvas {
  position:fixed; inset:0; pointer-events:none;
  z-index:9998; opacity:1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AMBIENT GLOW â€” theme-reactive header aura
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-shell::before {
  content:''; position:fixed; top:0; left:50%; transform:translateX(-50%);
  width:340px; height:180px; border-radius:50%;
  background:radial-gradient(ellipse, var(--green-glow) 0%, transparent 70%);
  pointer-events:none; z-index:1;
  animation:ambientPulse 4s ease-in-out infinite;
}
@keyframes ambientPulse {
  0%,100% { opacity:.5; transform:translateX(-50%) scaleX(1); }
  50%      { opacity:1;  transform:translateX(-50%) scaleX(1.15); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORKOUT SAVE FLASH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes screenFlash {
  0%   { opacity:0; }
  20%  { opacity:.18; }
  100% { opacity:0; }
}
#save-flash {
  position:fixed; inset:0; background:var(--accent);
  pointer-events:none; z-index:9997; opacity:0;
}
#save-flash.flash { animation:screenFlash .5s ease-out forwards; }

/* PR FLASH â€” gold */
#pr-flash {
  position:fixed; inset:0;
  background:radial-gradient(ellipse at center, #f39c1244 0%, transparent 70%);
  pointer-events:none; z-index:9996; opacity:0;
}
#pr-flash.flash { animation:screenFlash .7s ease-out forwards; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEVEL-UP OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#levelup-overlay {
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  z-index:9999; pointer-events:none; opacity:0;
}
#levelup-overlay.show { animation:levelupShow .8s cubic-bezier(.34,1.56,.64,1) forwards; }
@keyframes levelupShow {
  0%   { opacity:0; transform:scale(.6); }
  60%  { opacity:1; transform:scale(1.05); }
  80%  { opacity:1; transform:scale(1); }
  100% { opacity:0; transform:scale(1); }
}
.levelup-card {
  background:linear-gradient(135deg,var(--panel),var(--bg2));
  border:2px solid var(--accent); border-radius:20px;
  padding:28px 40px; text-align:center;
  box-shadow:0 0 60px var(--green-glow), 0 0 120px var(--green-glow);
}
.levelup-icon { font-size:48px; margin-bottom:8px; }
.levelup-title {
  font-family:'DM Mono',monospace; font-size:10px; letter-spacing:4px;
  text-transform:uppercase; color:var(--accent); margin-bottom:6px;
}
.levelup-name {
  font-family:'Bebas Neue',sans-serif; font-size:36px; letter-spacing:4px;
  color:var(--white); line-height:1;
}
.levelup-sub {
  font-family:'DM Mono',monospace; font-size:10px; letter-spacing:2px;
  color:var(--text3); margin-top:8px; text-transform:uppercase;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME SWITCH WIPE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#theme-wipe {
  position:fixed; inset:0; background:var(--accent);
  pointer-events:none; z-index:10000; opacity:0; transform:scaleX(0);
  transform-origin:left;
}
@keyframes themeWipeIn  { 0%{transform:scaleX(0);opacity:.6} 50%{transform:scaleX(1);opacity:.4} 100%{transform:scaleX(0);opacity:0;transform-origin:right} }
#theme-wipe.wipe { animation:themeWipeIn .45s cubic-bezier(.77,0,.18,1) forwards; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IND-CARD SVG ICON GLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ind-icon svg {
  filter:drop-shadow(0 0 4px var(--ind-color,var(--accent)));
  transition:filter .3s;
}
.ind-card:hover .ind-icon svg {
  filter:drop-shadow(0 0 10px var(--ind-color,var(--accent)));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUND TOGGLE BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sound-toggle {
  position:fixed; bottom:calc(72px + var(--safe-bot)); right:14px;
  width:34px; height:34px; border-radius:50%;
  background:var(--panel); border:1px solid var(--border2);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; z-index:200; transition:all .2s;
  color:var(--text3);
}
.sound-toggle:hover { border-color:var(--accent); color:var(--accent); }
.sound-toggle.muted { opacity:.4; }
.sound-toggle svg { width:15px; height:15px; stroke:currentColor; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BODYWEIGHT MODE TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mode-toggle-row {
  display:flex; gap:0; border-radius:10px; overflow:hidden;
  border:1px solid var(--border2); margin-bottom:14px;
}
.mode-toggle-btn {
  flex:1; padding:10px 8px; border:none; background:var(--bg3);
  color:var(--text3); cursor:pointer; transition:all .2s;
  font-family:'Barlow Condensed',sans-serif; font-size:13px;
  font-weight:700; letter-spacing:1.5px; text-transform:uppercase;
  display:flex; align-items:center; justify-content:center; gap:6px;
}
.mode-toggle-btn.active {
  background:var(--green-dim); color:var(--accent);
  box-shadow:inset 0 0 12px rgba(57,255,143,.1);
}
.mode-toggle-btn:first-child { border-right:1px solid var(--border2); }

/* BW set row â€” reps only, no weight col */
.bw-set-row {
  display:grid; grid-template-columns:36px 1fr 1fr 34px;
  gap:6px; align-items:center; margin-bottom:7px; animation:slideIn .2s ease;
}
.bw-set-row .set-num { font-family:'Bebas Neue',sans-serif; font-size:16px; color:var(--green); text-align:center; }
.bw-set-row input { padding:8px; font-size:15px; text-align:center; }

/* BW exercises quick-pick */
.bw-exercises-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:7px; margin-bottom:12px;
}
.bw-ex-btn {
  background:var(--bg3); border:1px solid var(--border2); border-radius:8px;
  padding:10px 5px; text-align:center; cursor:pointer; transition:all .2s;
  color:var(--text2); font-family:'Barlow Condensed',sans-serif;
  font-size:11px; font-weight:600; letter-spacing:.5px; text-transform:uppercase;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  -webkit-tap-highlight-color:transparent;
}
.bw-ex-btn .bw-ex-icon { font-size:20px; line-height:1; }
.bw-ex-btn.selected { border-color:var(--green); color:var(--accent); background:var(--green-dim); }
.bw-ex-btn:active { transform:scale(.95); }

/* BW stats panel */
.bw-stats-strip {
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:8px; margin-bottom:12px;
}
.bw-stat-card {
  background:var(--bg3); border:1px solid var(--border2); border-radius:8px;
  padding:10px 8px; text-align:center;
}
.bw-stat-val { font-family:'Bebas Neue',sans-serif; font-size:24px; color:var(--accent); line-height:1; }
.bw-stat-lbl { font-family:'DM Mono',monospace; font-size:8px; color:var(--text3); letter-spacing:1px; text-transform:uppercase; margin-top:3px; }

/* BW PR row */
.bw-pr-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:7px 0; border-bottom:1px solid var(--border);
}
.bw-pr-name { font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:700; color:var(--white); }
.bw-pr-val { font-family:'Bebas Neue',sans-serif; font-size:18px; color:var(--green); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP TRACKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.steps-panel {
  background:linear-gradient(135deg,#0a1a0e,#0d2014);
  border:1px solid rgba(46,204,113,.2); border-radius:14px;
  padding:16px; margin-bottom:14px; position:relative; overflow:hidden;
}
.steps-panel::before {
  content:''; position:absolute; top:-40px; right:-40px;
  width:120px; height:120px; border-radius:50%;
  background:radial-gradient(circle,rgba(46,204,113,.12),transparent 70%);
  pointer-events:none;
}
.steps-header {
  display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;
}
.steps-title {
  font-family:'DM Mono',monospace; font-size:9px; letter-spacing:3px;
  text-transform:uppercase; color:var(--text3);
}
.steps-add-btn {
  background:var(--green-dim); border:1px solid var(--green3);
  border-radius:6px; padding:5px 12px; color:var(--green);
  font-family:'Barlow Condensed',sans-serif; font-size:12px;
  font-weight:700; letter-spacing:1.5px; cursor:pointer; transition:all .2s;
}
.steps-add-btn:hover { background:var(--green3); color:var(--bg); }
.steps-big-number {
  font-family:'Bebas Neue',sans-serif; font-size:52px; color:var(--white);
  line-height:1; letter-spacing:2px; margin-bottom:4px;
}
.steps-big-number span { font-size:18px; color:var(--text3); font-family:'DM Mono',monospace; margin-left:4px; }
.steps-goal-label {
  font-family:'DM Mono',monospace; font-size:10px; color:var(--text3); margin-bottom:8px;
}
.steps-bar-wrap {
  height:8px; background:rgba(0,0,0,.4); border-radius:4px;
  overflow:hidden; margin-bottom:10px; border:1px solid var(--border);
}
.steps-bar-fill {
  height:100%; border-radius:4px;
  background:linear-gradient(90deg,var(--green2),var(--accent));
  transition:width 1s cubic-bezier(.4,0,.2,1);
  box-shadow:0 0 8px rgba(57,255,143,.5);
}
.steps-sub-row {
  display:flex; justify-content:space-between; align-items:center;
}
.steps-sub-stat {
  font-family:'DM Mono',monospace; font-size:9px; color:var(--text3);
}
.steps-sub-stat b { color:var(--text2); }
.steps-input-row {
  display:flex; gap:8px; margin-top:10px;
  border-top:1px solid var(--border); padding-top:10px;
}
.steps-input-row input {
  flex:1; min-width:0;
  background:var(--bg3); border:1px solid var(--border2);
  border-radius:8px; padding:9px 12px; color:var(--text);
  font-size:16px; font-family:'Barlow',sans-serif; outline:none;
  transition:border-color .2s;
}
.steps-input-row input:focus { border-color:var(--green3); }
.steps-log-btn {
  background:var(--green-dim); border:1px solid var(--green3);
  border-radius:8px; padding:9px 16px; color:var(--accent);
  font-family:'Bebas Neue',sans-serif; font-size:16px;
  letter-spacing:2px; cursor:pointer; white-space:nowrap; transition:all .2s;
}
.steps-log-btn:hover { background:var(--green3); color:var(--bg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI EDIT MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.edit-mode-bar {
  display:none;
  position:sticky; top:calc(80px + var(--safe-top)); z-index:40;
  background:linear-gradient(135deg,#2d1a00,#1a1000);
  border:1px solid rgba(243,156,18,.4); border-radius:10px;
  padding:10px 14px; margin-bottom:12px;
  flex-direction:row; align-items:center; justify-content:space-between;
  box-shadow:0 4px 20px rgba(243,156,18,.15);
}
.edit-mode-bar.visible { display:flex; }
.edit-mode-label {
  font-family:'Barlow Condensed',sans-serif; font-size:14px; font-weight:700;
  letter-spacing:2px; color:#f39c12;
}
.edit-done-btn {
  background:#f39c12; border:none; border-radius:6px;
  padding:6px 16px; color:#1a0c00;
  font-family:'Bebas Neue',sans-serif; font-size:15px;
  letter-spacing:2px; cursor:pointer;
}
.edit-mode-bar .edit-hint {
  font-family:'DM Mono',monospace; font-size:9px; color:rgba(243,156,18,.7);
  margin-top:2px; letter-spacing:1px;
}

/* Sections wrapper in edit mode */
.log-section {
  position:relative; transition:opacity .2s;
}
.log-section[data-hidden="true"] {
  opacity:.3; pointer-events:none;
}
body.edit-mode .log-section {
  cursor:grab;
}
body.edit-mode .log-section[data-hidden="true"] {
  opacity:.5; pointer-events:auto; cursor:pointer;
}
/* Edit controls overlay */
.section-edit-controls {
  display:none; position:absolute; top:8px; right:8px; z-index:30;
  flex-direction:row; gap:5px;
}
body.edit-mode .section-edit-controls { display:flex; }
.sec-ctrl-btn {
  width:28px; height:28px; border-radius:6px; border:none;
  display:flex; align-items:center; justify-content:center;
  font-size:13px; cursor:pointer; transition:all .15s;
}
.sec-ctrl-hide { background:#2d1f00; border:1px solid #f39c12; color:#f39c12; }
.sec-ctrl-hide:hover { background:#f39c12; color:#000; }
.sec-ctrl-up   { background:var(--panel); border:1px solid var(--border2); color:var(--text2); }
.sec-ctrl-up:hover   { border-color:var(--accent); color:var(--accent); }
.sec-ctrl-down { background:var(--panel); border:1px solid var(--border2); color:var(--text2); }
.sec-ctrl-down:hover { border-color:var(--accent); color:var(--accent); }

/* Edit layout button in header-right area */
.edit-layout-btn {
  background:var(--panel); border:1px solid var(--border2);
  border-radius:8px; padding:5px 10px; color:var(--text3);
  font-family:'DM Mono',monospace; font-size:9px; letter-spacing:1px;
  cursor:pointer; transition:all .2s; text-transform:uppercase;
}
.edit-layout-btn:hover,
.edit-layout-btn.active { border-color:#f39c12; color:#f39c12; }

/* â”€â”€ LANGUAGE TOGGLE BUTTON â”€â”€ */
.lang-toggle-btn {
  background:var(--panel); border:1px solid var(--border2);
  border-radius:8px; padding:5px 10px; color:var(--accent);
  font-family:'DM Mono',monospace; font-size:11px; letter-spacing:2px;
  cursor:pointer; transition:all .2s; font-weight:600;
}
.lang-toggle-btn:hover { border-color:var(--accent); background:var(--green-glow); }
html[dir="rtl"] .lang-toggle-btn { letter-spacing:0; font-family:'Cairo',sans-serif; font-size:12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RTL / ARABIC OVERRIDES
   Applied when <html dir="rtl"> is set
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
html[dir="rtl"] body {
  font-family: 'Cairo', sans-serif;
  text-align: right;
}
html[dir="rtl"] .app-shell { direction: rtl; }

/* Header RTL */
html[dir="rtl"] header > div { flex-direction: row-reverse; }
html[dir="rtl"] .logo { flex-direction: row-reverse; }
html[dir="rtl"] .header-right { flex-direction: row-reverse; }

/* XP bar RTL */
html[dir="rtl"] .xp-top-row { flex-direction: row-reverse; }

/* Bottom nav RTL */
html[dir="rtl"] .bottom-nav { direction: rtl; }

/* Panels RTL */
html[dir="rtl"] .panel-header { flex-direction: row-reverse; }
html[dir="rtl"] .panel-body { text-align: right; }

/* Mode toggle RTL */
html[dir="rtl"] .mode-toggle-row { flex-direction: row-reverse; }

/* Indicators RTL */
html[dir="rtl"] .indicators-grid { direction: rtl; }

/* Form groups RTL */
html[dir="rtl"] .form-group label { text-align: right; display: block; }
html[dir="rtl"] select, html[dir="rtl"] input { text-align: right; direction: rtl; }
html[dir="rtl"] select { background-position: left 12px center; padding-right: 12px; padding-left: 36px; }

/* Step tracker RTL */
html[dir="rtl"] .steps-panel { direction: rtl; }

/* Mission panel RTL */
html[dir="rtl"] .mission-row { flex-direction: row-reverse; }

/* Body map controls RTL */
html[dir="rtl"] .body-map-controls { flex-direction: row-reverse; }

/* Sets table RTL */
html[dir="rtl"] .set-row { flex-direction: row-reverse; }
html[dir="rtl"] .set-num { margin-right: 0; margin-left: 8px; }

/* History RTL */
html[dir="rtl"] .filter-bar { flex-direction: row-reverse; }
html[dir="rtl"] .wk-entry { border-left: none; border-right: 3px solid var(--border2); padding-left: 0; padding-right: 12px; }
html[dir="rtl"] .wk-header { flex-direction: row-reverse; }
html[dir="rtl"] .wk-info { text-align: right; }

/* PRs RTL */
html[dir="rtl"] .pr-item { flex-direction: row-reverse; }

/* Edit mode bar RTL */
html[dir="rtl"] .edit-mode-bar { flex-direction: row-reverse; }
html[dir="rtl"] .section-edit-controls { left: auto; right: auto; flex-direction: row-reverse; }
html[dir="rtl"] .log-section { padding-right: 0; }

/* Timer RTL */
html[dir="rtl"] .timer-widget { flex-direction: row-reverse; }
html[dir="rtl"] .timer-preset-row { flex-direction: row-reverse; }

/* Toggle rows RTL */
html[dir="rtl"] .toggle-row { flex-direction: row-reverse; }

/* Profile RTL */
html[dir="rtl"] .profile-card { text-align: right; }
html[dir="rtl"] .stat-row { flex-direction: row-reverse; }

/* Muscle overlay RTL */
html[dir="rtl"] .mo-header { flex-direction: row-reverse; }
html[dir="rtl"] .mo-tabs { flex-direction: row-reverse; }
html[dir="rtl"] .mo-stats-strip { flex-direction: row-reverse; }

/* Tip cards RTL */
html[dir="rtl"] .tip-card { flex-direction: row-reverse; text-align: right; }

/* Toast RTL */
html[dir="rtl"] .toast { right: auto; left: 50%; }

/* BW workouts RTL */
html[dir="rtl"] .bw-set-row { flex-direction: row-reverse; }
html[dir="rtl"] .bw-stats-strip { flex-direction: row-reverse; }

/* Water tracker RTL */
html[dir="rtl"] .water-cups { flex-direction: row-reverse; }

/* Section edit controls RTL (flipped to left side for RTL) */
html[dir="rtl"] .section-edit-controls {
  right: auto; left: 0;
}

/* Fonts - use Cairo for all text in RTL */
html[dir="rtl"] h1, html[dir="rtl"] h2, html[dir="rtl"] h3,
html[dir="rtl"] .section-label, html[dir="rtl"] .panel-title,
html[dir="rtl"] .ind-label, html[dir="rtl"] .ind-sub,
html[dir="rtl"] .btn, html[dir="rtl"] label,
html[dir="rtl"] .toggle-label, html[dir="rtl"] .tip-title,
html[dir="rtl"] .tip-text, html[dir="rtl"] .level-text,
html[dir="rtl"] .bnav-btn, html[dir="rtl"] select option {
  font-family: 'Cairo', sans-serif;
}
html[dir="rtl"] .logo-word { font-family: 'Bebas Neue', sans-serif; letter-spacing: 3px; }

/* Android / mobile input fix â€” prevent zoom on focus (font-size >= 16px) */
@media (max-width: 767px) {
  input[type="text"], input[type="number"], input[type="email"],
  input[type="tel"], input[type="search"], select, textarea {
    font-size: 16px !important;
  }
  /* Minimum touch target size */
  button, .btn, .bnav-btn, .mode-toggle-btn, .timer-preset-btn,
  .sec-ctrl-btn, .mo-tab, .mo-cta-btn {
    min-height: 44px;
  }
  .sec-ctrl-btn { min-height: 36px; width: 36px; }
  /* Smooth scrolling on Android */
  .panel-body, .mo-content, .view, .history-list {
    -webkit-overflow-scrolling: touch;
  }
}
</style>
</head>
<body>
<div class="app-shell">

  <!-- HEADER -->
  <header style="flex-direction:column;align-items:stretch;gap:10px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="logo">
        <span class="logo-word">FORGE</span>
        <span class="logo-tag" id="header-greeting">// Gym OS</span>
      </div>
      <div class="header-right">
        <button class="lang-toggle-btn" id="lang-toggle-btn" onclick="toggleLanguage()" title="Switch Language / ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©">EN</button>
        <button class="edit-layout-btn" id="edit-layout-btn" onclick="toggleEditMode()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Edit</button>
        <div class="status-pill"><div class="status-dot"></div><span id="session-time">00:00</span></div>
      </div>
    </div>
    <!-- XP BAR -->
    <div class="xp-bar-wrap">
      <div class="xp-top-row">
        <div class="level-badge">
          <span class="level-icon" id="level-icon">ğŸŒ±</span>
          <span class="level-text" id="level-name">ROOKIE</span>
        </div>
        <span class="xp-label" id="xp-label">0 / 100 XP</span>
      </div>
      <div class="xp-track">
        <div class="xp-fill" id="xp-fill" style="width:0%"></div>
      </div>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOG VIEW
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="view-log" class="view active">

    <!-- EDIT MODE BAR -->
    <div class="edit-mode-bar" id="edit-mode-bar">
      <div>
        <div class="edit-mode-label"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> EDIT LAYOUT</div>
        <div class="edit-hint">â†‘â†“ reorder Â· <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> toggle visibility</div>
      </div>
      <button class="edit-done-btn" onclick="exitEditMode()">DONE</button>
    </div>

    <!-- WORKOUT MODE TOGGLE -->
    <div class="mode-toggle-row">
      <button class="mode-toggle-btn active" id="mode-btn-weighted" onclick="setWorkoutMode('weighted')">
        <svg class="mode-icon" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/></svg> Weighted
      </button>
      <button class="mode-toggle-btn" id="mode-btn-bodyweight" onclick="setWorkoutMode('bodyweight')">
        <svg class="mode-icon" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M12 7v6"/><path d="M9 10l-2 4h10l-2-4"/><path d="M10 17l-1 4M14 17l1 4"/></svg> Bodyweight
      </button>
    </div>

    <!-- STEP TRACKER SECTION -->
    <div class="log-section" id="section-steps" data-section="steps">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-steps')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-steps')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-steps')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
      <div class="steps-panel" id="steps-panel"></div>
    </div>

    <!-- REST TIMER -->
    <div class="log-section" id="section-timer" data-section="timer">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-timer')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-timer')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-timer')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    <div class="timer-widget">
      <div>
        <div class="section-label">Rest Timer</div>
        <div class="timer-display" id="timer-display">00:00</div>
      </div>
      <div class="timer-controls">
        <div class="timer-preset-row">
          <button class="timer-preset-btn" onclick="setTimer(60)">1m</button>
          <button class="timer-preset-btn active" onclick="setTimer(90)">90s</button>
          <button class="timer-preset-btn" onclick="setTimer(120)">2m</button>
          <button class="timer-preset-btn" onclick="setTimer(180)">3m</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn btn-ghost btn-sm" onclick="startTimer()">â–¶ Start</button>
          <button class="btn btn-ghost btn-sm" onclick="stopTimer()">â–  Reset</button>
        </div>
      </div>
    </div>

    </div></div><!-- end section-timer -->

    <!-- SMART INDICATORS -->
    <div class="log-section" id="section-indicators" data-section="indicators">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-indicators')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-indicators')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-indicators')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    <div class="indicators-grid">
      <div class="ind-card" style="--ind-color:var(--accent);">
        <div class="ind-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>
        </div>
        <div class="ind-value" id="stat-vol">0<span class="ind-unit">kg</span></div>
        <div class="ind-label">Today's Volume</div>
        <div class="ind-sub" id="stat-vol-delta">Start logging</div>
      </div>
      <div class="ind-card" style="--ind-color:var(--warn);">
        <div class="ind-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--warn)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/>
          </svg>
        </div>
        <div class="ind-value" id="stat-streak">0<span class="ind-unit">d</span></div>
        <div class="ind-label">Day Streak</div>
        <div class="ind-sub" id="stat-streak-delta">Keep going!</div>
      </div>
      <div class="ind-card" style="--ind-color:#c084fc;">
        <div class="ind-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#c084fc" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/>
          </svg>
        </div>
        <div class="ind-value" id="stat-prs">0</div>
        <div class="ind-label">Total PRs</div>
        <div class="ind-sub" id="stat-prs-delta">All time</div>
      </div>
      <div class="ind-card" style="--ind-color:#60a5fa;">
        <div class="ind-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </div>
        <div class="ind-value" id="stat-week">0</div>
        <div class="ind-label">This Week</div>
        <div class="ind-sub" id="stat-week-delta">Sessions</div>
      </div>
    </div>

    </div></div><!-- end section-indicators -->

    <!-- TODAY'S MISSION -->
    <div class="log-section" id="section-mission" data-section="mission">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-mission')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-mission')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-mission')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    <div class="mission-panel" id="mission-panel">
      <div class="mission-title"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> TODAY'S MISSION</div>
      <div class="mission-items" id="mission-items"></div>
    </div>

    </div></div><!-- end section-mission -->

    <!-- TEMPLATES QUICK-START -->
    <div class="log-section" id="section-templates" data-section="templates">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-templates')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-templates')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-templates')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Quick Templates</span>
        <span class="panel-badge">SHORTCUTS</span>
      </div>
      <div class="panel-body" id="templates-body">
        <div id="template-list"></div>
      </div>
    </div>

    </div></div><!-- end section-templates -->

    <!-- MUSCLE SELECT (BODY MAP) -->
    <div class="log-section" id="section-bodymap" data-section="bodymap">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-bodymap')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-bodymap')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-bodymap')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Muscle Group</span>
        <span class="panel-badge" id="selected-muscle-badge">TAP BODY</span>
      </div>
      <div class="panel-body" style="padding:12px 10px;">
        <div style="display:flex;gap:6px;margin-bottom:10px;">
          <button id="view-front-btn" class="body-view-btn active" onclick="setBodyView('front')">Front</button>
          <button id="view-back-btn"  class="body-view-btn"        onclick="setBodyView('back')">Back</button>
        </div>
        <div id="body-selected-label" style="text-align:center;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;color:var(--accent);min-height:26px;margin-bottom:6px;"></div>
        <div class="body-map-container">
          <!-- FRONT -->
          <svg id="body-front" class="body-svg" viewBox="0 0 200 430" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="100" cy="28" rx="22" ry="26" fill="#1a2e1c" stroke="#253527" stroke-width="1.5"/>
            <rect x="91" y="52" width="18" height="14" rx="4" fill="#1a2e1c" stroke="#253527" stroke-width="1"/>
            <path d="M62 66 Q55 70 53 90 L50 160 Q50 170 60 172 L140 172 Q150 170 150 160 L147 90 Q145 70 138 66 Z" fill="#162018" stroke="#253527" stroke-width="1"/>
            <!-- Chest -->
            <path class="body-zone" data-muscle="Chest" d="M68 68 Q64 72 63 88 L63 120 Q75 128 100 130 Q125 128 137 120 L137 88 Q136 72 132 68 Q118 62 100 61 Q82 62 68 68 Z"/>
            <!-- Shoulders L/R -->
            <path class="body-zone" data-muscle="Shoulders" d="M55 68 Q44 72 42 86 Q40 100 48 108 Q55 115 63 110 L63 88 Q62 74 68 68 Z"/>
            <path class="body-zone" data-muscle="Shoulders" d="M145 68 Q156 72 158 86 Q160 100 152 108 Q145 115 137 110 L137 88 Q138 74 132 68 Z"/>
            <!-- Biceps L/R -->
            <path class="body-zone" data-muscle="Biceps" d="M42 108 Q36 114 35 130 Q34 146 40 152 Q47 157 55 152 Q62 147 63 132 L63 110 Q55 115 48 108 Z"/>
            <path class="body-zone" data-muscle="Biceps" d="M158 108 Q164 114 165 130 Q166 146 160 152 Q153 157 145 152 Q138 147 137 132 L137 110 Q145 115 152 108 Z"/>
            <!-- Triceps / forearm front L/R -->
            <path class="body-zone" data-muscle="Triceps" d="M40 152 Q34 158 33 172 Q32 186 38 196 Q44 202 51 198 Q58 194 59 182 Q60 168 55 158 Q48 157 40 152 Z"/>
            <path class="body-zone" data-muscle="Triceps" d="M160 152 Q166 158 167 172 Q168 186 162 196 Q156 202 149 198 Q142 194 141 182 Q140 168 145 158 Q152 157 160 152 Z"/>
            <!-- Core -->
            <path class="body-zone" data-muscle="Core" d="M64 120 Q65 150 66 170 L134 170 Q135 150 136 120 Q125 128 100 130 Q75 128 64 120 Z"/>
            <!-- Quads L/R -->
            <path class="body-zone" data-muscle="Legs" d="M60 172 L60 174 Q58 202 57 232 Q55 258 57 280 Q61 294 73 296 Q85 298 87 282 Q91 258 91 232 L91 172 Z"/>
            <path class="body-zone" data-muscle="Legs" d="M140 172 L140 174 Q142 202 143 232 Q145 258 143 280 Q139 294 127 296 Q115 298 113 282 Q109 258 109 232 L109 172 Z"/>
            <!-- Calves L/R -->
            <path class="body-zone" data-muscle="Calves" d="M57 294 Q54 314 56 334 Q58 352 65 366 Q70 376 77 376 Q84 376 86 366 Q90 350 90 332 Q90 312 87 296 Q85 298 73 296 Q61 294 57 294 Z"/>
            <path class="body-zone" data-muscle="Calves" d="M143 294 Q146 314 144 334 Q142 352 135 366 Q130 376 123 376 Q116 376 114 366 Q110 350 110 332 Q110 312 113 296 Q115 298 127 296 Q139 294 143 294 Z"/>
            <!-- Feet -->
            <ellipse cx="73" cy="392" rx="18" ry="10" fill="#1a2e1c" stroke="#253527" stroke-width="1"/>
            <ellipse cx="127" cy="392" rx="18" ry="10" fill="#1a2e1c" stroke="#253527" stroke-width="1"/>
            <!-- Labels -->
            <text x="100" y="100" class="body-label">CHEST</text>
            <text x="49"  y="134" class="body-label sm">BIC</text>
            <text x="151" y="134" class="body-label sm">BIC</text>
            <text x="49"  y="178" class="body-label sm">TRI</text>
            <text x="151" y="178" class="body-label sm">TRI</text>
            <text x="100" y="150" class="body-label">CORE</text>
            <text x="74"  y="238" class="body-label sm">QUAD</text>
            <text x="126" y="238" class="body-label sm">QUAD</text>
            <text x="73"  y="338" class="body-label sm">CALF</text>
            <text x="127" y="338" class="body-label sm">CALF</text>
          </svg>
          <!-- BACK -->
          <svg id="body-back" class="body-svg" viewBox="0 0 200 430" xmlns="http://www.w3.org/2000/svg" style="display:none;">
            <ellipse cx="100" cy="28" rx="22" ry="26" fill="#1a2e1c" stroke="#253527" stroke-width="1.5"/>
            <rect x="91" y="52" width="18" height="14" rx="4" fill="#1a2e1c" stroke="#253527" stroke-width="1"/>
            <path d="M62 66 Q55 70 53 90 L50 160 Q50 170 60 172 L140 172 Q150 170 150 160 L147 90 Q145 70 138 66 Z" fill="#162018" stroke="#253527" stroke-width="1"/>
            <!-- Shoulders back L/R -->
            <path class="body-zone" data-muscle="Shoulders" d="M55 68 Q44 72 42 86 Q40 100 48 108 Q55 115 63 110 L63 88 Q62 74 68 68 Z"/>
            <path class="body-zone" data-muscle="Shoulders" d="M145 68 Q156 72 158 86 Q160 100 152 108 Q145 115 137 110 L137 88 Q138 74 132 68 Z"/>
            <!-- Back (lats + traps) -->
            <path class="body-zone" data-muscle="Back" d="M68 68 Q64 72 63 88 L63 172 L137 172 L137 88 Q136 72 132 68 Q118 62 100 61 Q82 62 68 68 Z"/>
            <!-- Triceps back L/R -->
            <path class="body-zone" data-muscle="Triceps" d="M42 108 Q36 114 35 130 Q34 146 40 152 Q47 157 55 152 Q62 147 63 132 L63 110 Q55 115 48 108 Z"/>
            <path class="body-zone" data-muscle="Triceps" d="M158 108 Q164 114 165 130 Q166 146 160 152 Q153 157 145 152 Q138 147 137 132 L137 110 Q145 115 152 108 Z"/>
            <!-- Forearms back L/R -->
            <path class="body-zone" data-muscle="Triceps" d="M40 152 Q34 158 33 172 Q32 186 38 196 Q44 202 51 198 Q58 194 59 182 Q60 168 55 158 Q48 157 40 152 Z"/>
            <path class="body-zone" data-muscle="Triceps" d="M160 152 Q166 158 167 172 Q168 186 162 196 Q156 202 149 198 Q142 194 141 182 Q140 168 145 158 Q152 157 160 152 Z"/>
            <!-- Glutes L/R -->
            <path class="body-zone" data-muscle="Glutes" d="M62 172 L62 174 Q60 198 62 218 Q67 234 80 236 Q94 238 97 220 Q100 206 99 186 L99 172 Z"/>
            <path class="body-zone" data-muscle="Glutes" d="M138 172 L138 174 Q140 198 138 218 Q133 234 120 236 Q106 238 103 220 Q100 206 101 186 L101 172 Z"/>
            <!-- Hamstrings L/R -->
            <path class="body-zone" data-muscle="Legs" d="M62 232 Q60 258 60 280 Q62 296 75 298 Q87 300 89 284 Q91 260 91 236 Q94 238 80 236 Q67 234 62 232 Z"/>
            <path class="body-zone" data-muscle="Legs" d="M138 232 Q140 258 140 280 Q138 296 125 298 Q113 300 111 284 Q109 260 109 236 Q106 238 120 236 Q133 234 138 232 Z"/>
            <!-- Calves back L/R -->
            <path class="body-zone" data-muscle="Calves" d="M60 296 Q57 316 59 336 Q61 354 68 368 Q73 378 80 378 Q87 378 89 368 Q91 352 91 334 Q91 314 89 298 Q87 300 75 298 Q62 296 60 296 Z"/>
            <path class="body-zone" data-muscle="Calves" d="M140 296 Q143 316 141 336 Q139 354 132 368 Q127 378 120 378 Q113 378 111 368 Q109 352 109 334 Q109 314 111 298 Q113 300 125 298 Q138 296 140 296 Z"/>
            <!-- Feet -->
            <ellipse cx="75" cy="392" rx="18" ry="10" fill="#1a2e1c" stroke="#253527" stroke-width="1"/>
            <ellipse cx="125" cy="392" rx="18" ry="10" fill="#1a2e1c" stroke="#253527" stroke-width="1"/>
            <!-- Labels -->
            <text x="100" y="118" class="body-label">BACK</text>
            <text x="49"  y="134" class="body-label sm">TRI</text>
            <text x="151" y="134" class="body-label sm">TRI</text>
            <text x="80"  y="204" class="body-label sm">GLUTE</text>
            <text x="120" y="204" class="body-label sm">GLUTE</text>
            <text x="75"  y="268" class="body-label sm">HAM</text>
            <text x="125" y="268" class="body-label sm">HAM</text>
            <text x="75"  y="340" class="body-label sm">CALF</text>
            <text x="125" y="340" class="body-label sm">CALF</text>
          </svg>
        </div>
      </div>
    </div>

    </div></div><!-- end section-bodymap -->

    <!-- Body map tap hint -->
    <div class="body-tap-hint" id="body-tap-hint-el">â†‘ tap a muscle to explore &amp; log</div>

    <!-- MUSCLE HISTORY (shown after muscle is selected) -->
    <div class="panel" id="muscle-history-panel" style="display:none;">
      <div class="panel-header">
        <span class="panel-title" id="muscle-history-title">CHEST HISTORY</span>
        <span class="panel-badge" id="muscle-history-badge">0 SESSIONS</span>
      </div>
      <div id="muscle-history-body"></div>
    </div>

    <!-- EXERCISE ENTRY -->
    <div class="log-section" id="section-exercise" data-section="exercise">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-exercise')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-exercise')" title="Move down">â†“</button>
      </div>
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title" id="exercise-panel-title">Exercise Entry</span>
        <span class="panel-badge" id="set-count-badge">0 SETS</span>
      </div>
      <div class="panel-body">

        <!-- BODYWEIGHT MODE: quick exercise picker -->
        <div id="bw-exercise-picker" style="display:none;">
          <label style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:8px;">Quick Select</label>
          <div class="bw-exercises-grid" id="bw-exercises-grid"></div>
        </div>

        <div class="form-group" style="position:relative;">
          <label id="exercise-name-label">Exercise Name</label>
          <input type="text" id="exercise-name" placeholder="e.g. Bench Press, Squatâ€¦" autocomplete="off" autocapitalize="words">
          <div id="exercise-autocomplete" class="ex-autocomplete" style="display:none;"></div>
        </div>
        <!-- LAST SESSION HINT -->
        <div id="last-session-hint" style="display:none;margin-bottom:12px;">
          <div style="background:var(--green-dim);border:1px solid var(--green3);border-radius:7px;padding:10px 12px;">
            <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--green);margin-bottom:6px;">Last Session</div>
            <div id="last-session-content" style="font-size:13px;color:var(--text2);line-height:1.6;"></div>
          </div>
        </div>
        <!-- WEIGHTED sets header -->
        <div id="weighted-sets-section" class="form-group">
          <div class="sets-header">
            <span>SET</span><span>REPS</span><span>WEIGHT</span><span>UNIT</span><span></span>
          </div>
          <div id="sets-container"></div>
          <button class="btn btn-add" onclick="addSet()">+ Add Set</button>
        </div>

        <!-- BODYWEIGHT sets header -->
        <div id="bw-sets-section" class="form-group" style="display:none;">
          <div class="sets-header" style="grid-template-columns:36px 1fr 1fr 34px;">
            <span>SET</span><span>REPS</span><span>EFFORT</span><span></span>
          </div>
          <div id="bw-sets-container"></div>
          <button class="btn btn-add" onclick="addBwSet()">+ Add Set</button>
        </div>

        <!-- BW stats under the form -->
        <div id="bw-stats-area" style="display:none;">
          <div class="bw-stats-strip" id="bw-stats-strip"></div>
        </div>

        <div class="form-group">
          <label>Notes (optional)</label>
          <input type="text" id="session-notes" placeholder="How did it feel? Any PRs?">
        </div>
        <button class="btn btn-primary" id="save-btn" onclick="saveWorkout()"><svg class="btn-icon-svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>Log Workout</button>
      </div>
    </div>
    </div></div><!-- end section-exercise -->

    <!-- COACH PANEL â€” SMART AI -->
    <div class="log-section" id="section-coach" data-section="coach">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-coach')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-coach')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-coach')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    <div class="coach-panel" id="coach-panel">
      <div class="coach-header">
        <div class="coach-avatar" id="coach-avatar"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96-.46 2.5 2.5 0 0 1-1.96-3 2.5 2.5 0 0 1-1.32-4.24 3 3 0 0 1 .34-5.58 2.5 2.5 0 0 1 1.96-3A2.5 2.5 0 0 1 9.5 2z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96-.46 2.5 2.5 0 0 0 1.96-3 2.5 2.5 0 0 0 1.32-4.24 3 3 0 0 0-.34-5.58 2.5 2.5 0 0 0-1.96-3A2.5 2.5 0 0 0 14.5 2z"/></svg></div>
        <div style="flex:1;">
          <div class="coach-name">FORGE COACH <span style="font-size:9px;letter-spacing:1px;color:var(--text3);font-family:'DM Mono',monospace;">AI</span></div>
          <div class="coach-status" id="coach-status" data-i18n="coach.status.init">Analysing your trainingâ€¦</div>
        </div>
        <div id="coach-score-badge" style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--accent);line-height:1;"></div>
      </div>
      <!-- Training Score Ring + breakdown -->
      <div class="coach-score-wrap" id="coach-score-wrap" style="display:none;">
        <svg class="score-ring-svg" width="68" height="68" viewBox="0 0 68 68">
          <circle class="score-ring-track" cx="34" cy="34" r="28"/>
          <circle class="score-ring-fill" id="score-ring-fill" cx="34" cy="34" r="28"
            stroke="var(--accent)"
            stroke-dasharray="175.93"
            stroke-dashoffset="175.93"
            transform="rotate(-90 34 34)"/>
          <text class="score-ring-text" x="34" y="31" id="score-ring-num">0</text>
          <text class="score-label-text" x="34" y="43" id="score-ring-label">SCORE</text>
        </svg>
        <div class="score-details" id="score-details"></div>
      </div>
      <!-- Coach Tabs -->
      <div class="coach-tabs">
        <button class="coach-tab active" onclick="coachSwitchTab('insights',this)" data-i18n="coach.tab.insights"><svg class="ctab-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg> Insights</button>
        <button class="coach-tab" onclick="coachSwitchTab('plan',this)" data-i18n="coach.tab.plan"><svg class="ctab-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Week Plan</button>
        <button class="coach-tab" onclick="coachSwitchTab('nutrition',this)" data-i18n="coach.tab.nutrition"><svg class="ctab-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Nutrition</button>
        <button class="coach-tab" onclick="coachSwitchTab('prs',this)" data-i18n="coach.tab.prs"><svg class="ctab-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg> PRs</button>
      </div>
      <!-- Tab content areas -->
      <div id="coach-tab-insights"><div class="coach-chat-wrap" id="coach-body"></div></div>
      <div id="coach-tab-plan" style="display:none;"></div>
      <div id="coach-tab-nutrition" style="display:none;"></div>
      <div id="coach-tab-prs" style="display:none;"></div>
    </div>

    </div></div><!-- end section-coach -->

    <!-- TIPS -->
    <div class="log-section" id="section-tips" data-section="tips">
      <div class="section-edit-controls">
        <button class="sec-ctrl-btn sec-ctrl-up" onclick="moveSectionUp('section-tips')" title="Move up">â†‘</button>
        <button class="sec-ctrl-btn sec-ctrl-down" onclick="moveSectionDown('section-tips')" title="Move down">â†“</button>
        <button class="sec-ctrl-btn sec-ctrl-hide" onclick="toggleSectionHidden('section-tips')" title="Hide"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title" data-i18n="section.tips">Smart Tips</span>
        <span class="panel-badge" data-i18n="section.tipsbadge">HINTS</span>
      </div>
      <div class="panel-body" id="tips-container">
        <div class="tips-list" id="tips-list-dynamic">
          <div class="tip-card"><div class="tip-icon">ğŸ¯</div><div><div class="tip-title" data-i18n="tip.overload.title">Progressive Overload</div><div class="tip-text" data-i18n="tip.overload.text">Aim to add 2.5â€“5 kg every 2 weeks. Small gains compound into massive results.</div></div></div>
          <div class="tip-card"><div class="tip-icon">â±ï¸</div><div><div class="tip-title" data-i18n="tip.timer.title">Use the Rest Timer</div><div class="tip-text" data-i18n="tip.timer.text">Consistent rest periods (60â€“120s) lead to better strength performance across sets.</div></div></div>
        </div>
      </div>
    </div>
    </div></div><!-- end section-tips -->
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD VIEW
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="view-dashboard" class="view">

    <!-- â”€â”€ WEIGHTED LIFTING STATS â”€â”€ -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/></svg></span>
      <span class="vsh-title" data-i18n="dash.wgtSection">Weight Lifting</span>
      <span class="vsh-line"></span>
    </div>
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-label" data-i18n="dash.statVol">Total Volume</div><div class="stat-value" id="dash-total-vol">0<span class="stat-unit">kg</span></div><div class="stat-delta up" id="dash-vol-delta">â€”</div></div>
      <div class="stat-card"><div class="stat-label" data-i18n="dash.statSessions">Sessions</div><div class="stat-value" id="dash-sessions">0</div><div class="stat-delta neutral" data-i18n="dash.allTime">All time</div></div>
      <div class="stat-card"><div class="stat-label" data-i18n="dash.statSets">Total Sets</div><div class="stat-value" id="dash-sets">0</div><div class="stat-delta neutral" data-i18n="dash.allTime">All time</div></div>
      <div class="stat-card"><div class="stat-label" data-i18n="dash.statPR">Personal Best</div><div class="stat-value" id="dash-pr">0<span class="stat-unit">kg</span></div><div class="stat-delta up" id="dash-pr-exercise">â€”</div></div>
    </div>

    <!-- â”€â”€ BODYWEIGHT WORKOUT STATS â”€â”€ -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M12 7v6"/><path d="M9 10l-2 4h10l-2-4"/><path d="M10 17l-1 4M14 17l1 4"/></svg></span>
      <span class="vsh-title" data-i18n="dash.bwSection">Bodyweight</span>
      <span class="vsh-line"></span>
    </div>
    <div class="stats-bar bw-stats-bar">
      <div class="stat-card bw-card"><div class="stat-label" data-i18n="dash.bwSessions">BW Sessions</div><div class="stat-value" id="dash-bw-sessions">0</div><div class="stat-delta neutral" data-i18n="dash.allTime">All time</div></div>
      <div class="stat-card bw-card"><div class="stat-label" data-i18n="dash.bwSets">BW Sets</div><div class="stat-value" id="dash-bw-sets">0</div><div class="stat-delta neutral" data-i18n="dash.allTime">All time</div></div>
      <div class="stat-card bw-card"><div class="stat-label" data-i18n="dash.bwTopEx">Top Exercise</div><div class="stat-value bw-top-ex" id="dash-bw-top-ex">â€”</div><div class="stat-delta neutral" id="dash-bw-top-ex-sets">â€”</div></div>
      <div class="stat-card bw-card"><div class="stat-label" data-i18n="dash.bwStreak">BW Streak</div><div class="stat-value" id="dash-bw-streak">0</div><div class="stat-delta up" id="dash-bw-streak-unit">days</div></div>
    </div>

    <!-- BODY COMPOSITION LOG & CHART -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Body Composition</span>
        <span class="panel-badge">TRACK</span>
      </div>
      <div class="panel-body" style="padding-bottom:8px;">
        <!-- Row 1: Body weight -->
        <div class="bcomp-row">
          <div class="bcomp-field-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>Body Weight</div>
          <div class="bcomp-inputs">
            <input type="number" id="bw-input" placeholder="e.g. 80.5" step="0.1">
            <select id="bw-unit">
              <option value="kg">kg</option>
              <option value="lbs">lbs</option>
            </select>
          </div>
        </div>
        <!-- Row 2: Body fat % -->
        <div class="bcomp-row">
          <div class="bcomp-field-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M12 2c0 0-7 6.5-7 12a7 7 0 0 0 14 0c0-5.5-7-12-7-12z"/><path d="M9.5 14.5c.5 1.5 2.5 2.5 4 1.5"/></svg>Body Fat %</div>
          <div class="bcomp-inputs">
            <input type="number" id="bf-input" placeholder="e.g. 18.5" step="0.1" min="2" max="60">
            <div class="bcomp-unit-label">%</div>
          </div>
        </div>
        <!-- Row 3: Muscle mass -->
        <div class="bcomp-row">
          <div class="bcomp-field-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/></svg>Muscle Mass</div>
          <div class="bcomp-inputs">
            <input type="number" id="mm-input" placeholder="e.g. 38.0" step="0.1" min="10">
            <div class="bcomp-unit-label" id="mm-unit-lbl">kg</div>
          </div>
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:4px;" onclick="logBodyWeight()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Log Entry</button>
      </div>
      <!-- Chart tabs -->
      <div class="bcomp-chart-tabs">
        <button class="bcomp-tab active" onclick="switchBcompChart('weight',this)">Weight</button>
        <button class="bcomp-tab" onclick="switchBcompChart('bodyfat',this)">Body Fat</button>
        <button class="bcomp-tab" onclick="switchBcompChart('muscle',this)">Muscle</button>
      </div>
      <div class="chart-inner h180"><canvas id="bw-chart"></canvas></div>
    </div>

    <!-- VOLUME OVER TIME -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Training Volume</span><span class="panel-badge">WEEKLY</span></div>
      <div class="chart-inner h220"><canvas id="volume-chart"></canvas></div>
    </div>

    <!-- WEIGHT PROGRESS -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Weight Progress</span><span class="panel-badge">EXERCISE</span></div>
      <div style="padding:10px 14px 0;">
        <select id="exercise-select" onchange="updateWeightChart()" style="margin-bottom:0;">
          <option value="">â€” Select exercise â€”</option>
        </select>
      </div>
      <div class="chart-inner h220"><canvas id="weight-chart"></canvas></div>
    </div>

    <!-- MUSCLE VOLUME SPLIT -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Volume by Muscle</span><span class="panel-badge">ALL TIME</span></div>
      <div class="vol-list" id="vol-list"></div>
    </div>

    <!-- FREQUENCY DOUGHNUT -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Muscle Frequency</span><span class="panel-badge">SESSIONS</span></div>
      <div class="chart-inner h260"><canvas id="freq-chart"></canvas></div>
    </div>

    <!-- WATER TRACKER -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Hydration Today</span>
        <span class="panel-badge" id="water-badge">0 / 8 cups</span>
      </div>
      <div class="water-grid" id="water-grid"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HISTORY VIEW
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="view-history" class="view">

    <!-- Section hero -->
    <div class="view-hero">
      <div class="view-hero-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
      <div class="view-hero-text">
        <div class="view-hero-title" data-i18n="hist.title">Workout History</div>
        <div class="view-hero-sub" data-i18n="hist.sub">All your sessions & personal records</div>
      </div>
    </div>

    <!-- PERSONAL RECORDS -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg></span>
      <span class="vsh-title" data-i18n="hist.prs">Personal Records</span>
      <span class="vsh-line"></span>
    </div>
    <div class="panel pr-panel">
      <div class="panel-body" id="pr-list">
        <div class="empty-state"><div class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg></div><div class="empty-title">No PRs yet</div></div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
      <span class="vsh-title" data-i18n="hist.filter">Filter & Search</span>
      <span class="vsh-line"></span>
    </div>
    <div class="panel filter-panel">
      <div class="panel-body filter-body">
        <div class="filter-row">
          <label data-i18n="hist.filterMuscle">Muscle</label>
          <select id="filter-muscle" onchange="renderHistory()">
            <option value="">All muscles</option>
            <option>Chest</option><option>Back</option><option>Shoulders</option>
            <option>Biceps</option><option>Triceps</option><option>Legs</option>
            <option>Core</option><option>Glutes</option><option>Calves</option>
          </select>
        </div>
        <div class="filter-row">
          <label data-i18n="hist.filterEx">Exercise</label>
          <input type="text" id="filter-exercise" placeholder="Searchâ€¦" oninput="renderHistory()">
        </div>
        <div class="filter-row">
          <label data-i18n="hist.filterSort">Sort</label>
          <select id="filter-sort" onchange="renderHistory()">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="vol-desc">Highest Volume</option>
          </select>
        </div>
      </div>
    </div>

    <!-- WORKOUT LOG -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/></svg></span>
      <span class="vsh-title" data-i18n="hist.log">Workout Log</span>
      <span class="vsh-badge" id="hist-count-badge">0 ENTRIES</span>
      <span class="vsh-line"></span>
    </div>
    <div class="panel log-panel">
      <div class="panel-body" style="padding:8px;">
        <div class="history-list" id="history-list">
          <div class="empty-state"><div class="empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div><div class="empty-title">No workouts yet</div><div class="empty-sub">Log your first workout to start tracking</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MORE VIEW (Settings + Tools)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="view-more" class="view">

    <!-- Section hero -->
    <div class="view-hero">
      <div class="view-hero-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
      <div class="view-hero-text">
        <div class="view-hero-title" data-i18n="more.title">Settings & Tools</div>
        <div class="view-hero-sub" data-i18n="more.sub">Profile, themes, data & more</div>
      </div>
    </div>

    <!-- MY PROFILE -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
      <span class="vsh-title" data-i18n="more.profile">My Profile</span>
      <span class="vsh-line"></span>
    </div>
  <div class="panel profile-panel">
    <div class="panel-header">
      <span class="panel-title">My Profile</span>
      <span class="panel-badge profile-level-badge" id="profile-level-badge">ROOKIE</span>
    </div>
    <div class="panel-body">
      <!-- Avatar row -->
      <div class="profile-avatar-row">
        <div class="profile-avatar" id="profile-avatar"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M12 7v6"/><path d="M9 10l-2 4h10l-2-4"/><path d="M10 17l-1 4M14 17l1 4"/></svg></div>
        <div class="profile-avatar-info">
          <div class="profile-name" id="profile-name-display">Athlete</div>
          <div class="profile-xp-mini" id="profile-xp-mini">0 XP</div>
        </div>
      </div>
      <!-- Fields row -->
      <div class="profile-fields">
        <div class="profile-field">
          <label class="pf-label">Date of Birth</label>
          <input type="date" id="profile-dob" class="pf-input" oninput="saveProfile()" placeholder="YYYY-MM-DD">
          <div class="pf-hint" id="profile-age-hint"></div>
        </div>
        <div class="profile-field">
          <label class="pf-label">Name</label>
          <input type="text" id="profile-name" class="pf-input" oninput="saveProfile()" placeholder="Your name">
        </div>
        <div class="profile-field">
          <label class="pf-label">Height</label>
          <div style="display:flex;gap:6px;align-items:center;">
            <input type="number" id="profile-height" class="pf-input" oninput="saveProfile()" placeholder="175" min="100" max="250" style="flex:1;">
            <select id="profile-height-unit" class="pf-input" style="width:64px;" onchange="saveProfile()">
              <option value="cm">cm</option>
              <option value="ft">ft</option>
            </select>
          </div>
        </div>
        <div class="profile-field">
          <label class="pf-label">Training Goal</label>
          <select id="profile-goal" class="pf-input" onchange="saveProfile()">
            <option value="">â€” Select goal â€”</option>
            <option value="muscle">Build Muscle</option>
            <option value="strength">Build Strength</option>
            <option value="fat_loss">Fat Loss</option>
            <option value="endurance">Endurance</option>
            <option value="recomp">Body Recomposition</option>
          </select>
        </div>
      </div>
      <!-- Stats computed from profile -->
      <div class="profile-computed" id="profile-computed" style="display:none;">
        <div class="pc-item"><span class="pc-label">Age</span><span class="pc-val" id="pc-age">â€”</span></div>
        <div class="pc-item"><span class="pc-label">BMI</span><span class="pc-val" id="pc-bmi">â€”</span></div>
        <div class="pc-item"><span class="pc-label">TDEE est.</span><span class="pc-val" id="pc-tdee">â€”</span></div>
      </div>
    </div>
  </div>

    <!-- WORKOUT TEMPLATES EDITOR -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></span>
      <span class="vsh-title" data-i18n="more.templates">Templates</span>
      <span class="vsh-line"></span>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">My Templates</span><span class="panel-badge">CUSTOM</span></div>
      <div class="panel-body">
        <p style="font-size:13px;color:var(--text2);margin-bottom:12px;">Save favourite workout combos for quick-start on the Log tab.</p>
        <button class="btn btn-ghost" style="width:100%;margin-bottom:10px;" onclick="openTemplateModal()">+ Create Template</button>
        <div id="my-templates-list"></div>
      </div>
    </div>

    <!-- BODY COMPOSITION LOG LIST -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></span>
      <span class="vsh-title" data-i18n="more.bodyComp">Body Composition</span>
      <span class="vsh-line"></span>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Body Composition</span><span class="panel-badge">HISTORY</span></div>
      <div class="panel-body">
        <!-- Composition mini cards -->
        <div class="comp-cards" id="comp-cards">
          <div class="comp-card">
            <div class="comp-card-val" id="comp-bw-val">â€”</div>
            <div class="comp-card-lbl">Body Weight</div>
            <div class="comp-card-trend" id="comp-bw-trend"></div>
          </div>
          <div class="comp-card accent">
            <div class="comp-card-val" id="comp-bf-val">â€”</div>
            <div class="comp-card-lbl">Body Fat %</div>
            <div class="comp-card-trend" id="comp-bf-trend"></div>
          </div>
          <div class="comp-card green">
            <div class="comp-card-val" id="comp-mm-val">â€”</div>
            <div class="comp-card-lbl">Muscle Mass</div>
            <div class="comp-card-trend" id="comp-mm-trend"></div>
          </div>
        </div>
        <div class="bw-history-inner" id="bw-history-list">
          <div class="empty-state"><div class="empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div><div class="empty-title">No entries yet</div></div>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
      <span class="vsh-title" data-i18n="more.settings">Settings</span>
      <span class="vsh-line"></span>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Settings</span></div>
      <div class="panel-body">

        <!-- LIGHT MODE QUICK TOGGLE -->
        <div class="light-mode-banner" id="light-mode-banner">
          <div class="lmb-left">
            <span class="lmb-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span>
            <div>
              <div class="lmb-title" data-i18n="settings.lightMode">Light Mode</div>
              <div class="lmb-sub" data-i18n="settings.lightModeSub">Switch to SOLAR warm theme</div>
            </div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="light-mode-toggle" onchange="toggleLightMode(this.checked)">
            <span class="toggle-thumb"></span>
          </label>
        </div>

        <!-- THEME PICKER -->
        <div class="theme-picker-section">
          <span class="theme-picker-label">App Theme</span>
          <div class="theme-grid" id="theme-grid">
            <!-- injected by renderThemePicker() -->
          </div>
        </div>

        <!-- ACCENT COLOR -->
        <div class="theme-picker-section" id="accent-section" style="display:none;">
          <span class="theme-picker-label">Accent Color</span>
          <div class="accent-row" id="accent-row"></div>
        </div>

        <div class="toggle-row">
          <div>
            <div class="toggle-label" data-i18n="settings.unit">Default Weight Unit</div>
            <div class="toggle-sub" data-i18n="settings.unitSub">Sets will default to this unit</div>
          </div>
          <select id="default-unit-setting" onchange="saveSetting('defaultUnit',this.value)" style="width:70px;">
            <option value="kg">kg</option>
            <option value="lbs">lbs</option>
          </select>
        </div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label" data-i18n="settings.sound">Rest Timer Sound</div>
            <div class="toggle-sub" data-i18n="settings.soundSub">Vibrate &amp; beep when rest ends</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sound-setting" onchange="saveSetting('sound',this.checked)" checked>
            <span class="toggle-thumb"></span>
          </label>
        </div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label" data-i18n="settings.hint">Show Last Session Hint</div>
            <div class="toggle-sub" data-i18n="settings.hintSub">Shows previous sets when logging</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="hint-setting" onchange="saveSetting('showHint',this.checked)" checked>
            <span class="toggle-thumb"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- DATA -->
    <div class="view-section-header">
      <span class="vsh-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 15 21 21 3 21 3 15"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span>
      <span class="vsh-title" data-i18n="more.data">Data & Export</span>
      <span class="vsh-line"></span>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Data &amp; Export</span></div>
      <div class="panel-body" style="display:flex;flex-direction:column;gap:10px;">
        <button class="btn btn-ghost" style="width:100%;" onclick="exportCSV()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px;"><polyline points="21 15 21 21 3 21 3 15"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Export Workouts (CSV)</button>
        <button class="btn btn-ghost" style="width:100%;" onclick="exportJSON()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>Backup All Data (JSON)</button>
        <label class="btn btn-ghost" style="width:100%;cursor:pointer;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px;"><polyline points="21 15 21 21 3 21 3 15"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Restore from Backup
          <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importJSON(this)">
        </label>
        <button class="btn btn-danger btn-sm" style="width:100%;" onclick="confirmClear()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>Clear All Data</button>
      </div>
    </div>

    <!-- INSTALL GUIDE -->
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Install on Phone</span><span class="panel-badge">PWA</span></div>
      <div class="panel-body">
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div class="tip-card"><div class="tip-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></div><div><div class="tip-title">Android (Chrome)</div><div class="tip-text">Tap the three-dot menu â†’ "Add to Home screen" â†’ Install. FORGE will appear like a native app.</div></div></div>
          <div class="tip-card"><div class="tip-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2z"/><path d="M12 8v8M8 12h8"/></svg></div><div><div class="tip-title">iPhone (Safari)</div><div class="tip-text">Tap the Share button â†’ "Add to Home Screen" â†’ Add. Works offline after first load.</div></div></div>
          <div class="tip-card"><div class="tip-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div><div><div class="tip-title">Get a Real APK</div><div class="tip-text">Host this app on GitHub Pages (free), then visit pwabuilder.com and paste your URL to download an Android APK.</div></div></div>
        </div>
      </div>
    </div>

  </div>

</div><!-- end app-shell -->

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
  <button class="bnav-btn active" id="bnav-log" onclick="switchView('log',this)">
    <span class="bnav-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
      </svg>
    </span>Log
  </button>
  <button class="bnav-btn" id="bnav-dashboard" onclick="switchView('dashboard',this)">
    <span class="bnav-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
      </svg>
    </span>Stats
  </button>
  <button class="bnav-btn" id="bnav-history" onclick="switchView('history',this)">
    <span class="bnav-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/>
      </svg>
    </span>History
  </button>
  <button class="bnav-btn" id="bnav-more" onclick="switchView('more',this)">
    <span class="bnav-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
      </svg>
    </span>More
  </button>
</nav>

<!-- TEMPLATE MODAL -->
<div class="modal-overlay" id="template-modal" onclick="closeTemplateModal(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;letter-spacing:2px;margin-bottom:16px;">New Template</div>
    <div class="form-group"><label>Template Name</label><input type="text" id="tmpl-name" placeholder="e.g. Push Day A"></div>
    <div class="form-group"><label>Muscle Group</label>
      <select id="tmpl-muscle">
        <option value="Chest">Chest</option><option value="Back">Back</option>
        <option value="Shoulders">Shoulders</option><option value="Biceps">Biceps</option>
        <option value="Triceps">Triceps</option><option value="Legs">Legs</option>
        <option value="Core">Core</option><option value="Glutes">Glutes</option><option value="Calves">Calves</option>
      </select>
    </div>
    <div class="form-group"><label>Exercises (comma-separated)</label><input type="text" id="tmpl-exercises" placeholder="Bench Press, Incline DB, Cable Fly"></div>
    <div class="form-group"><label>Emoji Icon</label><input type="text" id="tmpl-icon" placeholder="ğŸ’ª" maxlength="2" style="font-size:24px;text-align:center;"></div>
    <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ACHIEVEMENT POPUP -->
<div class="achievement-popup" id="achievement-popup">
  <span class="ach-emoji" id="ach-emoji"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg></span>
  <div class="ach-title">ACHIEVEMENT UNLOCKED</div>
  <div class="ach-name" id="ach-name">First Blood</div>
  <div class="ach-desc" id="ach-desc">Logged your first workout</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MUSCLE DETAIL OVERLAY (full-screen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="muscle-overlay" id="muscle-overlay">
  <div class="mo-header">
    <div class="mo-muscle-icon" id="mo-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/></svg></div>
    <div class="mo-muscle-info">
      <div class="mo-muscle-name" id="mo-name">CHEST</div>
      <div class="mo-muscle-sub" id="mo-sub">0 sessions logged</div>
    </div>
    <button class="mo-close-btn" onclick="closeMuscleOverlay()">âœ•</button>
  </div>

  <!-- Quick stats strip -->
  <div class="mo-stats-strip" id="mo-stats-strip">
    <div class="mo-stat">
      <div class="mo-stat-val" id="mo-stat-sessions">0</div>
      <div class="mo-stat-lbl">Sessions</div>
    </div>
    <div class="mo-stat">
      <div class="mo-stat-val" id="mo-stat-vol">0</div>
      <div class="mo-stat-lbl">Total Vol</div>
    </div>
    <div class="mo-stat">
      <div class="mo-stat-val" id="mo-stat-pr">â€”</div>
      <div class="mo-stat-lbl">Best PR</div>
    </div>
    <div class="mo-stat">
      <div class="mo-stat-val" id="mo-stat-last">â€”</div>
      <div class="mo-stat-lbl">Last Trained</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mo-tabs">
    <button class="mo-tab active" onclick="moSwitchTab('history', this)">History</button>
    <button class="mo-tab" onclick="moSwitchTab('tips', this)">Tips</button>
    <button class="mo-tab" onclick="moSwitchTab('exercises', this)">Exercises</button>
  </div>

  <!-- Tab content -->
  <div class="mo-content" id="mo-tab-history">
    <div class="mo-history-list" id="mo-history-list"></div>
  </div>
  <div class="mo-content" id="mo-tab-tips" style="display:none;">
    <div class="mo-tips-list" id="mo-tips-list"></div>
  </div>
  <div class="mo-content" id="mo-tab-exercises" style="display:none;">
    <div class="mo-exercises-list" id="mo-exercises-list"></div>
  </div>

  <!-- CTA button to start workout for this muscle -->
  <div class="mo-cta">
    <button class="mo-cta-btn" id="mo-cta-btn" onclick="startWorkoutFromOverlay()">
      <svg class="btn-icon-svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>Train This Muscle</span>
    </button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let workouts   = JSON.parse(localStorage.getItem('forge_workouts')   || '[]');
let bodyWeight = JSON.parse(localStorage.getItem('forge_bodyweight') || '[]');
let templates  = JSON.parse(localStorage.getItem('forge_templates')  || '[]');
let settings   = JSON.parse(localStorage.getItem('forge_settings')   || '{"defaultUnit":"kg","sound":true,"showHint":true}');
let waterToday = JSON.parse(localStorage.getItem('forge_water_' + today()) || '[]');

let setCount = 0, selectedMuscle = '';
let timerInterval = null, timerSeconds = 0, timerTarget = 90, timerRunning = false;
let sessionStart = Date.now();
let volChart, wgtChart, freqChrt, bwChrt;

const _SI = (p,extra='') => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;${extra}">${p}</svg>`;
const MUSCLE_ICONS = {
  Chest:     _SI('<path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/>'),
  Back:      _SI('<path d="M4 6c0 0 2-2 8-2s8 2 8 2"/><path d="M4 12c0 0 2 2 8 2s8-2 8-2"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="7" y1="8" x2="7" y2="16"/><line x1="17" y1="8" x2="17" y2="16"/>'),
  Shoulders: _SI('<path d="M12 8c-4 0-7 2-7 5s3 5 7 5 7-2 7-5-3-5-7-5z"/><path d="M12 5v3"/>'),
  Biceps:    _SI('<path d="M6 16c0-4 2-8 6-8s6 4 6 8"/><path d="M6 16h12"/><path d="M9 10l-2-4M15 10l2-4"/>'),
  Triceps:   _SI('<path d="M8 6l-2 12M16 6l2 12"/><path d="M6 18h12"/><path d="M9 6h6"/>'),
  Legs:      _SI('<path d="M8 3c0 0 1 2 1 5s-2 6-2 9c0 1.5.5 3 2 4"/><path d="M16 3c0 0-1 2-1 5s2 6 2 9c0 1.5-.5 3-2 4"/><path d="M9 16c1 1.5 3 2 5 1"/>'),
  Core:      _SI('<ellipse cx="12" cy="12" rx="4" ry="6"/><path d="M8 8c-2 1-3 3-3 4s1 3 3 4"/><path d="M16 8c2 1 3 3 3 4s-1 3-3 4"/>'),
  Glutes:    _SI('<path d="M6 14c0-4 2-7 6-7s6 3 6 7c0 3-2 5-6 5s-6-2-6-5z"/><path d="M12 7V4"/>'),
  Calves:    _SI('<path d="M10 3l-2 10 2 8"/><path d="M14 3l2 10-2 8"/><path d="M8 13h8"/>')
};

function today() { return new Date().toDateString(); }

function save() {
  localStorage.setItem('forge_workouts',   JSON.stringify(workouts));
  localStorage.setItem('forge_bodyweight', JSON.stringify(bodyWeight));
  localStorage.setItem('forge_templates',  JSON.stringify(templates));
  localStorage.setItem('forge_settings',   JSON.stringify(settings));
  localStorage.setItem('forge_water_' + today(), JSON.stringify(waterToday));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setInterval(() => {
  const s = Math.floor((Date.now() - sessionStart) / 1000);
  const m = Math.floor(s / 60), sec = s % 60;
  document.getElementById('session-time').textContent =
    String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
}, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REST TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTimer(s) {
  timerTarget = s; timerSeconds = s; timerRunning = false;
  clearInterval(timerInterval);
  document.querySelectorAll('.timer-preset-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderTimer();
}

function startTimer() {
  if (timerRunning) return;
  timerSeconds = timerTarget; timerRunning = true;
  renderTimer();
  timerInterval = setInterval(() => {
    timerSeconds--;
    renderTimer();
    if (timerSeconds <= 0) {
      clearInterval(timerInterval); timerRunning = false;
      timerDone();
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval); timerRunning = false;
  timerSeconds = timerTarget; renderTimer();
}

function renderTimer() {
  const m = Math.floor(timerSeconds / 60), s = timerSeconds % 60;
  const el = document.getElementById('timer-display');
  el.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  el.className = 'timer-display' + (timerRunning ? ' rest' : '');
}

function timerDone() {
  const el = document.getElementById('timer-display');
  el.textContent = 'GO!'; el.className = 'timer-display done';
  // â”€â”€ FX sound engine (falls back to legacy if not loaded) â”€â”€
  if (typeof sndTimerDone === 'function') {
    sndTimerDone();
  } else if (settings.sound) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      [880, 1100, 1320].forEach((freq, i) => {
        const osc = ctx.createOscillator(), gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = freq; gain.gain.value = 0.3;
        osc.start(ctx.currentTime + i * 0.15);
        osc.stop(ctx.currentTime + i * 0.15 + 0.12);
      });
    } catch(e) {}
  }
  if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
  // â”€â”€ Brief screen accent pulse â”€â”€
  const flash = document.getElementById('save-flash');
  if (flash) {
    flash.style.background = 'var(--accent)';
    flash.classList.remove('flash');
    void flash.offsetWidth;
    flash.classList.add('flash');
    flash.addEventListener('animationend', () => flash.classList.remove('flash'), { once: true });
  }
  setTimeout(() => { timerSeconds = timerTarget; renderTimer(); }, 1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(name, btn) {
  // Safety: re-parent any log sections that escaped view-log back into it
  const logView = document.getElementById('view-log');
  if (logView) {
    document.querySelectorAll('.log-section').forEach(el => {
      if (el.parentElement !== logView) logView.appendChild(el);
    });
  }
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'dashboard') setTimeout(renderDashboard, 50);
  if (name === 'history')   { renderHistory(); renderPRs(); }
  if (name === 'more')      { renderBWHistory(); renderMyTemplates(); loadSettings(); renderProfile(); renderCompCards(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MUSCLE & TIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectMuscle(muscleOrBtn, fromOverlay) {
  const muscle = typeof muscleOrBtn === 'string' ? muscleOrBtn : muscleOrBtn.dataset.muscle;
  selectedMuscle = muscle;
  document.getElementById('selected-muscle-badge').textContent = muscle.toUpperCase();
  // Highlight all matching zones
  document.querySelectorAll('.body-zone').forEach(z => {
    z.classList.toggle('zone-selected', z.dataset.muscle === muscle);
  });
  // Update label
  const lbl = document.getElementById('body-selected-label');
  if (lbl) lbl.textContent = muscle.toUpperCase();
  updateTips();
  // Open full-screen overlay when tapping from body map
  if (!fromOverlay) {
    openMuscleOverlay(muscle);
  } else {
    renderMuscleHistory(muscle);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MUSCLE HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mhVisibleLimit = 3; // sessions shown per exercise initially

function renderMuscleHistory(muscle) {
  const panel  = document.getElementById('muscle-history-panel');
  const body   = document.getElementById('muscle-history-body');
  const title  = document.getElementById('muscle-history-title');
  const badge  = document.getElementById('muscle-history-badge');

  // Filter workouts for this muscle, newest first
  const sessions = [...workouts]
    .filter(w => w.muscle === muscle)
    .sort((a,b) => new Date(b.date) - new Date(a.date));

  title.innerHTML = (MUSCLE_ICONS[muscle] || '') + ' ' + muscle.toUpperCase() + ' HISTORY';
  badge.textContent = sessions.length + ' SESSION' + (sessions.length !== 1 ? 'S' : '');

  if (!sessions.length) {
    panel.style.display = 'block';
    body.innerHTML = `<div class="mh-empty"><div class="mh-empty-icon">${MUSCLE_ICONS[muscle]||MUSCLE_ICONS['Chest']}</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;text-transform:uppercase;">No ${muscle} workouts yet</div>
      <div style="font-size:12px;margin-top:4px;">Log your first ${muscle} session above!</div></div>`;
    return;
  }

  // Group by exercise name
  const byExercise = new Map();
  sessions.forEach(w => {
    if (!byExercise.has(w.exercise)) byExercise.set(w.exercise, []);
    byExercise.get(w.exercise).push(w);
  });

  let html = '';
  byExercise.forEach((exSessions, exName) => {
    const shown = exSessions.slice(0, 3);
    const total = exSessions.length;
    html += `<div class="mh-exercise-block">
      <div class="mh-ex-header">
        <span class="mh-ex-name">${exName}</span>
        <span class="mh-ex-count">${total} SESSION${total!==1?'S':''}</span>
      </div>
      <div class="mh-sessions" id="mh-ex-${CSS.escape(exName)}">`;

    shown.forEach((w, idx) => {
      const dateStr = new Date(w.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short', year:'numeric'});
      const vol = Math.round(w.totalVolume);
      const maxW = Math.max(...w.sets.map(s => s.weight));
      const unit = w.sets[0]?.unit || 'kg';
      html += `<div class="mh-session">
        <div class="mh-session-header">
          <span class="mh-session-date"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:3px;opacity:.7;"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${dateStr}</span>
          <div style="display:flex;align-items:center;gap:8px;">
            ${w.isPR ? '<span class="mh-session-pr"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:2px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"/></svg> PR</span>' : ''}
            <span class="mh-session-vol">Vol: ${vol}${unit}</span>
          </div>
        </div>
        <div class="mh-set-header">
          <span class="mh-set-label">SET</span>
          <span class="mh-set-label">REPS</span>
          <span class="mh-set-label">WEIGHT</span>
          <span class="mh-set-label">VOL</span>
        </div>
        <div class="mh-sets-table">`;
      w.sets.forEach((s, i) => {
        const setVol = Math.round(s.reps * s.weight);
        html += `<div class="mh-set-row">
          <div class="mh-set-num">${i+1}</div>
          <div class="mh-set-val">${s.reps} <span style="color:var(--text3);font-size:9px;">reps</span></div>
          <div class="mh-set-val">${s.weight} <span style="color:var(--text3);font-size:9px;">${s.unit}</span></div>
          <div class="mh-set-val">${setVol} <span style="color:var(--text3);font-size:9px;">${s.unit}</span></div>
        </div>`;
      });
      html += `</div>`;
      if (w.notes) html += `<div class="mh-session-notes">${w.notes}</div>`;
      html += `</div>`;
    });

    if (total > 3) {
      html += `<button class="mh-load-more" data-exname="${exName.replace(/"/g,'&quot;')}" onclick="mhShowAll(this)">â–¼ SHOW ALL ${total} SESSIONS</button>`;
    }

    html += `</div></div>`;
  });

  body.innerHTML = html;
  panel.style.display = 'block';

  // Smooth scroll to the panel
  setTimeout(() => panel.scrollIntoView({ behavior:'smooth', block:'nearest' }), 80);
}

function mhShowAll(btn) {
  const exName = btn.dataset.exname;
  const exSessions = [...workouts]
    .filter(w => w.exercise === exName)
    .sort((a,b) => new Date(b.date) - new Date(a.date));

  const container = document.getElementById('mh-ex-' + CSS.escape(exName));
  if (!container) return;

  let html = '';
  exSessions.forEach(w => {
    const dateStr = new Date(w.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short', year:'numeric'});
    const vol = Math.round(w.totalVolume);
    const unit = w.sets[0]?.unit || 'kg';
    html += `<div class="mh-session">
      <div class="mh-session-header">
        <span class="mh-session-date"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:3px;opacity:.7;"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${dateStr}</span>
        <div style="display:flex;align-items:center;gap:8px;">
          ${w.isPR ? '<span class="mh-session-pr"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:2px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"/></svg> PR</span>' : ''}
          <span class="mh-session-vol">Vol: ${vol}${unit}</span>
        </div>
      </div>
      <div class="mh-set-header">
        <span class="mh-set-label">SET</span>
        <span class="mh-set-label">REPS</span>
        <span class="mh-set-label">WEIGHT</span>
        <span class="mh-set-label">VOL</span>
      </div>
      <div class="mh-sets-table">`;
    w.sets.forEach((s, i) => {
      const setVol = Math.round(s.reps * s.weight);
      html += `<div class="mh-set-row">
        <div class="mh-set-num">${i+1}</div>
        <div class="mh-set-val">${s.reps} <span style="color:var(--text3);font-size:9px;">reps</span></div>
        <div class="mh-set-val">${s.weight} <span style="color:var(--text3);font-size:9px;">${s.unit}</span></div>
        <div class="mh-set-val">${setVol} <span style="color:var(--text3);font-size:9px;">${s.unit}</span></div>
      </div>`;
    });
    html += `</div>`;
    if (w.notes) html += `<div class="mh-session-notes">${w.notes}</div>`;
    html += `</div>`;
  });

  // Replace container contents + remove load-more button
  container.innerHTML = html;
  const moreBtn = container.parentElement.querySelector('.mh-load-more');
  if (moreBtn) moreBtn.remove();
}

function setBodyView(view) {
  document.getElementById('body-front').style.display = view === 'front' ? '' : 'none';
  document.getElementById('body-back').style.display  = view === 'back'  ? '' : 'none';
  document.getElementById('view-front-btn').classList.toggle('active', view === 'front');
  document.getElementById('view-back-btn').classList.toggle('active', view === 'back');
  // Re-apply selection highlight on new view
  if (selectedMuscle) {
    document.querySelectorAll('.body-zone').forEach(z => {
      z.classList.toggle('zone-selected', z.dataset.muscle === selectedMuscle);
    });
  }
}

// SVG zone clicks are wired in the main DOMContentLoaded below

// SVG icon helpers for tips (inline, theme-aware via currentColor)
const _TI = p => `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${p}</svg>`;
const TIPS = {
  Chest:[
    {icon:_TI('<path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/>'),title:'Mind-Muscle Connection',text:'Focus on squeezing your chest, not just moving the weight. Control every rep.'},
    {icon:_TI('<polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>'),title:'Angle Variety',text:'Mix flat, incline, and decline to hit all pec regions effectively.'},
    {icon:_TI('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'),title:'Tempo Training',text:'Try a 3-second lowering phase to maximise chest muscle tension and growth.'},
    {icon:_TI('<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>'),title:'Grip Width',text:'A slightly wider grip on bench press increases the chest stretch at the bottom.'}
  ],
  Back:[
    {icon:_TI('<path d="M4 6c0 0 2-2 8-2s8 2 8 2"/><path d="M4 12c0 0 2 2 8 2s8-2 8-2"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="7" y1="8" x2="7" y2="16"/><line x1="17" y1="8" x2="17" y2="16"/>'),title:'Drive Elbows Down',text:'Think elbows to back pockets, not pulling with your hands, for max lat activation.'},
    {icon:_TI('<path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10"/><path d="M12 8v4l3 3"/>'),title:'Scapular Control',text:'Retract and depress shoulder blades before every pull for maximum engagement.'},
    {icon:_TI('<path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/>'),title:'Deadlift for Thickness',text:'Deadlifts remain the king for overall back thickness and density.'},
    {icon:_TI('<line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>'),title:'Full Stretch',text:'Allow full arm extension at the top of rows and pulldowns for complete ROM.'}
  ],
  Shoulders:[
    {icon:_TI('<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'),title:'Lateral Raise Form',text:'Lead with your pinky, raise to shoulder height only. Strict form beats heavy weight.'},
    {icon:_TI('<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>'),title:'Hit All Three Heads',text:'Overhead press (front), lateral raises (side), face pulls (rear) every session.'},
    {icon:_TI('<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'),title:'Warm Up First',text:'Band pull-aparts before heavy shoulder work protect your rotator cuff.'},
    {icon:_TI('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'),title:'Slow & Controlled',text:'Shoulder isolation exercises work better with lighter weight and strict tempo.'}
  ],
  Legs:[
    {icon:_TI('<path d="M8 3c0 0 1 2 1 5s-2 6-2 9c0 1.5.5 3 2 4"/><path d="M16 3c0 0-1 2-1 5s2 6 2 9c0 1.5-.5 3-2 4"/><path d="M9 16c1 1.5 3 2 5 1"/>'),title:'Full Depth Squats',text:'Squat to at least parallel. Full depth activates more muscle fibres and builds patterns.'},
    {icon:_TI('<path d="M12 22V12"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/><circle cx="12" cy="5" r="3"/>'),title:'Knee Tracking',text:'Keep knees over your toes. Never let them cave inward under load.'},
    {icon:_TI('<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>'),title:'Hit Hamstrings Too',text:'Include Romanian deadlifts or leg curls. Quad-hamstring balance prevents injury.'},
    {icon:_TI('<circle cx="12" cy="5" r="2"/><path d="M12 7v6"/><path d="M9 10l-2 4h10l-2-4"/><path d="M10 17l-1 4M14 17l1 4"/>'),title:'Foot Position',text:'Wider stance hits adductors. Shoulder-width targets quads more directly.'}
  ],
  Biceps:[
    {icon:_TI('<path d="M6 16c0-4 2-8 6-8s6 4 6 8"/><path d="M6 16h12"/><path d="M9 10l-2-4M15 10l2-4"/>'),title:'Supinate at the Top',text:'Rotate your wrist outward as you curl to fully contract the bicep peak.'},
    {icon:_TI('<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>'),title:'Lock Your Elbows',text:'Keep elbows pinned at your sides. Swinging reduces bicep engagement significantly.'},
    {icon:_TI('<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/>'),title:'Full Extension',text:'Lower the weight all the way for maximum stretch and fibre recruitment.'},
    {icon:_TI('<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>'),title:'Grip Variety',text:'Alternate wide, narrow, and hammer grips for complete bicep development.'}
  ],
  Triceps:[
    {icon:_TI('<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>'),title:'Overhead for Long Head',text:'Overhead extensions put the tricep in its longest position for maximum growth.'},
    {icon:_TI('<line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>'),title:'Lock Out Fully',text:'Fully extend your elbow on every rep to activate all three tricep heads.'},
    {icon:_TI('<path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>'),title:'Volume Balance',text:'Triceps are 2/3 of arm size. Train them as hard as your biceps.'},
    {icon:_TI('<path d="M6 5v14M18 5v14"/><path d="M2 9h4M18 9h4M2 15h4M18 15h4"/><rect x="6" y="8" width="12" height="8" rx="1"/>'),title:'Close Grip Bench',text:'Close grip bench press is the most effective mass-builder for triceps.'}
  ],
  Core:[
    {icon:_TI('<path d="M12 2c0 0-7 6.5-7 12a7 7 0 0 0 14 0c0-5.5-7-12-7-12z"/><path d="M9.5 14.5c.5 1.5 2.5 2.5 4 1.5"/>'),title:'Brace, Don\'t Suck In',text:'Push your abs outward against imaginary resistance. Bracing is stronger than drawing in.'},
    {icon:_TI('<polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.51"/>'),title:'Anti-Rotation Work',text:'Pallof presses and suitcase carries build real-world core stability.'},
    {icon:_TI('<rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>'),title:'Compounds Build Core',text:'Heavy squats and deadlifts build core strength more than crunches alone.'},
    {icon:_TI('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'),title:'Time Under Tension',text:'Slow planks and slow leg raises build endurance and strength simultaneously.'}
  ],
  Glutes:[
    {icon:_TI('<path d="M6 14c0-4 2-7 6-7s6 3 6 7c0 3-2 5-6 5s-6-2-6-5z"/><path d="M12 7V4"/>'),title:'Hip Thrust Priority',text:'Hip thrusts are the #1 glute builder. Prioritise them every glute session.'},
    {icon:_TI('<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>'),title:'Squeeze at the Top',text:'Hold the contracted position for 1â€“2 seconds on every hip thrust rep.'},
    {icon:_TI('<circle cx="12" cy="5" r="2"/><path d="M12 7v6"/><path d="M9 10l-2 4h10l-2-4"/><path d="M10 17l-1 4M14 17l1 4"/>'),title:'Bulgarian Split Squats',text:'BSS heavily loads the glute of the front leg. A must-have in any glute programme.'},
    {icon:_TI('<path d="M8 3c0 0 1 2 1 5s-2 6-2 9c0 1.5.5 3 2 4"/><path d="M16 3c0 0-1 2-1 5s2 6 2 9c0 1.5-.5 3-2 4"/>'),title:'Drive Through Your Heel',text:'During squats and lunges, push through your heels to shift load to glutes.'}
  ],
  Calves:[
    {icon:_TI('<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>'),title:'Full Range of Motion',text:'Go all the way up AND all the way down. Partial reps severely limit development.'},
    {icon:_TI('<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>'),title:'High Reps Work',text:'Calves respond well to 15â€“25 rep ranges due to their fibre composition.'},
    {icon:_TI('<path d="M20 9V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/><path d="M2 9h20"/><path d="M12 9v12"/><path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"/>'),title:'Seated vs Standing',text:'Seated raises hit the soleus (deeper muscle). Include both movements.'},
    {icon:_TI('<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'),title:'Pause at the Bottom',text:'Pause 1â€“2 seconds at the stretched position to maximise growth stimulus.'}
  ]
};

function updateTips() {
  const active = TIPS[selectedMuscle] || [
    {icon:_TI('<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>'),title:'Progressive Overload',text:'Add 2.5â€“5 kg every 2 weeks. Small gains compound into massive results.'},
    {icon:_TI('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'),title:'Use the Rest Timer',text:'Consistent rest periods (60â€“120s) improve performance across sets.'}
  ];
  document.getElementById('tips-container').innerHTML =
    '<div class="tips-list">' +
    active.map(t => `<div class="tip-card"><div class="tip-icon">${t.icon}</div><div><div class="tip-title">${t.title}</div><div class="tip-text">${t.text}</div></div></div>`).join('') +
    '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAST SESSION HINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLastSessionHint() {
  if (!settings.showHint) { document.getElementById('last-session-hint').style.display = 'none'; return; }
  const name = document.getElementById('exercise-name').value.trim();
  if (!name) { document.getElementById('last-session-hint').style.display = 'none'; return; }
  const prev = [...workouts].reverse().find(w => w.exercise.toLowerCase() === name.toLowerCase());
  if (!prev) { document.getElementById('last-session-hint').style.display = 'none'; return; }
  const d = new Date(prev.date).toLocaleDateString('en-GB',{month:'short',day:'numeric'});
  const setsText = prev.sets.map((s,i) => `Set ${i+1}: ${s.reps} reps Ã— ${s.weight}${s.unit}`).join(' &nbsp;|&nbsp; ');
  document.getElementById('last-session-content').innerHTML = `<b>${d}</b> &nbsp; ${setsText}`;
  document.getElementById('last-session-hint').style.display = 'block';
}

function loadLastSessionSets(exerciseName) {
  const prev = [...workouts].reverse().find(w => w.exercise.toLowerCase() === exerciseName.toLowerCase());
  if (!prev || !prev.sets.length) return;
  // Clear existing sets
  document.getElementById('sets-container').innerHTML = '';
  setCount = 0;
  // Re-populate with last session's sets
  prev.sets.forEach(s => {
    setCount++;
    document.getElementById('set-count-badge').textContent = setCount + ' SETS';
    const row = document.createElement('div');
    row.className = 'set-row'; row.id = 'set-' + setCount;
    const unit = s.unit || settings.defaultUnit || 'kg';
    const otherUnit = unit === 'kg' ? 'lbs' : 'kg';
    row.innerHTML = `
      <div class="set-num">${setCount}</div>
      <input type="number" min="0" inputmode="numeric" placeholder="10" class="set-reps" value="${s.reps}">
      <input type="number" min="0" step="0.5" inputmode="decimal" placeholder="60" class="set-weight" value="${s.weight}">
      <select class="set-unit"><option value="${unit}">${unit}</option><option value="${otherUnit}">${otherUnit}</option></select>
      <button class="btn-icon" onclick="removeSet(${setCount})">Ã—</button>
    `;
    document.getElementById('sets-container').appendChild(row);
  });
}

// â”€â”€ Exercise autocomplete + last-session auto-fill â”€â”€
function pickExercise(name) {
  const exInput = document.getElementById('exercise-name');
  exInput.value = name;
  closeAutocomplete();
  updateLastSessionHint();
  // Auto-select muscle from last session if none chosen yet
  if (!selectedMuscle) {
    const prev = [...workouts].reverse().find(w => w.exercise.toLowerCase() === name.toLowerCase());
    if (prev) selectMuscle(prev.muscle);
  }
  // Load last session sets if field is empty
  if (document.querySelectorAll('.set-row').length === 0) {
    loadLastSessionSets(name);
  }
}

function showAutocomplete(query) {
  const ac = document.getElementById('exercise-autocomplete');
  if (!query) { closeAutocomplete(); return; }
  const q = query.toLowerCase();
  // Gather unique exercises with their last-used muscle, sorted by recency
  const seen = new Map();
  [...workouts].reverse().forEach(w => {
    const key = w.exercise.toLowerCase();
    if (!seen.has(key)) seen.set(key, { name: w.exercise, muscle: w.muscle });
  });
  const matches = [...seen.values()].filter(e => e.name.toLowerCase().includes(q)).slice(0, 8);
  if (!matches.length) { closeAutocomplete(); return; }
  ac.innerHTML = matches.map(e =>
    `<div class="ex-ac-item" onmousedown="pickExercise('${e.name.replace(/'/g,"\\'")}')">
       <span>${e.name}</span>
       <span class="ac-muscle">${e.muscle.toUpperCase()}</span>
     </div>`
  ).join('');
  ac.style.display = 'block';
}

function closeAutocomplete() {
  const ac = document.getElementById('exercise-autocomplete');
  if (ac) ac.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
  // Wire SVG zone clicks â†’ open overlay
  document.querySelectorAll('.body-zone').forEach(zone => {
    zone.addEventListener('click', () => selectMuscle(zone.dataset.muscle, false));
  });

  // Swipe-down to close muscle overlay
  const overlay = document.getElementById('muscle-overlay');
  let touchStartY = 0;
  overlay.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; }, {passive:true});
  overlay.addEventListener('touchmove', e => {
    const dy = e.touches[0].clientY - touchStartY;
    if (dy > 0) overlay.style.transform = 'translateY(' + Math.min(dy * 0.5, 120) + 'px)';
  }, {passive:true});
  overlay.addEventListener('touchend', e => {
    const dy = e.changedTouches[0].clientY - touchStartY;
    overlay.style.transform = '';
    if (dy > 80) closeMuscleOverlay();
  }, {passive:true});

  // Keyboard close
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeMuscleOverlay();
  });

  // Exercise name input
  const exInput = document.getElementById('exercise-name');
  if (exInput) {
    exInput.addEventListener('input', () => {
      const name = exInput.value.trim();
      showAutocomplete(name);
      updateLastSessionHint();
    });
    exInput.addEventListener('focus', () => {
      const name = exInput.value.trim();
      if (name) showAutocomplete(name);
    });
    exInput.addEventListener('blur', () => {
      // Small delay so mousedown on item fires first
      setTimeout(() => {
        closeAutocomplete();
        const name = exInput.value.trim();
        if (name) {
          const hasRecord = workouts.some(w => w.exercise.toLowerCase() === name.toLowerCase());
          if (hasRecord && document.querySelectorAll('.set-row').length === 0) {
            loadLastSessionSets(name);
          }
        }
      }, 180);
    });
    exInput.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeAutocomplete();
    });
  }

  // â”€â”€ New feature initialisation â”€â”€
  // Step tracker: render panel (functions defined later in script, use setTimeout to ensure they're ready)
  setTimeout(() => {
    if (typeof renderStepsPanel === 'function') renderStepsPanel();
    if (typeof applyLayout      === 'function') applyLayout();
  }, 0);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSet() {
  setCount++;
  document.getElementById('set-count-badge').textContent = setCount + ' SETS';
  const prevRow = document.querySelector('.set-row:last-child');
  let prevReps = '', prevWeight = '';
  if (prevRow) {
    prevReps   = prevRow.querySelector('.set-reps').value;
    prevWeight = prevRow.querySelector('.set-weight').value;
  }
  const row = document.createElement('div');
  row.className = 'set-row'; row.id = 'set-' + setCount;
  row.innerHTML = `
    <div class="set-num">${setCount}</div>
    <input type="number" min="0" inputmode="numeric" placeholder="10" class="set-reps" value="${prevReps}">
    <input type="number" min="0" step="0.5" inputmode="decimal" placeholder="60" class="set-weight" value="${prevWeight}">
    <select class="set-unit"><option value="${settings.defaultUnit||'kg'}">${settings.defaultUnit||'kg'}</option>${(settings.defaultUnit||'kg')==='kg'?'<option value="lbs">lbs</option>':'<option value="kg">kg</option>'}</select>
    <button class="btn-icon" onclick="removeSet(${setCount})">Ã—</button>
  `;
  document.getElementById('sets-container').appendChild(row);
  row.querySelector('.set-reps').focus();
}

function removeSet(id) {
  const el = document.getElementById('set-' + id);
  if (el) el.remove();
  const rows = document.querySelectorAll('.set-row');
  setCount = rows.length;
  rows.forEach((r,i) => r.querySelector('.set-num').textContent = i+1);
  document.getElementById('set-count-badge').textContent = setCount + ' SETS';
}

// saveWorkout() is defined in the BODYWEIGHT/STEPS block below â€” it dispatches
// to _saveWeightedWorkout() or saveBwWorkout() based on current mode.

// (updateStatBar defined later with full gamification support)

function calcStreak() {
  if (!workouts.length) return 0;
  const days = [...new Set(workouts.map(w => new Date(w.date).toDateString()))].sort((a,b) => new Date(b)-new Date(a));
  let streak = 0, d = new Date();
  for (const day of days) {
    if (new Date(day).toDateString() === d.toDateString()) { streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  return streak;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BODY WEIGHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function logBodyWeight() {
  const val  = parseFloat(document.getElementById('bw-input').value);
  const unit = document.getElementById('bw-unit').value;
  if (!val || val < 20 || val > 500) { showToast('Enter a valid weight!'); return; }
  bodyWeight.push({ date: new Date().toISOString(), weight: val, unit });
  save();
  document.getElementById('bw-input').value = '';
  showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…!' : 'Body weight logged!');
  renderBWChart();
  renderBWHistory();
}

function renderBWChart() {
  if (bwChrt) bwChrt.destroy();
  const ctx  = document.getElementById('bw-chart').getContext('2d');
  const data = [...bodyWeight].slice(-30);
  if (!data.length) return;
  const grad = ctx.createLinearGradient(0,0,0,180);
  grad.addColorStop(0,'rgba(57,255,143,.25)'); grad.addColorStop(1,'rgba(57,255,143,0)');
  bwChrt = new Chart(ctx, {
    type:'line',
    data:{
      labels: data.map(d => new Date(d.date).toLocaleDateString('en-GB',{month:'short',day:'numeric'})),
      datasets:[{
        label:'Body Weight', data: data.map(d => d.weight),
        borderColor:'#39ff8f', borderWidth:2, backgroundColor:grad,
        fill:true, tension:.4, pointBackgroundColor:'#39ff8f', pointRadius:4, pointHoverRadius:7
      }]
    },
    options: mkChartOpts()
  });
}

function renderBWHistory() {
  const list = [...bodyWeight].reverse().slice(0,15);
  const el = document.getElementById('bw-history-list');
  if (!el) return;
  if (!list.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div><div class="empty-title">No entries yet</div></div>';
    return;
  }
  el.innerHTML = '<div style="padding:4px 0;">' + list.map((e,i) => {
    const prev = list[i+1];
    let dc = 'same', dt = '';
    if (prev) {
      const diff = (e.weight - prev.weight).toFixed(1);
      if (diff > 0) { dc = 'up'; dt = '+' + diff; }
      else if (diff < 0) { dc = 'down'; dt = diff; }
      else { dt = 'â€”'; }
    }
    const bfStr = e.bodyFat    ? '<span style="color:#f39c12;"> Â· ' + e.bodyFat + '% BF</span>' : '';
    const mmStr = e.muscleMass ? '<span style="color:var(--green);"> Â· ' + e.muscleMass + 'kg MM</span>' : '';
    return '<div class="bw-row">'
      + '<div class="bw-date">' + new Date(e.date).toLocaleDateString('en-GB',{month:'short',day:'numeric'}) + '</div>'
      + '<div class="bw-val" style="flex:1;">' + e.weight + ' <span style="font-family:\'DM Mono\';font-size:10px;color:var(--text3);">' + e.unit + '</span>' + bfStr + mmStr + '</div>'
      + (prev ? '<div class="bw-delta ' + dc + '">' + dt + '</div>' : '')
      + '</div>';
  }).join('') + '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WATER TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initWater() {
  const grid = document.getElementById('water-grid');
  if (!grid) return;
  grid.innerHTML = '';
  for (let i = 0; i < 8; i++) {
    const cup = document.createElement('div');
    cup.className = 'water-cup' + (waterToday.includes(i) ? ' filled' : '');
    cup.onclick = () => toggleWater(i);
    grid.appendChild(cup);
  }
  document.getElementById('water-badge').textContent = waterToday.length + ' / 8 cups';
}

function toggleWater(i) {
  if (waterToday.includes(i)) waterToday = waterToday.filter(x => x !== i);
  else waterToday.push(i);
  save(); initWater();
  if (waterToday.length === 8) showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ±Ø·ÙŠØ¨!' : 'Daily hydration goal reached!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG icons that inherit currentColor (theme-aware)
const _SVG_PUSH = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4v16M18 4v16M6 12h12"/><circle cx="6" cy="4" r="1.5"/><circle cx="18" cy="4" r="1.5"/><circle cx="6" cy="20" r="1.5"/><circle cx="18" cy="20" r="1.5"/></svg>`;
const _SVG_PULL = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12l7-7 7 7"/></svg>`;
const _SVG_LEGS = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3c0 0 1 2 1 5s-2 6-2 9c0 1.5.5 3 2 4"/><path d="M16 3c0 0-1 2-1 5s2 6 2 9c0 1.5-.5 3-2 4"/><path d="M9 16c1 1.5 3 2 5 1"/></svg>`;
const DEFAULT_TEMPLATES = [
  {id:'t1', name:'Push Day', muscle:'Chest', exercises:'Bench Press, Incline DB Press, Cable Fly', icon:_SVG_PUSH},
  {id:'t2', name:'Pull Day', muscle:'Back',  exercises:'Deadlift, Bent Row, Lat Pulldown',         icon:_SVG_PULL},
  {id:'t3', name:'Leg Day',  muscle:'Legs',  exercises:'Squat, Romanian DL, Leg Press',            icon:_SVG_LEGS}
];

function renderTemplates() {
  const all = [...DEFAULT_TEMPLATES, ...templates];
  const list = document.getElementById('template-list');
  if (!list) return;
  list.innerHTML = all.map(t => `
    <button class="template-btn" onclick="loadTemplate('${t.id}','${t.muscle}','${t.exercises.split(',')[0].trim()}')">
      <div class="template-icon">${t.icon}</div>
      <div>
        <div class="template-name">${t.name}</div>
        <div class="template-sub">${t.exercises}</div>
      </div>
    </button>`).join('');
}

function loadTemplate(id, muscle, exercise) {
  const tmpl = [...DEFAULT_TEMPLATES, ...templates].find(t => t.id === id);
  if (!tmpl) return;
  selectMuscle(tmpl.muscle);
  document.getElementById('exercise-name').value = exercise;
  updateLastSessionHint();
  if (document.querySelectorAll('.set-row').length === 0) loadLastSessionSets(exercise);
  showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨!' : 'Template loaded!');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function openTemplateModal() {
  document.getElementById('template-modal').classList.add('open');
}
function closeTemplateModal(e) {
  if (e.target === e.currentTarget) document.getElementById('template-modal').classList.remove('open');
}
function saveTemplate() {
  const name = document.getElementById('tmpl-name').value.trim();
  const muscle = document.getElementById('tmpl-muscle').value;
  const exercises = document.getElementById('tmpl-exercises').value.trim();
  const icon = document.getElementById('tmpl-icon').value.trim() || 'ğŸ’ª';
  if (!name || !exercises) { showToast('Fill in name and exercises!'); return; }
  templates.push({ id: 't' + Date.now(), name, muscle, exercises, icon });
  save(); renderMyTemplates(); renderTemplates();
  document.getElementById('template-modal').classList.remove('open');
  showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨!' : 'Template saved!');
}

function renderMyTemplates() {
  const el = document.getElementById('my-templates-list');
  if (!el) return;
  if (!templates.length) { el.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></div><div class="empty-title">No custom templates</div><div class="empty-sub">Create one above</div></div>'; return; }
  el.innerHTML = templates.map(t => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:20px;">${t.icon}</span>
        <div>
          <div style="font-family:'Barlow Condensed';font-size:14px;font-weight:700;color:var(--white);">${t.name}</div>
          <div style="font-family:'DM Mono';font-size:10px;color:var(--text3);">${t.exercises}</div>
        </div>
      </div>
      <button class="btn-icon" onclick="deleteTemplate('${t.id}')">Ã—</button>
    </div>`).join('');
}

function deleteTemplate(id) {
  templates = templates.filter(t => t.id !== id);
  save(); renderMyTemplates(); renderTemplates();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  // â”€â”€ Weighted lifting stats â”€â”€
  const totalVol  = workouts.reduce((a,w) => a + w.totalVolume, 0);
  const totalSets = workouts.reduce((a,w) => a + w.sets.length, 0);
  let prVal = 0, prEx = 'â€”';
  workouts.forEach(w => w.sets.forEach(s => { if (s.weight > prVal) { prVal = s.weight; prEx = w.exercise; } }));

  document.getElementById('dash-total-vol').innerHTML  = Math.round(totalVol) + '<span class="stat-unit">kg</span>';
  document.getElementById('dash-sessions').textContent = workouts.length;
  document.getElementById('dash-sets').textContent     = totalSets;
  document.getElementById('dash-pr').innerHTML         = prVal + '<span class="stat-unit">kg</span>';
  document.getElementById('dash-pr-exercise').textContent = prEx !== 'â€”' ? 'â†‘ ' + prEx : 'â€”';

  // â”€â”€ Bodyweight workout stats â”€â”€
  const bwAll = typeof bwWorkouts !== 'undefined' ? bwWorkouts : [];
  const bwSessions = bwAll.length;
  const bwSets = bwAll.reduce((a,w) => a + (w.sets ? w.sets.length : 0), 0);

  // top BW exercise by frequency
  const bwExCounts = {};
  bwAll.forEach(w => { bwExCounts[w.exercise] = (bwExCounts[w.exercise]||0) + (w.sets ? w.sets.length : 1); });
  const bwTopEntries = Object.entries(bwExCounts).sort((a,b) => b[1]-a[1]);
  const bwTopEx  = bwTopEntries[0]?.[0] || 'â€”';
  const bwTopCnt = bwTopEntries[0]?.[1] || 0;

  // BW streak (consecutive days with a BW workout)
  const bwDays = [...new Set(bwAll.map(w => w.date ? w.date.slice(0,10) : ''))].filter(Boolean).sort();
  let bwStreak = 0;
  if (bwDays.length) {
    bwStreak = 1;
    const today = new Date().toISOString().slice(0,10);
    let cur = new Date(bwDays[bwDays.length-1]);
    for (let i = bwDays.length-2; i >= 0; i--) {
      const prev2 = new Date(bwDays[i]);
      const diff  = Math.round((cur - prev2) / 86400000);
      if (diff === 1) { bwStreak++; cur = prev2; } else break;
    }
    // reset if last session not today or yesterday
    const lastDay = bwDays[bwDays.length-1];
    const diffToday = Math.round((new Date(today) - new Date(lastDay)) / 86400000);
    if (diffToday > 1) bwStreak = 0;
  }

  const elBwSess   = document.getElementById('dash-bw-sessions');
  const elBwSets   = document.getElementById('dash-bw-sets');
  const elBwTopEx  = document.getElementById('dash-bw-top-ex');
  const elBwTopCnt = document.getElementById('dash-bw-top-ex-sets');
  const elBwStreak = document.getElementById('dash-bw-streak');
  const elBwStUnit = document.getElementById('dash-bw-streak-unit');
  const _ar = typeof currentLang !== 'undefined' && currentLang === 'ar';

  if (elBwSess)   elBwSess.textContent   = bwSessions;
  if (elBwSets)   elBwSets.textContent   = bwSets;
  if (elBwTopEx)  elBwTopEx.textContent  = bwTopEx !== 'â€”' ? bwTopEx : 'â€”';
  if (elBwTopCnt) elBwTopCnt.textContent = bwTopCnt ? bwTopCnt + (_ar ? ' Ù…Ø¬Ù…ÙˆØ¹Ø©' : ' sets') : 'â€”';
  if (elBwStreak) elBwStreak.textContent = bwStreak;
  if (elBwStUnit) elBwStUnit.textContent = _ar ? 'Ø£ÙŠØ§Ù…' : 'days';

  renderVolumeChart(buildWeeklyVolume());
  renderMuscleVol();
  renderFreqChart();
  populateExerciseSelect();
  renderBcompChart(currentBcompChart);
  renderCompCards();
  initWater();
}

function buildWeeklyVolume() {
  const weeks = {};
  workouts.forEach(w => {
    const d = new Date(w.date), jan1 = new Date(d.getFullYear(),0,1);
    const wk = Math.ceil(((d-jan1)/86400000 + jan1.getDay()+1)/7);
    const key = d.getFullYear() + '-W' + String(wk).padStart(2,'0');
    weeks[key] = (weeks[key]||0) + w.totalVolume;
  });
  const s = Object.keys(weeks).sort();
  return { labels: s, data: s.map(k => Math.round(weeks[k])) };
}

function renderVolumeChart(d) {
  if (volChart) volChart.destroy();
  const ctx = document.getElementById('volume-chart').getContext('2d');
  const grad = ctx.createLinearGradient(0,0,0,220);
  grad.addColorStop(0,'rgba(46,204,113,.35)'); grad.addColorStop(1,'rgba(46,204,113,0)');
  volChart = new Chart(ctx, {
    type:'line',
    data:{
      labels: d.labels.length ? d.labels : ['No data'],
      datasets:[{
        label:'Volume', data: d.data.length ? d.data : [0],
        borderColor:'#2ecc71', borderWidth:2.5, backgroundColor:grad,
        fill:true, tension:.4, pointBackgroundColor:'#39ff8f',
        pointBorderColor:'#080c09', pointRadius:4, pointHoverRadius:8
      }]
    },
    options: mkChartOpts()
  });
}

function renderMuscleVol() {
  const totals = {};
  workouts.forEach(w => { totals[w.muscle] = (totals[w.muscle]||0) + w.totalVolume; });
  const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
  const maxVol = sorted[0]?.[1] || 1;
  if (!sorted.length) {
    document.getElementById('vol-list').innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div><div class="empty-title">No data yet</div></div>';
    return;
  }
  document.getElementById('vol-list').innerHTML = sorted.map(([m,v]) => `
    <div class="vol-item">
      <div class="vol-row"><span class="vol-name">${MUSCLE_ICONS[m]||MUSCLE_ICONS['Chest']} ${m}</span><span class="vol-val">${Math.round(v)} kg</span></div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill" style="width:${(v/maxVol*100).toFixed(1)}%"></div></div>
    </div>`).join('');
}

function renderFreqChart() {
  const counts = {};
  workouts.forEach(w => { counts[w.muscle] = (counts[w.muscle]||0)+1; });
  const labels = Object.keys(counts), data = labels.map(k => counts[k]);
  if (freqChrt) freqChrt.destroy();
  const ctx = document.getElementById('freq-chart').getContext('2d');
  const MUSCLE_COLORS = {
    Chest:     '#2ecc71',
    Back:      '#3498db',
    Shoulders: '#9b59b6',
    Biceps:    '#e67e22',
    Triceps:   '#e74c3c',
    Legs:      '#f1c40f',
    Core:      '#1abc9c',
    Glutes:    '#e91e8c',
    Calves:    '#00bcd4'
  };
  const bgColors = labels.map(l => MUSCLE_COLORS[l] || '#7f8c8d');
  freqChrt = new Chart(ctx, {
    type:'doughnut',
    data:{ labels, datasets:[{data, backgroundColor: bgColors, borderColor:'#0d1410', borderWidth:2}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{position:'bottom', labels:{color:'#7a9e7e', font:{family:'DM Mono',size:10}, padding:8}},
        tooltip:{backgroundColor:'#0d1410', borderColor:'#1e2e1f', borderWidth:1, titleColor:'#2ecc71', bodyColor:'#7a9e7e',
          callbacks:{label: c => ' ' + c.label + ': ' + c.raw + ' sessions'}}
      }
    }
  });
}

function populateExerciseSelect() {
  const exercises = [...new Set(workouts.map(w => w.exercise))];
  const sel = document.getElementById('exercise-select');
  sel.innerHTML = '<option value="">â€” Select exercise â€”</option>';
  exercises.forEach(e => { const o = document.createElement('option'); o.value=e; o.textContent=e; sel.appendChild(o); });
}

function updateWeightChart() {
  const ex = document.getElementById('exercise-select').value;
  if (wgtChart) wgtChart.destroy();
  if (!ex) return;
  const data = workouts.filter(w => w.exercise === ex)
    .map(w => ({ date: new Date(w.date).toLocaleDateString('en-GB',{month:'short',day:'numeric'}), max: Math.max(...w.sets.map(s=>s.weight)) }));
  const ctx  = document.getElementById('weight-chart').getContext('2d');
  const grad = ctx.createLinearGradient(0,0,0,220);
  grad.addColorStop(0,'rgba(57,255,143,.25)'); grad.addColorStop(1,'rgba(57,255,143,0)');
  wgtChart = new Chart(ctx, {
    type:'line',
    data:{ labels:data.map(d=>d.date), datasets:[{label:'Max Weight', data:data.map(d=>d.max), borderColor:'#39ff8f', borderWidth:2.5, backgroundColor:grad, fill:true, tension:.3, pointBackgroundColor:'#39ff8f', pointBorderColor:'#080c09', pointRadius:5, pointHoverRadius:9}] },
    options: mkChartOpts()
  });
}

function mkChartOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    animation:{duration:600, easing:'easeInOutQuart'},
    plugins:{legend:{display:false}, tooltip:{backgroundColor:'#0d1410', borderColor:'#1e2e1f', borderWidth:1, titleColor:'#2ecc71', bodyColor:'#7a9e7e', callbacks:{label:c=>' '+c.raw}}},
    scales:{
      x:{grid:{color:'#1e2e1f'}, ticks:{color:'#4a6a4e', font:{family:'DM Mono',size:9}, maxTicksLimit:6}},
      y:{grid:{color:'#1e2e1f'}, ticks:{color:'#4a6a4e', font:{family:'DM Mono',size:9}}, beginAtZero:true}
    }
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory() {
  const fm = document.getElementById('filter-muscle').value;
  const fe = document.getElementById('filter-exercise').value.toLowerCase();
  const so = document.getElementById('filter-sort').value;

  // Merge weighted + bodyweight workouts into one unified list
  const bwAll = (typeof bwWorkouts !== 'undefined' ? bwWorkouts : []).map(w => ({...w, type:'bodyweight'}));
  let filteredWgt = workouts.filter(w => (!fm || w.muscle===fm) && (!fe || w.exercise.toLowerCase().includes(fe)));
  let filteredBw  = bwAll.filter(w => (!fm || w.muscle===fm) && (!fe || w.exercise.toLowerCase().includes(fe)));
  let filtered = [...filteredWgt, ...filteredBw];

  if (so === 'date-desc' || so === 'vol-desc') filtered.sort((a,b) => new Date(b.date)-new Date(a.date));
  if (so === 'date-asc')  filtered.sort((a,b) => new Date(a.date)-new Date(b.date));

  const tFn = (typeof t === 'function') ? t : (k => k);
  const lang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const dateLoc = lang === 'ar' ? 'ar-SA' : 'en-GB';
  document.getElementById('hist-count-badge').textContent = filtered.length + (lang==='ar' ? ' Ø¥Ø¯Ø®Ø§Ù„' : ' ENTRIES');
  if (!filtered.length) {
    document.getElementById('history-list').innerHTML = `<div class="empty-state"><div class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div><div class="empty-title">${tFn('history.empty')}</div><div style="font-size:12px;color:var(--text3);margin-top:4px;">${tFn('history.emptyHint')}</div></div>`;
    return;
  }
  document.getElementById('history-list').innerHTML = filtered.map(w => {
    const d = new Date(w.date);
    const dateStr = d.toLocaleDateString(dateLoc,{weekday:'short',month:'short',day:'numeric'});
    const isBW = w.type === 'bodyweight';

    if (isBW) {
      // Bodyweight card
      const totalReps = w.totalReps || w.sets.reduce((a,s)=>a+(s.r||s.reps||0),0);
      const maxReps   = Math.max(...(w.sets||[]).map(s=>s.r||s.reps||0));
      const effortColorMap = {easy:'#3a9e6a',medium:'#f39c12',hard:'#e74c3c',failure:'#888'};
      const effortIcons = [...new Set((w.sets||[]).map(s=>effortColorMap[(s.e||s.effort||'').toLowerCase()]).filter(Boolean))].map(c=>`<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${c};margin:1px;"></span>`).join('');
      const bdrDir = lang==='ar' ? 'border-right' : 'border-left';
      return `<div class="hist-item" style="${bdrDir}:3px solid #3a9e6a;">
        <div class="hist-muscle-badge">${MUSCLE_ICONS[w.muscle]||MUSCLE_ICONS['Chest']}</div>
        <div class="hist-info">
          <div class="hist-name">${w.exercise}${w.isPR?' <span class="pr-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:2px;"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg> '+tFn('history.pr')+'</span>':''} <span style="font-size:9px;color:var(--text3);font-family:'DM Mono'">BW</span></div>
          <div class="hist-meta">${w.muscle||tFn('bw.title')} Â· ${dateStr}${w.notes?' Â· '+w.notes:''}</div>
        </div>
        <div class="hist-stats">
          <div><div class="hist-stat-val">${(w.sets||[]).length}</div><div class="hist-stat-lbl">${tFn('history.sets')}</div></div>
          <div><div class="hist-stat-val">${totalReps}</div><div class="hist-stat-lbl">${tFn('history.reps')}</div></div>
          <div style="font-size:14px;">${effortIcons}</div>
        </div>
      </div>`;
    }

    // Weighted card
    const maxW = Math.max(...w.sets.map(s=>s.weight));
    const prev = workouts.filter(x => x.exercise===w.exercise && new Date(x.date)<new Date(w.date));
    let trendArrow='', trendClass='same';
    if (prev.length) {
      const pm = Math.max(...prev[prev.length-1].sets.map(s=>s.weight));
      if (maxW>pm) { trendArrow='â†‘'; trendClass='up'; }
      else if (maxW<pm) { trendArrow='â†“'; trendClass='down'; }
      else { trendArrow='â†’'; trendClass='same'; }
    }
    return `<div class="hist-item">
      <div class="hist-muscle-badge">${MUSCLE_ICONS[w.muscle]||MUSCLE_ICONS['Chest']}</div>
      <div class="hist-info">
        <div class="hist-name">${w.exercise}${w.isPR?' <span class="pr-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:2px;"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg> '+tFn('history.pr')+'</span>':''}</div>
        <div class="hist-meta">${w.muscle} Â· ${dateStr}${w.notes?' Â· '+w.notes:''}</div>
      </div>
      <div class="hist-stats">
        <div><div class="hist-stat-val">${w.sets.length}</div><div class="hist-stat-lbl">${tFn('history.sets')}</div></div>
        <div><div class="hist-stat-val">${maxW}</div><div class="hist-stat-lbl">Max ${tFn('lbl.kg')}</div></div>
        ${trendArrow?`<div class="trend-arrow ${trendClass}">${trendArrow}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function renderPRs() {
  // Weighted PRs (best weight per exercise)
  const prs = {};
  workouts.forEach(w => { w.sets.forEach(s => { if (!prs[w.exercise]||s.weight>prs[w.exercise].weight) prs[w.exercise]={weight:s.weight,muscle:w.muscle,type:'weighted'}; }); });
  const sorted = Object.entries(prs).sort((a,b) => b[1].weight-a[1].weight);

  // Bodyweight PRs (best rep count per exercise)
  const bwPrs = {};
  (typeof bwWorkouts !== 'undefined' ? bwWorkouts : []).forEach(w => {
    const maxR = Math.max(...(w.sets||[]).map(s=>s.r||s.reps||0));
    if (!bwPrs[w.exercise] || maxR > bwPrs[w.exercise].reps) bwPrs[w.exercise] = {reps:maxR, muscle:w.muscle||'Bodyweight'};
  });
  const bwSorted = Object.entries(bwPrs).sort((a,b) => b[1].reps-a[1].reps);

  const hasPRs = sorted.length || bwSorted.length;
  const tFnPR = (typeof t === 'function') ? t : (k => k);
  const langPR = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  if (!hasPRs) { document.getElementById('pr-list').innerHTML=`<div class="empty-state"><div class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg></div><div class="empty-title">${tFnPR('prs.empty')}</div><div style="font-size:12px;color:var(--text3);margin-top:4px;">${tFnPR('prs.emptyHint')}</div></div>`; return; }

  const wgtHTML = sorted.map(([ex,pr],i) => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-family:'Bebas Neue';font-size:18px;color:${i===0?'#f39c12':'var(--green)'};width:20px;text-align:center;">${i===0?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg>`:i+1}</div>
        <div>
          <div style="font-family:'Barlow Condensed';font-size:14px;font-weight:700;color:var(--white);">${ex}</div>
          <div style="font-family:'DM Mono';font-size:9px;color:var(--text3);">${pr.muscle}</div>
        </div>
      </div>
      <div style="font-family:'Bebas Neue';font-size:24px;color:var(--green);">${pr.weight}<span style="font-size:12px;color:var(--text3);"> ${tFnPR('lbl.kg')}</span></div>
    </div>`).join('');

  const bwHTML = bwSorted.length ? `
    <div style="font-family:'Barlow Condensed',Cairo,sans-serif;font-size:11px;letter-spacing:2px;color:var(--text3);padding:10px 0 4px;">${tFnPR('prs.bodyweight')}</div>
    ` + bwSorted.map(([ex,pr],i) => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-family:'Bebas Neue';font-size:18px;color:${i===0?'#3a9e6a':'var(--green)'};width:20px;text-align:center;">${i===0?`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3a9e6a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 4 18 9"/><path d="M6 9v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9"/><line x1="12" y1="4" x2="12" y2="14"/></svg>`:i+1}</div>
        <div>
          <div style="font-family:'Barlow Condensed';font-size:14px;font-weight:700;color:var(--white);">${ex}</div>
          <div style="font-family:'DM Mono';font-size:9px;color:var(--text3);">${pr.muscle}</div>
        </div>
      </div>
      <div style="font-family:'Bebas Neue';font-size:24px;color:#3a9e6a;">${pr.reps}<span style="font-size:12px;color:var(--text3);"> ${tFnPR('prs.reps')}</span></div>
    </div>`).join('') : '';

  document.getElementById('pr-list').innerHTML =
    (sorted.length ? `<div style="font-family:'Barlow Condensed',Cairo,sans-serif;font-size:11px;letter-spacing:2px;color:var(--text3);padding:4px 0 4px;">${tFnPR('prs.weighted')}</div>` + wgtHTML : '') +
    bwHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSetting(key, val) {
  settings[key] = val; save();
}
function loadSettings() {
  const du = document.getElementById('default-unit-setting');
  const ss = document.getElementById('sound-setting');
  const hs = document.getElementById('hint-setting');
  if (du) du.value = settings.defaultUnit || 'kg';
  if (ss) ss.checked = settings.sound !== false;
  if (hs) hs.checked = settings.showHint !== false;
  // Sync light mode toggle
  const lmt = document.getElementById('light-mode-toggle');
  if (lmt) lmt.checked = currentTheme === 'solar';
  renderThemePicker();
}

function toggleLightMode(on) {
  applyTheme(on ? 'solar' : 'forge', '');
  // Keep toggle in sync after theme picker may re-render
  setTimeout(() => {
    const lmt = document.getElementById('light-mode-toggle');
    if (lmt) lmt.checked = currentTheme === 'solar';
  }, 100);
  const _ar = typeof currentLang !== 'undefined' && currentLang === 'ar';
  showToast(on
    ? (_ar ? 'ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø± Ù…ÙØ¹Ù‘Ù„' : 'Light mode on â€” SOLAR theme applied')
    : (_ar ? 'ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ Ù…ÙØ¹Ù‘Ù„' : 'Dark mode restored'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  if (!workouts.length) { showToast('No workouts to export!'); return; }
  let csv = 'Date,Muscle,Exercise,Set,Reps,Weight,Unit,Notes\n';
  workouts.forEach(w => {
    w.sets.forEach((s,i) => {
      csv += `"${new Date(w.date).toLocaleDateString()}","${w.muscle}","${w.exercise}",${i+1},${s.reps},${s.weight},${s.unit},"${w.notes||''}"\n`;
    });
  });
  download('FORGE_workouts.csv', csv, 'text/csv');
  showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±!' : 'CSV exported!');
}

function exportJSON() {
  const data = { workouts, bodyWeight, templates, settings, exportDate: new Date().toISOString() };
  download('FORGE_backup.json', JSON.stringify(data, null, 2), 'application/json');
  showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!' : 'Backup downloaded!');
}

function importJSON(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.workouts)   workouts    = data.workouts;
      if (data.bodyWeight) bodyWeight  = data.bodyWeight;
      if (data.templates)  templates   = data.templates;
      if (data.settings)   settings    = data.settings;
      save(); updateStatBar(); postSaveHooks(); showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!' : 'Backup restored!');
    } catch(err) { showToast('Invalid backup file!'); }
  };
  reader.readAsText(file);
}

function download(filename, content, mime) {
  const a = document.createElement('a');
  a.href = 'data:' + mime + ';charset=utf-8,' + encodeURIComponent(content);
  a.download = filename; a.click();
}

function confirmClear() {
  if (!confirm('Delete ALL workout data? This cannot be undone.')) return;
  workouts = []; bodyWeight = []; waterToday = [];
  save(); updateStatBar(); postSaveHooks(); showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'All data cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, color) {
  const toastEl = document.getElementById('toast');
  if (!toastEl) return;
  toastEl.textContent = msg;
  toastEl.style.background = color || '';
  toastEl.style.color = color ? '#fff' : '';
  toastEl.classList.add('show');
  setTimeout(() => toastEl.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XP & LEVEL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LEVELS = [
  { min:0,    max:100,  name:'ROOKIE',      nameAr:'Ù…Ø¨ØªØ¯Ø¦',      icon:'ğŸŒ±', color:'#4a6a4e' },
  { min:100,  max:250,  name:'IRON',        nameAr:'Ø­Ø¯ÙŠØ¯',       icon:'ğŸ”©', color:'#7f8c8d' },
  { min:250,  max:500,  name:'BRONZE',      nameAr:'Ø¨Ø±ÙˆÙ†Ø²',      icon:'ğŸ¥‰', color:'#cd7f32' },
  { min:500,  max:900,  name:'SILVER',      nameAr:'ÙØ¶Ø©',        icon:'ğŸ¥ˆ', color:'#bdc3c7' },
  { min:900,  max:1500, name:'GOLD',        nameAr:'Ø°Ù‡Ø¨',        icon:'ğŸ¥‡', color:'#f39c12' },
  { min:1500, max:2500, name:'PLATINUM',    nameAr:'Ø¨Ù„Ø§ØªÙŠÙ†',     icon:'ğŸ’', color:'#1abc9c' },
  { min:2500, max:4000, name:'DIAMOND',     nameAr:'Ø£Ù„Ù…Ø§Ø³',      icon:'ğŸ’ ', color:'#3498db' },
  { min:4000, max:6000, name:'MASTER',      nameAr:'Ø£Ø³ØªØ§Ø°',      icon:'âš¡', color:'#9b59b6' },
  { min:6000, max:9000, name:'GRANDMASTER', nameAr:'Ø³ÙŠØ¯ ÙƒØ¨ÙŠØ±',   icon:'ğŸ”¥', color:'#e74c3c' },
  { min:9000, max:Infinity, name:'LEGEND',  nameAr:'Ø£Ø³Ø·ÙˆØ±Ø©',     icon:'ğŸ‘‘', color:'#f39c12' }
];

function calcXP() {
  let xp = 0;
  xp += workouts.length * 10;                                         // 10 XP per workout
  xp += workouts.filter(w => w.isPR).length * 25;                    // 25 XP per PR
  xp += Math.floor(workouts.reduce((a,w) => a+w.totalVolume,0)/1000);// 1 XP per 1000kg lifted
  xp += calcStreak() * 5;                                             // 5 XP per streak day
  xp += workouts.reduce((a,w) => a + w.sets.length, 0) * 2;          // 2 XP per set
  // BW workouts XP (inlined â€” no override needed)
  xp += (typeof bwWorkouts !== 'undefined' ? bwWorkouts : []).length * 8;
  xp += (typeof bwWorkouts !== 'undefined' ? bwWorkouts : []).filter(w => w.isPR).length * 20;
  // Steps XP (inlined)
  if (typeof calcStepXP === 'function') xp += calcStepXP();
  return xp;
}

function getCurrentLevel(xp) {
  return LEVELS.slice().reverse().find(l => xp >= l.min) || LEVELS[0];
}

function updateXPBar() {
  const xp  = calcXP();
  const lvl = getCurrentLevel(xp);
  const next = LEVELS.find(l => l.min > xp);
  const pct  = next ? Math.min(100, ((xp - lvl.min) / (lvl.max - lvl.min)) * 100) : 100;

  const _isAr = (typeof currentLang !== 'undefined') && currentLang === 'ar';
  const _rankName = _isAr ? (lvl.nameAr || lvl.name) : lvl.name;
  const _maxLabel = _isAr ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰' : 'MAX';
  document.getElementById('level-icon').textContent  = lvl.icon;
  document.getElementById('level-name').textContent  = _rankName;
  document.getElementById('xp-label').textContent    = next ? `${xp} / ${lvl.max} XP` : `${xp} XP â€” ${_maxLabel}`;
  document.getElementById('xp-fill').style.width     = pct + '%';
  document.getElementById('xp-fill').style.background =
    `linear-gradient(90deg, #1a7a3f, ${lvl.color || '#2ecc71'}, #39ff8f)`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACHIEVEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACHIEVEMENTS = [
  { id:'first_workout',   emoji:'ğŸ’ª', name:'First Blood',       desc:'Logged your first workout',         check: () => workouts.length >= 1 },
  { id:'five_workouts',   emoji:'ğŸ”¥', name:'On Fire',           desc:'Logged 5 workouts',                 check: () => workouts.length >= 5 },
  { id:'twenty_workouts', emoji:'âš¡', name:'Consistent',        desc:'Logged 20 workouts',                check: () => workouts.length >= 20 },
  { id:'fifty_workouts',  emoji:'ğŸ‹ï¸', name:'Dedicated',         desc:'Logged 50 workouts',                check: () => workouts.length >= 50 },
  { id:'first_pr',        emoji:'ğŸ†', name:'Personal Best',     desc:'Set your first PR',                 check: () => workouts.some(w => w.isPR) },
  { id:'five_prs',        emoji:'ğŸ¥‡', name:'PR Machine',        desc:'Set 5 personal records',            check: () => workouts.filter(w=>w.isPR).length >= 5 },
  { id:'streak3',         emoji:'ğŸ”¥', name:'Hat Trick',         desc:'3-day training streak',             check: () => calcStreak() >= 3 },
  { id:'streak7',         emoji:'ğŸ“…', name:'Full Week',         desc:'7-day training streak',             check: () => calcStreak() >= 7 },
  { id:'streak30',        emoji:'ğŸŒŸ', name:'Iron Discipline',   desc:'30-day training streak',            check: () => calcStreak() >= 30 },
  { id:'vol10k',          emoji:'ğŸ“¦', name:'Ten Tonne Club',    desc:'Lifted 10,000 kg total',            check: () => workouts.reduce((a,w)=>a+w.totalVolume,0) >= 10000 },
  { id:'vol100k',         emoji:'ğŸš€', name:'Freight Train',     desc:'Lifted 100,000 kg total',           check: () => workouts.reduce((a,w)=>a+w.totalVolume,0) >= 100000 },
  { id:'all_muscles',     emoji:'ğŸ«€', name:'Full Body Warrior', desc:'Trained all 9 muscle groups',       check: () => new Set(workouts.map(w=>w.muscle)).size >= 9 },
  { id:'hundred_sets',    emoji:'ğŸ’¯', name:'Set Grinder',       desc:'Completed 100 total sets',          check: () => workouts.reduce((a,w)=>a+w.sets.length,0) >= 100 },
  { id:'gold_rank',       emoji:'ğŸ¥‡', name:'Golden Era',        desc:'Reached GOLD rank',                 check: () => calcXP() >= 900 },
];

function checkAchievements() {
  const unlocked = JSON.parse(localStorage.getItem('forge_achievements') || '[]');
  let newUnlocks = [];
  ACHIEVEMENTS.forEach(a => {
    if (!unlocked.includes(a.id) && a.check()) {
      unlocked.push(a.id);
      newUnlocks.push(a);
    }
  });
  if (newUnlocks.length) {
    localStorage.setItem('forge_achievements', JSON.stringify(unlocked));
    // Show sequentially
    newUnlocks.forEach((a, i) => setTimeout(() => showAchievement(a), i * 3400));
  }
}

function showAchievement(a) {
  const popup = document.getElementById('achievement-popup');
  document.getElementById('ach-emoji').textContent = a.emoji;
  document.getElementById('ach-name').textContent  = a.name;
  document.getElementById('ach-desc').textContent  = a.desc;
  popup.classList.add('show');
  // Vibrate pattern
  if ('vibrate' in navigator) navigator.vibrate([100,50,100,50,200]);
  setTimeout(() => popup.classList.remove('show'), 3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TODAY'S MISSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMissions() {
  const todayWorkouts = workouts.filter(w => new Date(w.date).toDateString() === today());
  const todayVol      = todayWorkouts.reduce((a,w) => a+w.totalVolume, 0);
  const todaySets     = todayWorkouts.reduce((a,w) => a+w.sets.length, 0);
  const streak        = calcStreak();
  const totalSessions = workouts.length;

  // Build dynamic missions based on current state
  const missions = [];

  const _mLang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  // Always: log today
  missions.push({
    text: _mLang==='ar' ? 'Ø³Ø¬Ù‘Ù„ ØªÙ…Ø±ÙŠÙ†Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø§Ù„ÙŠÙˆÙ…' : 'Log at least 1 workout today',
    done: todayWorkouts.length >= 1,
    xp: 10
  });

  // Volume goal based on history
  const avgVol = workouts.length >= 3
    ? Math.round(workouts.slice(-10).reduce((a,w) => a+w.totalVolume,0) / Math.min(workouts.length,10))
    : 1000;
  const volTarget = Math.max(500, Math.round(avgVol * 0.9 / 100) * 100);
  missions.push({
    text: _mLang==='ar' ? `Ø­Ù‚Ù‘Ù‚ Ø­Ø¬Ù… ${volTarget.toLocaleString()} ÙƒØº Ø§Ù„ÙŠÙˆÙ…` : `Hit ${volTarget.toLocaleString()} kg volume today`,
    done: todayVol >= volTarget,
    xp: 15
  });

  // Sets goal
  const setsTarget = Math.max(9, Math.min(20, Math.round((totalSessions > 5 ? 12 : 9))));
  missions.push({
    text: _mLang==='ar' ? `Ø£ÙƒÙ…Ù„ ${setsTarget}+ Ù…Ø¬Ù…ÙˆØ¹Ø©` : `Complete ${setsTarget}+ sets`,
    done: todaySets >= setsTarget,
    xp: 10
  });

  // Streak mission
  if (streak >= 1) {
    missions.push({
      text: _mLang==='ar' ? `Ù…Ø¯Ù‘Ø¯ Ø³Ù„Ø³Ù„ØªÙƒ Ù„Ù€ ${streak} Ø£ÙŠØ§Ù…` : `Extend your ${streak}-day streak`,
      done: new Date(workouts[workouts.length-1]?.date||0).toDateString() === today(),
      xp: 20
    });
  }

  // Muscle variety
  const musclesTodayCount = new Set(todayWorkouts.map(w => w.muscle)).size;
  missions.push({
    text: _mLang==='ar' ? 'Ø¯Ø±Ù‘Ø¨ Ù…Ø¬Ù…ÙˆØ¹ØªÙŠÙ† Ø¹Ø¶Ù„ÙŠØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' : 'Train at least 2 muscle groups',
    done: musclesTodayCount >= 2,
    xp: 10
  });

  const done    = missions.filter(m => m.done).length;
  const total   = missions.length;
  const pct     = total ? Math.round(done / total * 100) : 0;
  const allDone = done === total;

  document.getElementById('mission-panel').style.display = 'block';

  const _mTitle = _mLang==='ar' ? 'Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…' : "TODAY'S MISSION";
  const _mDoneText = _mLang==='ar' ? 'Ù…ÙƒØªÙ…Ù„Ø©!' : 'COMPLETE!';
  const _mProgressText = _mLang==='ar' ? done+'/'+total+' Ù…Ù†Ø¬Ø²' : done+'/'+total+' DONE';
  const _mStarSVG = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;color:var(--accent);filter:drop-shadow(0 0 4px var(--accent));"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
  const _th = '<div class="mission-title"><span>' + _mStarSVG + _mTitle + '</span><span class="mission-title-done" style="color:' + (allDone?'var(--green)':'var(--text3)') + ';">' + (allDone?_mDoneText:_mProgressText) + '</span></div>';
  const _bh = '<div style="height:5px;background:rgba(0,0,0,.3);border-radius:3px;overflow:hidden;margin-bottom:14px;border:1px solid var(--border);"><div style="height:100%;width:' + pct + '%;background:linear-gradient(90deg,var(--green2),var(--accent));border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1);box-shadow:0 0 8px rgba(57,255,143,.4);"></div></div>';
  const _ih = missions.map(m => '<div class="mission-item' + (m.done?' done-item':'') + '"><div class="mission-check' + (m.done?' done':'') + '">' + (m.done?'âœ“':'') + '</div><span class="mission-text' + (m.done?' done':'') + '">' + m.text + '</span><span class="mission-xp">+' + m.xp + ' XP</span></div>').join('');
  document.getElementById('mission-panel').innerHTML = _th + _bh + '<div class="mission-items">' + _ih + '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORGE COACH â€” AI ENGINE v2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Coach tab switcher
function coachSwitchTab(tab, btn) {
  ['insights','plan','nutrition','prs'].forEach(t => {
    const el = document.getElementById('coach-tab-' + t);
    if (el) el.style.display = t === tab ? '' : 'none';
  });
  document.querySelectorAll('.coach-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (tab === 'plan')      renderCoachPlan();
  if (tab === 'nutrition') renderCoachNutrition();
  if (tab === 'prs')       renderCoachPRs();
}

// â”€â”€ Compute a Training Score (0â€“100) â”€â”€
function calcTrainingScore() {
  const streak      = calcStreak();
  const total       = workouts.length;
  const allMuscles  = ['Chest','Back','Shoulders','Legs','Core','Biceps','Triceps','Glutes','Calves'];
  const muscleCounts= {};
  workouts.forEach(w => { muscleCounts[w.muscle] = (muscleCounts[w.muscle]||0)+1; });
  const trained     = allMuscles.filter(m => muscleCounts[m]);
  const balanceScore= Math.round((trained.length / allMuscles.length) * 100);

  // Consistency: sessions last 4 weeks vs ideal 3/week
  const fourWeeksAgo = Date.now() - 28*86400000;
  const recent = workouts.filter(w => new Date(w.date) >= fourWeeksAgo).length;
  const consistencyScore = Math.min(100, Math.round((recent / 12) * 100));

  // Volume trend
  const last5vols = workouts.slice(-5).map(w => w.totalVolume);
  const prev5vols = workouts.slice(-10,-5).map(w => w.totalVolume);
  let volScore = 60;
  if (last5vols.length && prev5vols.length) {
    const a = last5vols.reduce((s,v)=>s+v,0)/last5vols.length;
    const b = prev5vols.reduce((s,v)=>s+v,0)/prev5vols.length;
    volScore = b > 0 ? Math.min(100, Math.round((a/b)*60)) : 60;
  }

  // Streak bonus
  const streakBonus = Math.min(20, streak * 3);

  const total_score = Math.min(100, Math.round(
    balanceScore * 0.3 + consistencyScore * 0.4 + volScore * 0.2 + streakBonus * 0.1
  ));

  return { total: total_score, balance: balanceScore, consistency: consistencyScore, volume: Math.min(100, volScore), streak: Math.min(100, streakBonus * 5) };
}

function renderCoach() {
  const insights = [];
  const streak   = calcStreak();
  const total    = workouts.length;

  const _cLang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const _ar = _cLang === 'ar';

  if (total === 0) {
    document.getElementById('coach-score-wrap').style.display = 'none';
    document.getElementById('coach-score-badge').textContent = '';
    document.getElementById('coach-status').textContent = _ar ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù„ÙŠÙ„â€¦' : 'Ready to analyseâ€¦';
    document.getElementById('coach-body').innerHTML = `
      <div class="coach-bubble good">
        <strong>${_ar ? 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø¯Ø±Ø¨ ÙÙˆØ±Ø¬ Ø§Ù„Ø°ÙƒÙŠ' : 'WELCOME TO FORGE COACH'}</strong><br>
        ${_ar ? 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ø¶Ù„Ø© ÙÙŠ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø³Ù… Ø«Ù… Ø³Ø¬Ù‘Ù„ Ø£ÙˆÙ„ ØªÙ…Ø±ÙŠÙ†. Ø¨Ù…Ø¬Ø±Ø¯ ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø³ÙŠØ­Ù„Ù„ Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ØªÙˆØ§Ø²Ù† ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ ÙˆØ£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØºØ°ÙŠØ© ÙˆÙŠÙ…Ù†Ø­Ùƒ Ø®Ø·Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù…Ø®ØµØµØ©.' : 'Tap a muscle on the body map then log your first exercise. Once you have data, your AI coach will analyse balance, progressive overload, recovery, nutrition targets and give you a personalised weekly plan.'}
      </div>`;
    return;
  }

  // â”€â”€ Compute Score â”€â”€
  const score = calcTrainingScore();
  renderCoachScore(score);

  // â”€â”€ Build insights â”€â”€
  const allMuscles  = ['Chest','Back','Shoulders','Legs','Core','Biceps','Triceps','Glutes','Calves'];
  const muscleCounts= {};
  workouts.forEach(w => { muscleCounts[w.muscle] = (muscleCounts[w.muscle]||0)+1; });
  const untrained   = allMuscles.filter(m => !muscleCounts[m]);
  const mostTrained = Object.entries(muscleCounts).sort((a,b)=>b[1]-a[1])[0];

  const exerciseMap = {};
  workouts.forEach(w => {
    if (!exerciseMap[w.exercise]) exerciseMap[w.exercise] = [];
    exerciseMap[w.exercise].push(w);
  });
  const topEx = Object.entries(exerciseMap).sort((a,b)=>b[1].length-a[1].length)[0];

  const lastWorkoutDate = new Date(workouts.slice().sort((a,b)=>new Date(b.date)-new Date(a.date))[0].date);
  const daysSinceLast   = Math.floor((Date.now()-lastWorkoutDate)/86400000);

  // Arabic muscle name map
  const MUSCLE_AR = {Chest:'Ø§Ù„ØµØ¯Ø±',Back:'Ø§Ù„Ø¸Ù‡Ø±',Shoulders:'Ø§Ù„Ø£ÙƒØªØ§Ù',Legs:'Ø§Ù„Ø£Ø±Ø¬Ù„',Core:'Ø§Ù„Ø¹Ø¶Ù„Ø© Ø§Ù„ÙˆØ³Ø·Ù‰',Biceps:'Ø§Ù„Ø¹Ø¶Ù„Ø© Ø°Ø§Øª Ø§Ù„Ø±Ø£Ø³ÙŠÙ†',Triceps:'Ø§Ù„Ø¹Ø¶Ù„Ø© Ø°Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø±Ø¤ÙˆØ³',Glutes:'Ø§Ù„Ø¹Ø¶Ù„Ø© Ø§Ù„Ø£Ù„ÙˆÙŠØ©',Calves:'Ø±Ø¨Ù„Ø© Ø§Ù„Ø³Ø§Ù‚'};
  const mAr = m => MUSCLE_AR[m] || m;

  // 1. Recovery & readiness
  if (daysSinceLast === 0) {
    insights.push({ cls:'good', icon:'ğŸ”¥',
      title: _ar ? 'Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©' : 'Active Session',
      text:  _ar ? 'Ø£Ù†Øª ØªØªØ¯Ø±Ø¨ Ø§Ù„ÙŠÙˆÙ… â€” Ø§Ø³ØªØ®Ø¯Ù… 60â€“90 Ø«Ø§Ù†ÙŠØ© Ø±Ø§Ø­Ø© Ù„Ù„Ø¶Ø®Ø§Ù…Ø©ØŒ Ùˆ2â€“3 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù„Ù‚ÙˆØ© Ø§Ù„Ù‚ØµÙˆÙ‰. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±Ø·ÙŠØ¨.' : `You're training today â€” use 60â€“90s rest for hypertrophy, 2â€“3 min for max strength. Stay hydrated.` });
  } else if (daysSinceLast === 1) {
    const lastMuscle = workouts.slice().sort((a,b)=>new Date(b.date)-new Date(a.date))[0].muscle;
    const antagonists = {Chest:'Back',Back:'Chest',Biceps:'Triceps',Triceps:'Biceps',Legs:'Core',Shoulders:'Core',Core:'Legs',Glutes:'Core',Calves:'Core'};
    const suggest = antagonists[lastMuscle] || 'a different muscle group';
    insights.push({ cls:'', icon:'ğŸ’¤',
      title: _ar ? 'ÙŠÙˆÙ… ØªØ¹Ø§ÙÙ Ø°ÙƒÙŠ' : 'Smart Recovery Day',
      text:  _ar ? `Ø¯Ø±Ù‘Ø¨Øª ${mAr(lastMuscle)} Ø£Ù…Ø³. Ø§Ù„ÙŠÙˆÙ… Ù…Ø«Ø§Ù„ÙŠ Ù„Ù€${mAr(suggest)} â€” Ø§Ù„Ø¥Ù‚Ø±Ø§Ù† Ø§Ù„ØªØ¶Ø§Ø¯ÙŠ ÙŠØ¹Ø¸Ù‘Ù… Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¯ÙˆÙ† Ø¥Ø¬Ù‡Ø§Ø¯ Ø²Ø§Ø¦Ø¯.` : `You trained ${lastMuscle} yesterday. Today is perfect for ${suggest} â€” antagonist pairing maximises weekly volume without overtraining.` });
  } else if (daysSinceLast >= 4) {
    insights.push({ cls:'alert', icon:'âš ï¸',
      title: _ar ? `ÙØ¬ÙˆØ© ${daysSinceLast} Ø£ÙŠØ§Ù…` : `${daysSinceLast}-Day Gap Detected`,
      text:  _ar ? 'ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† Ø§Ù„Ø¹Ø¶Ù„ÙŠ ÙŠØ¨Ù„Øº Ø°Ø±ÙˆØªÙ‡ 24â€“48 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ø«Ù… ÙŠØªØ±Ø§Ø¬Ø¹. Ù„Ø§ ØªØ¯Ø¹ Ø§Ù„Ø¶Ù…ÙˆØ± ÙŠØ¨Ø¯Ø£ â€” Ø­ØªÙ‰ Ø¬Ù„Ø³Ø© 20 Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„ÙŠÙˆÙ… ØªØ­Ù…ÙŠ ØªÙ‚Ø¯Ù…Ùƒ.' : `Muscle protein synthesis peaks 24â€“48h post-session, then declines. Don't let detraining set in â€” even a 20-minute session today protects your progress.` });
  }

  // 2. Muscle balance
  if (untrained.length >= 3) {
    const untrainedNames = _ar ? untrained.slice(0,3).map(mAr).join('ØŒ ') : untrained.slice(0,3).join(', ');
    const more = untrained.length > 3 ? (_ar ? ' + Ø£ÙƒØ«Ø±' : ' + more') : '';
    insights.push({ cls:'warn', icon:'ğŸ“',
      title: _ar ? 'ØªØ­Ø°ÙŠØ± Ø¹Ø¯Ù… Ø§Ù„ØªÙˆØ§Ø²Ù†' : 'Balance Alert',
      text:  _ar ? `${untrainedNames}${more} Ù„Ù… ØªÙØ¯Ø±ÙÙ‘Ø¨ Ù‚Ø·. Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø¶Ù„ÙŠØ© ØªØ²ÙŠØ¯ Ø®Ø·Ø± Ø§Ù„Ø¥ØµØ§Ø¨Ø© ÙˆØªØ­Ø¯ Ø§Ù„Ù‚ÙˆØ© Ø§Ù„ÙƒÙ„ÙŠØ©. Ø£Ø¶ÙÙ‡Ø§ Ø¥Ù„Ù‰ ØªÙ‚Ø³ÙŠÙ…ØªÙƒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©.` : `${untrainedNames}${more} never trained. Muscle imbalances increase injury risk and limit overall strength. Add them to your weekly split.` });
  } else if (untrained.length > 0) {
    const untrainedNames = _ar ? untrained.map(mAr).join(' Ùˆ') : untrained.join(' & ');
    insights.push({ cls:'', icon:'ğŸ¯',
      title: _ar ? 'ØªØºØ·ÙŠØ© Ø´Ø¨Ù‡ ÙƒØ§Ù…Ù„Ø©' : 'Almost Full Coverage',
      text:  _ar ? `ÙÙ‚Ø· ${untrainedNames} Ù„Ù… ØªÙØ¯Ø±ÙÙ‘Ø¨ Ø¨Ø¹Ø¯. Ø§Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„ØªÙˆØ§Ø²Ù† Ø¹Ø¶Ù„ÙŠ ÙƒØ§Ù…Ù„ ÙˆÙˆØ¶Ø¹ÙŠØ© Ø£ÙØ¶Ù„.` : `Only ${untrainedNames} left untrained. Hit them this week for complete muscle balance and better posture.` });
  }

  // 3. Progressive overload deep analysis
  if (topEx && topEx[1].length >= 2) {
    const exName  = topEx[0];
    const sessions= topEx[1].sort((a,b)=>new Date(a.date)-new Date(b.date));
    const lastW   = Math.max(...sessions[sessions.length-1].sets.map(s=>s.weight));
    const prevW   = Math.max(...sessions[sessions.length-2].sets.map(s=>s.weight));
    const lastReps= sessions[sessions.length-1].sets.reduce((a,s)=>a+s.reps,0);
    const unit    = sessions[sessions.length-1].sets[0]?.unit || 'kg';
    const delta   = lastW - prevW;

    if (delta > 0) {
      insights.push({ cls:'good', icon:'ğŸ“ˆ',
        title: _ar ? `ØªØ­Ù…ÙŠÙ„ Ù…ØªØµØ§Ø¹Ø¯: ${exName}` : `Overloading: ${exName}`,
        text:  _ar ? `+${delta.toFixed(1)}${unit} Ù…Ù†Ø° Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©. Ø§Ù„ØªØ§Ù„ÙŠ: Ø¬Ø±Ù‘Ø¨ ${(lastW+2.5).toFixed(1)}${unit} Ã— Ù†ÙØ³ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§ØªØŒ Ø£Ùˆ ${lastW}${unit} Ã— ${lastReps+2} ØªÙƒØ±Ø§Ø±. ÙƒÙ„Ø§Ù‡Ù…Ø§ ÙŠÙØ¹Ø¯Ù‘ ØªØ­Ù…ÙŠÙ„Ø§Ù‹ Ù…ØªØµØ§Ø¹Ø¯Ø§Ù‹.` : `+${delta.toFixed(1)}${unit} since last session. Next: try ${(lastW+2.5).toFixed(1)}${unit} Ã— same reps, OR ${lastW}${unit} Ã— ${lastReps+2} reps. Both count as overload.` });
    } else if (delta === 0) {
      insights.push({ cls:'warn', icon:'ğŸ“Š',
        title: _ar ? `ØªÙ†Ø¨ÙŠÙ‡ Ø±ÙƒÙˆØ¯: ${exName}` : `Plateau Alert: ${exName}`,
        text:  _ar ? `Ù†ÙØ³ Ø§Ù„ÙˆØ²Ù† ÙÙŠ Ø¬Ù„Ø³ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ†. Ø£Ø¶Ù +2.5${unit} Ø£Ùˆ Ø§Ø³ØªÙ‡Ø¯Ù ${lastReps+2} ØªÙƒØ±Ø§Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ. Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„Ø±ÙƒÙˆØ¯ØŒ Ø¬Ø±Ù‘Ø¨ Ø£Ø³Ø¨ÙˆØ¹ ØªØ®ÙÙŠÙ Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø¨Ø«Ù‚Ù„ Ø£Ø¹Ù„Ù‰.` : `Same weight 2 sessions running. Add +2.5${unit} or aim for ${lastReps+2} total reps. If stuck longer, try a deload week then reset heavier.` });
    } else {
      insights.push({ cls:'alert', icon:'ğŸ“‰',
        title: _ar ? `Ø§Ù†Ø®ÙØ§Ø¶ Ø­Ø¬Ù…: ${exName}` : `Volume Dip: ${exName}`,
        text:  _ar ? `Ø§Ù†Ø®ÙØ¶ Ø§Ù„ÙˆØ²Ù† ${Math.abs(delta).toFixed(1)}${unit}. Ù‚Ø¯ ÙŠØ¯Ù„ Ø°Ù„Ùƒ Ø¹Ù„Ù‰ ØªØ¹Ø¨ Ø£Ùˆ Ù‚Ù„Ø© Ù†ÙˆÙ… Ø£Ùˆ Ù†Ù‚Øµ ØªØºØ°ÙŠØ©. Ø±Ø§Ø¬Ø¹ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØ¹Ø§ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.` : `Weight dropped ${Math.abs(delta).toFixed(1)}${unit}. This may indicate fatigue, poor sleep, or under-eating. Check recovery factors before next session.` });
    }

    // Overload progression visual
    const r = sessions[sessions.length-1].sets[0]?.reps || 8;
    insights.push({ cls:'', icon:'ğŸ¯',
      title: _ar ? `Ù…Ø³Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù…: ${exName}` : `Progression Path: ${exName}`,
      overload:{
        current:`${lastW}${unit}Ã—${r}`, next:`${lastW}${unit}Ã—${r+2}`, then:`${(lastW+2.5).toFixed(1)}${unit}Ã—${r}`,
        labelNow: _ar ? 'Ø§Ù„Ø¢Ù†' : 'NOW', labelReps: _ar ? '+Ù¢ ØªÙƒØ±Ø§Ø±' : '+2 REPS', labelWeight: _ar ? '+ÙˆØ²Ù†' : '+WEIGHT'
      },
      text: _ar ? 'ØªÙ‚Ø¯Ù… ØªØ¯Ø±ÙŠØ¬ÙŠ Ù…Ù† 3 Ø®Ø·ÙˆØ§Øª Ù„Ø¶Ù…Ø§Ù† Ù…ÙƒØ§Ø³Ø¨ Ù…Ø³ØªÙ…Ø±Ø©:' : `3-step micro-progression to guarantee continuous gains:`});
  }

  // 4. Volume trend
  const avg5  = workouts.slice(-5).reduce((a,w)=>a+w.totalVolume,0) / Math.max(1, Math.min(5,workouts.length));
  const avg10 = workouts.slice(-10,-5).reduce((a,w)=>a+w.totalVolume,0) / Math.max(1, workouts.slice(-10,-5).length);
  if (avg10 > 0 && avg5 > avg10 * 1.2) {
    insights.push({ cls:'good', icon:'ğŸš€',
      title: _ar ? `Ø§Ù„Ø­Ø¬Ù… +${Math.round((avg5/avg10-1)*100)}% ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©` : `Volume +${Math.round((avg5/avg10-1)*100)}% This Block`,
      text:  _ar ? 'Ø§ØªØ¬Ø§Ù‡ ØªØµØ§Ø¹Ø¯ÙŠ Ù‚ÙˆÙŠ. Ø¬Ø³Ù…Ùƒ ÙŠØªÙƒÙŠÙ. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† â€” Ø§Ø³ØªÙ‡Ø¯Ù 1.6â€“2.2 ØºØ±Ø§Ù…/ÙƒØº. Ø§Ù„Ù†ÙˆÙ… Ù‡Ùˆ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø¨ØªÙ†Ø§Ø¦ÙŠØ©ØŒ Ø§Ø³ØªÙ‡Ø¯Ù 7â€“9 Ø³Ø§Ø¹Ø§Øª.' : `Strong upward trend. Your body is adapting. Ensure protein intake matches â€” aim 1.6â€“2.2g/kg. Sleep is the anabolic window, target 7â€“9h.` });
  } else if (avg10 > 0 && avg5 < avg10 * 0.8) {
    insights.push({ cls:'warn', icon:'ğŸ“‰',
      title: _ar ? 'Ø§Ù„Ø­Ø¬Ù… ÙÙŠ ØªØ±Ø§Ø¬Ø¹' : 'Volume Declining',
      text:  _ar ? 'Ø¬Ù„Ø³Ø§ØªÙƒ Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø£Ù‚Ù„ Ù…Ù† Ù…ØªÙˆØ³Ø·Ùƒ. ØªØ®ÙÙŠÙ Ù…ØªØ¹Ù…Ø¯ØŸ Ù…Ù…ØªØ§Ø². Ø§Ù†Ø¬Ø±Ø§Ù ØºÙŠØ± Ù…Ù‚ØµÙˆØ¯ØŸ Ø±Ø§Ø¬Ø¹ Ø¬Ø¯ÙˆÙ„Ùƒ ÙˆØªØºØ°ÙŠØªÙƒ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³Ø§Ø±.' : `Recent sessions are lower than your average. Intentional deload? Good. Accidental drift? Review your schedule and nutrition to get back on track.` });
  }

  // 5. Streak
  if (streak >= 7) {
    insights.push({ cls:'good', icon:'ğŸ”¥',
      title: _ar ? `${streak} Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©! Ø«Ø¨Ø§Øª Ù†Ø®Ø¨ÙˆÙŠ` : `${streak}-Day Streak! Elite Consistency`,
      text:  _ar ? `Ø£ÙØ¶Ù„ 5% Ù…Ù† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠÙŠÙ† ÙŠØ­Ø§ÙØ¸ÙˆÙ† Ø¹Ù„Ù‰ Ù‡Ø°Ø§. Ø§Ù„Ø¨Ø­Ø«: 66 ÙŠÙˆÙ…Ø§Ù‹ ØªØ¨Ù†ÙŠ Ø¹Ø§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©. Ø£Ù†Øª Ø¹Ù„Ù‰ Ø¨ÙØ¹Ø¯ ${Math.max(0,66-streak)} ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø¯Ø§Ø¦Ù…Ø§Ù‹.` : `Top 5% of athletes maintain this. Research: 66 days builds automatic habit. You're ${Math.max(0,66-streak)} days from making this permanent.` });
  } else if (streak >= 3) {
    insights.push({ cls:'', icon:'âš¡',
      title: _ar ? `${streak} Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ© â€” ÙˆØ§ØµÙ„` : `${streak}-Day Streak â€” Keep It Going`,
      text:  _ar ? 'Ø§Ù„Ø²Ø®Ù… ÙŠØªØ±Ø§ÙƒÙ…. ØªØ®Ø·ÙŠ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ ÙŠØ¶Ø§Ø¹Ù Ø§Ø­ØªÙ…Ø§Ù„ ØªØ®Ø·ÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ. Ø§Ø­Ù…Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø­ØªÙ‰ Ø¨Ø¬Ù„Ø³Ø© Ù‚ØµÙŠØ±Ø© 20 Ø¯Ù‚ÙŠÙ‚Ø©.' : `Momentum is building. Missing one day doubles the chance of missing the next. Protect this streak even with a short 20-min session.` });
  }

  const _icoSVG = {
    'ğŸ”¥': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 3z"/></svg>',
    'âš¡': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
    'ğŸ“ˆ': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
    'ğŸ“Š': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
    'ğŸ“‰': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>',
    'ğŸš€': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',
    'ğŸ“': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M14.5 10c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5z"/><path d="M20.5 10H19V8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/><path d="M9.5 14c.83 0 1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5S8 21.33 8 20.5v-5c0-.83.67-1.5 1.5-1.5z"/><path d="M3.5 14H5v1.5c0 .83-.67 1.5-1.5 1.5S2 16.33 2 15.5 2.67 14 3.5 14z"/><path d="M14 5.5c0 .83-.67 1.5-1.5 1.5h-5C6.67 7 6 6.33 6 5.5S6.67 4 7.5 4h5c.83 0 1.5.67 1.5 1.5z"/><path d="M18.5 9.5c-.83 0-1.5.67-1.5 1.5v5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-5c0-.83-.67-1.5-1.5-1.5z"/></svg>',
    'ğŸ¯': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
    'âš ï¸': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    'ğŸ’¤': '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-5 0v-15A2.5 2.5 0 0 1 9.5 2z"/><path d="M14.5 8A2.5 2.5 0 0 1 17 10.5v9a2.5 2.5 0 0 1-5 0v-9A2.5 2.5 0 0 1 14.5 8z"/></svg>'
  };
  document.getElementById('coach-body').innerHTML = insights.map((ins, i) => `
    <div class="coach-bubble ${ins.cls||''}" style="animation-delay:${i*0.06}s;">
      <strong>${_icoSVG[ins.icon] || ins.icon || ''} ${ins.title}</strong><br>${ins.text}
      ${ins.overload ? `
        <div class="overload-row" style="margin-top:10px;">
          <div class="overload-step active-step"><div class="os-val green">${ins.overload.current}</div><div class="os-label">${ins.overload.labelNow||'NOW'}</div></div>
          <div class="overload-step"><div class="os-val">${ins.overload.next}</div><div class="os-label">${ins.overload.labelReps||'+2 REPS'}</div></div>
          <div class="overload-step"><div class="os-val">${ins.overload.then}</div><div class="os-label">${ins.overload.labelWeight||'+WEIGHT'}</div></div>
        </div>` : ''}
    </div>`).join('');

  document.getElementById('coach-status').textContent = _ar ? 'Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©' : 'Strategy ready';
}

function renderCoachScore(score) {
  const wrap = document.getElementById('coach-score-wrap');
  if (!wrap) return;
  wrap.style.display = 'flex';

  const _csLang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const _csAr   = _csLang === 'ar';

  const circumference = 175.93;
  const offset = circumference - (score.total / 100) * circumference;
  const ring = document.getElementById('score-ring-fill');
  const num  = document.getElementById('score-ring-num');
  const badge= document.getElementById('coach-score-badge');

  if (ring) { setTimeout(() => { ring.style.strokeDashoffset = offset; }, 100); }
  if (num)  num.textContent = score.total;
  if (badge) badge.innerHTML = score.total >= 80
    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 3z"/></svg>'
    : score.total >= 60
    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
    : score.total >= 40
    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>'
    : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22V12"/><path d="M17 7c0 2.8-2.2 5-5 5S7 9.8 7 7s2.2-5 5-5 5 2.2 5 5z"/></svg>';
  const ringLabel = document.getElementById('score-ring-label');
  if (ringLabel) ringLabel.textContent = _csAr ? 'Ù†Ù‚Ø§Ø·' : 'SCORE';

  const labelEn = score.total >= 80 ? 'ELITE' : score.total >= 60 ? 'STRONG' : score.total >= 40 ? 'BUILDING' : 'STARTING';
  const labelAr = score.total >= 80 ? 'Ù†Ø®Ø¨Ø©'  : score.total >= 60 ? 'Ù‚ÙˆÙŠ'    : score.total >= 40 ? 'ÙÙŠ Ø§Ù„ØªØ·ÙˆØ±' : 'ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©';
  document.getElementById('coach-status').textContent = _csAr
    ? `${labelAr} Â· Ø§Ù„Ù†ØªÙŠØ¬Ø© ${score.total}/100`
    : `${labelEn} Â· Score ${score.total}/100`;

  const details = document.getElementById('score-details');
  if (details) {
    const breakdownRows = [
      [_csAr ? 'Ø§Ù„ØªÙˆØ§Ø²Ù†'    : 'Balance',     score.balance,     '#4fc3f7'],
      [_csAr ? 'Ø§Ù„Ø«Ø¨Ø§Øª'     : 'Consistency', score.consistency, '#2ecc71'],
      [_csAr ? 'Ø§Ù„Ø­Ø¬Ù…'      : 'Volume',      score.volume,      '#ff9f5a'],
      [_csAr ? 'Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±'  : 'Streak',      score.streak,      '#e879f9']
    ];
    details.innerHTML = `
      <div class="score-title">${_csAr ? 'Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨' : 'Training Score'}</div>
      <div class="score-breakdown">
        ${breakdownRows.map(([lbl, val, col]) => `
          <div class="score-row">
            <span>${lbl}</span>
            <div class="score-bar-mini"><div class="score-bar-mini-fill" style="width:${val}%;background:${col};"></div></div>
            <span>${val}%</span>
          </div>`).join('')}
      </div>`;
  }
}

// â”€â”€ WEEKLY PLAN TAB â”€â”€
function renderCoachPlan() {
  const el = document.getElementById('coach-tab-plan');
  if (!el) return;

  const _cpLang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const _cpAr   = _cpLang === 'ar';

  const MUSCLE_AR = {Chest:'Ø§Ù„ØµØ¯Ø±',Back:'Ø§Ù„Ø¸Ù‡Ø±',Shoulders:'Ø§Ù„Ø£ÙƒØªØ§Ù',Legs:'Ø§Ù„Ø£Ø±Ø¬Ù„',Core:'Ø§Ù„ÙˆØ³Ø·',Biceps:'Ø«Ù†Ø§Ø¦ÙŠ',Triceps:'Ø«Ù„Ø§Ø«ÙŠ',Glutes:'Ø§Ù„Ø£Ù„ÙˆÙŠØ©',Calves:'Ø§Ù„Ø³Ø§Ù‚'};
  const mArShort = m => _cpAr ? (MUSCLE_AR[m] || m) : m.substring(0,4);

  const allMuscles  = ['Chest','Back','Shoulders','Legs','Core','Biceps','Triceps','Glutes','Calves'];
  const muscleCounts= {};
  workouts.forEach(w => { muscleCounts[w.muscle] = (muscleCounts[w.muscle]||0)+1; });
  const untrained   = allMuscles.filter(m => !muscleCounts[m]);
  const goal        = userProfile?.goal || 'muscle';

  // Build a smart 7-day split based on goal + gaps
  const SPLITS = {
    muscle:   ['Chest','Back','Shoulders','Legs','Biceps','Triceps','Rest'],
    strength: ['Legs','Chest','Back','Rest','Shoulders','Legs','Rest'],
    fat_loss: ['Legs','Chest','Core','Back','Shoulders','Legs','Rest'],
    endurance:['Core','Back','Legs','Shoulders','Chest','Core','Rest'],
    recomp:   ['Chest','Legs','Back','Core','Shoulders','Rest','Rest'],
  };
  const split = SPLITS[goal] || SPLITS.muscle;
  // Inject untrained muscles to fill rest days
  let planDays = [...split];
  untrained.forEach((m, i) => {
    const restIdx = planDays.indexOf('Rest');
    if (restIdx !== -1 && i < 2) planDays[restIdx] = m;
  });

  const _ms = (p,c='') => `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;${c}">${p}</svg>`;
  const MUSCLE_EMOJI = {
    Chest:     _ms('<path d="M6 5v14M18 5v14"/><path d="M6 9h12M6 15h12"/>'),
    Back:      _ms('<path d="M4 6c0 0 2-2 8-2s8 2 8 2"/><path d="M4 18c0 0 2 2 8 2s8-2 8-2"/><line x1="12" y1="4" x2="12" y2="20"/>'),
    Shoulders: _ms('<path d="M12 8c-4 0-7 2-7 5s3 5 7 5 7-2 7-5-3-5-7-5z"/>'),
    Legs:      _ms('<path d="M10 3c0 0 0 4-2 8s-2 8-2 9"/><path d="M14 3c0 0 0 4 2 8s2 8 2 9"/>'),
    Core:      _ms('<ellipse cx="12" cy="12" rx="4" ry="6"/><line x1="12" y1="6" x2="12" y2="18"/>'),
    Biceps:    _ms('<path d="M6 16c0-4 2-8 6-8s6 4 6 8"/>'),
    Triceps:   _ms('<path d="M8 6l-2 12M16 6l2 12M7 14h10"/>'),
    Glutes:    _ms('<path d="M6 14c0-4 2-7 6-7s6 3 6 7c0 2-2 4-6 4s-6-2-6-4z"/>'),
    Calves:    _ms('<path d="M10 3l-2 10 2 8"/><path d="M14 3l2 10-2 8"/>'),
    Rest:      _ms('<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-5 0v-15A2.5 2.5 0 0 1 9.5 2z"/><path d="M14.5 8A2.5 2.5 0 0 1 17 10.5v9a2.5 2.5 0 0 1-5 0v-9A2.5 2.5 0 0 1 14.5 8z"/>')
  };
  const daysEn = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
  const daysAr = ['Ø¥Ø«','Ø«Ù„','Ø£Ø±','Ø®Ù…','Ø¬Ù…','Ø³Ø¨','Ø£Ø­'];
  const days = _cpAr ? daysAr : daysEn;
  const todayIdx = (new Date().getDay() + 6) % 7; // Mon=0

  // Check which days had workouts this week
  const weekStart = new Date(); weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1); weekStart.setHours(0,0,0,0);
  const doneThisWeek = new Set(
    workouts.filter(w => new Date(w.date) >= weekStart)
            .map(w => new Date(w.date).getDay())
            .map(d => (d + 6) % 7)
  );

  const goalLabelEn = {muscle:'Hypertrophy Split',strength:'Strength Split',fat_loss:'Fat-Loss Split',endurance:'Endurance Split',recomp:'Recomp Split'}[goal] || 'Training Split';
  const goalLabelAr = {muscle:'ØªÙ‚Ø³ÙŠÙ…Ø© Ø§Ù„Ø¶Ø®Ø§Ù…Ø©',strength:'ØªÙ‚Ø³ÙŠÙ…Ø© Ø§Ù„Ù‚ÙˆØ©',fat_loss:'ØªÙ‚Ø³ÙŠÙ…Ø© Ø­Ø±Ù‚ Ø§Ù„Ø¯Ù‡ÙˆÙ†',endurance:'ØªÙ‚Ø³ÙŠÙ…Ø© Ø§Ù„ØªØ­Ù…Ù„',recomp:'ØªÙ‚Ø³ÙŠÙ…Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„'}[goal] || 'ØªÙ‚Ø³ÙŠÙ…Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©';
  const goalLabel = _cpAr ? goalLabelAr : goalLabelEn;

  const untrainedArNames = untrained.slice(0,4).map(m => _cpAr ? (MUSCLE_AR[m]||m) : m).join(_cpAr ? 'ØŒ ' : ', ');

  el.innerHTML = `
    <div style="padding:12px 16px 4px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;">
      ${goalLabel} Â· ${_cpAr ? 'Ù…Ø®ØµØµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' : 'Auto-personalised'}
    </div>
    <div class="week-plan-grid">
      ${days.map((d, i) => {
        const muscle  = planDays[i] || 'Rest';
        const isRest  = muscle === 'Rest';
        const isToday = i === todayIdx;
        const isDone  = doneThisWeek.has(i);
        const isUntrained = untrained.includes(muscle);
        let cls = isRest ? 'rest' : '';
        if (isDone) cls += ' done';
        if (isToday && !isDone) cls += ' today';
        if (isUntrained && !isDone) cls += ' recommended';
        return `
          <div class="week-day">
            <div class="week-day-label">${d}</div>
            <div class="week-day-pill ${cls}" title="${muscle}">
              ${isDone ? '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' : isRest ? '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/></svg>' : MUSCLE_EMOJI[muscle] || _ms('<circle cx="12" cy="12" r="5"/>')}
            </div>
            <div class="week-day-muscle">${isRest ? (_cpAr?'Ø±Ø§Ø­Ø©':'Rest') : mArShort(muscle)}</div>
          </div>`;
      }).join('')}
    </div>
    <div style="padding:0 16px 14px;">
      ${untrained.length
        ? `<div class="coach-bubble warn" style="margin-top:0;"><strong><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> ${_cpAr?'Ø¹Ø¶Ù„Ø§Øª Ø°Ø§Øª Ø£ÙˆÙ„ÙˆÙŠØ©':'PRIORITY MUSCLES'}</strong><br>${untrainedArNames} ${_cpAr?'Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ù„Ø¹Ù†Ø¨Ø±ÙŠ â€” Ø¯Ø±Ù‘Ø¨Ù‡Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„ØªØ·ÙˆØ± Ù…ØªÙˆØ§Ø²Ù†.':'marked in amber â€” train these this week for balanced development.'}</div>`
        : `<div class="coach-bubble good" style="margin-top:0;"><strong><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><polyline points="20 6 9 17 4 12"/></svg> ${_cpAr?'ØªØºØ·ÙŠØ© Ø¹Ø¶Ù„ÙŠØ© ÙƒØ§Ù…Ù„Ø©':'FULL MUSCLE COVERAGE'}</strong><br>${_cpAr?'Ù„Ù‚Ø¯ Ø¯Ø±Ù‘Ø¨Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ø¶Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©. ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ†Ø§ÙˆØ¨ Ù„Ù…ÙƒØ§Ø³Ø¨ Ù…ØªÙˆØ§Ø²Ù†Ø©.':"You've trained all major muscle groups. Keep rotating for balanced gains."}</div>`}
    </div>`;
}

// â”€â”€ NUTRITION TAB â”€â”€
function renderCoachNutrition() {
  const el = document.getElementById('coach-tab-nutrition');
  if (!el) return;

  const _cnLang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const _cnAr   = _cnLang === 'ar';

  // Get data
  const latestBW   = bodyWeight.slice().sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
  const wt         = latestBW ? latestBW.weight : (userProfile?.weight || 75);
  const wtKg       = latestBW?.unit === 'lbs' ? wt * 0.453592 : wt;
  const latestBF   = latestBW?.bodyFat || null;
  const goal       = userProfile?.goal || 'muscle';

  // Macros based on goal
  const PROTEIN_FACTOR = {muscle:2.0,strength:1.8,fat_loss:2.2,endurance:1.6,recomp:2.2};
  const proteinG = Math.round(wtKg * (PROTEIN_FACTOR[goal]||2.0));

  // TDEE
  const heightCm = userProfile?.height ? (userProfile.heightUnit==='ft' ? userProfile.height*30.48 : userProfile.height) : 175;
  const dob      = userProfile?.dob;
  const age      = dob ? Math.floor((Date.now()-new Date(dob))/31557600000) : 25;
  const bmr      = 10*wtKg + 6.25*heightCm - 5*age + 5;
  const tdee     = Math.round(bmr * 1.55);

  const goalCalAdjust = {muscle:+300,strength:+200,fat_loss:-400,endurance:+100,recomp:0};
  const targetCal = tdee + (goalCalAdjust[goal]||0);
  const carbG     = Math.round((targetCal - proteinG*4 - wtKg*1*9) / 4);
  const fatG      = Math.round(wtKg * 1);
  const waterL    = (wtKg * 0.033).toFixed(1);

  const goalLabelEn = {muscle:'Build Muscle',strength:'Strength',fat_loss:'Fat Loss',endurance:'Endurance',recomp:'Recomp'}[goal]||'General';
  const goalLabelAr = {muscle:'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª',strength:'Ø§Ù„Ù‚ÙˆØ©',fat_loss:'Ø­Ø±Ù‚ Ø§Ù„Ø¯Ù‡ÙˆÙ†',endurance:'Ø§Ù„ØªØ­Ù…Ù„',recomp:'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„'}[goal]||'Ø¹Ø§Ù…';
  const goalLabel = _cnAr ? goalLabelAr : goalLabelEn;

  const proteinPct= Math.round(proteinG*4/targetCal*100);
  const carbPct   = Math.round(Math.max(0,carbG)*4/targetCal*100);
  const fatPct    = Math.round(fatG*9/targetCal*100);

  const deficitSurplusEn = goal==='fat_loss' ? 'Deficit for fat loss' : 'Surplus for growth';
  const deficitSurplusAr = goal==='fat_loss' ? 'Ø¹Ø¬Ø² Ù„Ø­Ø±Ù‚ Ø§Ù„Ø¯Ù‡ÙˆÙ†'     : 'ÙØ§Ø¦Ø¶ Ù„Ù„Ù†Ù…Ùˆ';

  const tdeeNoteEn = goal==='fat_loss'
    ? 'Stay in a 300â€“500 kcal deficit for sustainable loss (0.5kg/week).'
    : goal==='muscle'
    ? 'A 200â€“300 kcal surplus builds muscle with minimal fat gain.'
    : 'Calories calibrated to your goal. Adjust Â±200 kcal based on weekly weight trend.';
  const tdeeNoteAr = goal==='fat_loss'
    ? 'Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¹Ø¬Ø² 300â€“500 Ø³Ø¹Ø±Ø© Ù„Ù„ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ù…Ø³ØªØ¯Ø§Ù… (0.5ÙƒØº/Ø£Ø³Ø¨ÙˆØ¹).'
    : goal==='muscle'
    ? 'ÙØ§Ø¦Ø¶ 200â€“300 Ø³Ø¹Ø±Ø© ÙŠØ¨Ù†ÙŠ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª Ø¨Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù…Ù† Ø§Ù„Ø¯Ù‡ÙˆÙ†.'
    : 'Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ù…ÙØ¹Ø§ÙŠÙØ±Ø© Ù„Ù‡Ø¯ÙÙƒ. Ø§Ø¶Ø¨Ø·Ù‡Ø§ Â±200 Ø³Ø¹Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØºÙŠÙ‘Ø± ÙˆØ²Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ.';

  el.innerHTML = `
    <div style="padding:12px 16px 4px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;">
      ${_cnAr ? `Ø£Ù‡Ø¯Ø§Ù ${goalLabel} Â· ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù… ${Math.round(wtKg)}ÙƒØº` : `Targets for ${goalLabel} Â· ${Math.round(wtKg)}kg bodyweight`}
    </div>
    <div class="nutrition-grid">
      <div class="nutr-card">
        <div class="nutr-val">${targetCal}</div>
        <div class="nutr-unit">${_cnAr ? 'Ø³Ø¹Ø±Ø© / ÙŠÙˆÙ…' : 'kcal / day'}</div>
        <div class="nutr-label">${_cnAr ? 'Ø§Ù„Ø³Ø¹Ø±Ø§Øª' : 'Calories'}</div>
        <div class="nutr-tip">${_cnAr ? deficitSurplusAr : deficitSurplusEn}</div>
      </div>
      <div class="nutr-card">
        <div class="nutr-val">${proteinG}<span style="font-size:14px;">g</span></div>
        <div class="nutr-unit">${(PROTEIN_FACTOR[goal]||2).toFixed(1)}${_cnAr ? 'Øº/ÙƒØº' : 'g per kg'}</div>
        <div class="nutr-label">${_cnAr ? 'Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†' : 'Protein'}</div>
        <div class="nutr-tip">${_cnAr ? 'Ù…ÙˆØ²Ø¹ Ø¹Ù„Ù‰ 4 ÙˆØ¬Ø¨Ø§Øª' : 'Spread over 4 meals'}</div>
      </div>
      <div class="nutr-card">
        <div class="nutr-val">${Math.max(0,carbG)}<span style="font-size:14px;">g</span></div>
        <div class="nutr-unit">${_cnAr ? 'ÙˆÙ‚ÙˆØ¯ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†' : 'fuel for lifts'}</div>
        <div class="nutr-label">${_cnAr ? 'Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª' : 'Carbs'}</div>
        <div class="nutr-tip">${_cnAr ? 'Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'Pre/post workout'}</div>
      </div>
      <div class="nutr-card">
        <div class="nutr-val">${fatG}<span style="font-size:14px;">g</span></div>
        <div class="nutr-unit">${_cnAr ? 'Ù‡Ø±Ù…ÙˆÙ†Ø§Øª ÙˆØµØ­Ø©' : 'hormones & health'}</div>
        <div class="nutr-label">${_cnAr ? 'Ø§Ù„Ø¯Ù‡ÙˆÙ†' : 'Fats'}</div>
        <div class="nutr-tip">${_cnAr ? 'Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 0.8Øº/ÙƒØº' : "Don't go below 0.8g/kg"}</div>
      </div>
    </div>
    <div style="padding:0 16px 6px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;">${_cnAr ? 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø§ÙƒØ±Ùˆ' : 'Macro split'}</div>
    <div class="macro-bar-wrap" style="margin:0 16px 4px;">
      <div class="macro-bar-segments">
        <div class="macro-seg" style="width:${proteinPct}%;background:#2ecc71;"></div>
        <div class="macro-seg" style="width:${carbPct}%;background:#4fc3f7;"></div>
        <div class="macro-seg" style="width:${fatPct}%;background:#ff9f5a;"></div>
      </div>
    </div>
    <div style="display:flex;gap:12px;padding:6px 16px 14px;font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);">
      <span style="color:#2ecc71;">â–  ${_cnAr?'Ø¨Ø±ÙˆØªÙŠÙ†':'Protein'} ${proteinPct}%</span>
      <span style="color:#4fc3f7;">â–  ${_cnAr?'ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª':'Carbs'} ${carbPct}%</span>
      <span style="color:#ff9f5a;">â–  ${_cnAr?'Ø¯Ù‡ÙˆÙ†':'Fat'} ${fatPct}%</span>
    </div>
    <div style="padding:0 16px 14px;">
      <div class="coach-bubble" style="margin:0;">
        <strong>${_cnAr ? `Ø§Ù„ØªØ±Ø·ÙŠØ¨: ${waterL}Ù„ / ÙŠÙˆÙ…` : `Hydration: ${waterL}L / day`}</strong><br>
        ${latestBF ? (_cnAr ? `Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¬Ø³Ù… ${latestBF}% â€” ` : `Body fat ${latestBF}% â€” `) : ''}${_cnAr ? `ØªÙ‚Ø¯ÙŠØ± TDEE: ${tdee} Ø³Ø¹Ø±Ø©. ` : `TDEE estimate: ${tdee} kcal. `}${_cnAr ? tdeeNoteAr : tdeeNoteEn}
      </div>
    </div>`;
}

// â”€â”€ PRs TAB â”€â”€
function renderCoachPRs() {
  const el = document.getElementById('coach-tab-prs');
  if (!el) return;

  const _prLang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const _prAr   = _prLang === 'ar';

  if (!workouts.length) {
    el.innerHTML = `<div class="coach-bubble" style="margin:16px;">${_prAr ? 'Ø³Ø¬Ù‘Ù„ ØªÙ…Ø§Ø±ÙŠÙ†Ùƒ Ù„ØªØªØ¨Ø¹ Ø£Ø±Ù‚Ø§Ù…Ùƒ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù‡Ù†Ø§.' : 'Log workouts to track your PRs here.'}</div>`;
    return;
  }

  const _prME = typeof MUSCLE_EMOJI !== 'undefined' ? MUSCLE_EMOJI : {};
  const exerciseMap = {};
  workouts.forEach(w => {
    if (!exerciseMap[w.exercise]) exerciseMap[w.exercise] = { muscle: w.muscle, sessions:[], maxW:0, unit:'kg' };
    const mx = Math.max(...w.sets.map(s=>s.weight));
    if (mx > exerciseMap[w.exercise].maxW) { exerciseMap[w.exercise].maxW = mx; exerciseMap[w.exercise].unit = w.sets[0]?.unit||'kg'; exerciseMap[w.exercise].prDate = w.date; }
    exerciseMap[w.exercise].sessions.push(w);
  });

  const sorted = Object.entries(exerciseMap).sort((a,b)=>b[1].sessions.length-a[1].sessions.length);
  const allMax  = Math.max(...sorted.map(([,d])=>d.maxW)) || 1;

  el.innerHTML = `
    <div style="padding:12px 16px 4px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;">
      ${_prAr ? `Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Â· ${sorted.length} ØªÙ…Ø§Ø±ÙŠÙ†` : `Personal Records Â· ${sorted.length} exercises`}
    </div>
    ${sorted.map(([name, data]) => {
      const pct  = Math.round((data.maxW / allMax) * 100);
      const dateStr = data.prDate ? new Date(data.prDate).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'}) : '';
      const trend = data.sessions.length >= 2 ?
        (Math.max(...data.sessions[data.sessions.length-1].sets.map(s=>s.weight)) >=
         Math.max(...data.sessions[data.sessions.length-2].sets.map(s=>s.weight)) ? 'â†‘' : 'â†“') : 'â†’';
      const sessLabel = _prAr ? `${data.sessions.length} Ø¬Ù„Ø³Ø§Øª Â· ${dateStr}` : `${data.sessions.length} sessions Â· ${dateStr}`;
      return `
        <div class="pr-exercise-row">
          <div class="pr-muscle-icon">${_prME[data.muscle]||_ms('<path d="M6 16c0-4 2-8 6-8s6 4 6 8"/>')}</div>
          <div style="flex:1;min-width:0;">
            <div class="pr-ex-name">${name}</div>
            <div class="pr-ex-date">${sessLabel}</div>
            <div class="pr-progress-bar"><div class="pr-progress-fill" style="width:${pct}%;"></div></div>
          </div>
          <div style="text-align:${_prAr?'left':'right'};flex-shrink:0;">
            <div class="pr-ex-val">${data.maxW}<span style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;"> ${data.unit}</span></div>
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:${trend==='â†‘'?'var(--green)':trend==='â†“'?'var(--danger)':'var(--text3)'};">${trend}</div>
          </div>
        </div>`;
    }).join('')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENHANCED updateStatBar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStatBar() {
  const tod     = workouts.filter(w => new Date(w.date).toDateString() === today());
  const vol     = tod.reduce((a,w) => a+w.totalVolume, 0);
  const streak  = calcStreak();
  const totalPR = workouts.filter(w => w.isPR).length;

  // Week sessions
  const weekStart = new Date(); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
  weekStart.setHours(0,0,0,0);
  const weekSessions = workouts.filter(w => new Date(w.date) >= weekStart).length;

  // Volume card
  const _sLang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const _volUnit = _sLang==='ar' ? 'ÙƒØº' : 'kg';
  document.getElementById('stat-vol').innerHTML = Math.round(vol) + '<span class="ind-unit">' + _volUnit + '</span>';
  const volDelta = document.getElementById('stat-vol-delta');
  if (vol > 0) {
    volDelta.className = 'ind-sub good';
    volDelta.textContent = _sLang==='ar'
      ? 'â†‘ ' + tod.length + ' ØªÙ…Ø±ÙŠÙ† Ù…Ø³Ø¬Ù„'
      : 'â†‘ ' + tod.length + ' exercise' + (tod.length!==1?'s':'') + ' logged';
  } else {
    volDelta.className = 'ind-sub';
    volDelta.textContent = _sLang==='ar' ? 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„!' : 'Nothing yet â€” start!';
  }

  // Streak card
  document.getElementById('stat-streak').innerHTML = streak + '<span class="ind-unit">' + (_sLang==='ar'?'ÙŠ':'d') + '</span>';
  const streakDelta = document.getElementById('stat-streak-delta');
  if (streak >= 7)       { streakDelta.className='ind-sub good';  streakDelta.textContent=_sLang==='ar'?'ÙÙŠ Ø£ÙˆØ¬Ùƒ!':'On fire!'; }
  else if (streak >= 3)  { streakDelta.className='ind-sub good';  streakDelta.textContent=_sLang==='ar'?'ØªØ¨Ù†ÙŠ Ø§Ù„Ø¹Ø§Ø¯Ø©':'Building habit'; }
  else if (streak === 0) { streakDelta.className='ind-sub warn';  streakDelta.textContent=_sLang==='ar'?'Ø¯Ø±Ù‘Ø¨ Ø§Ù„ÙŠÙˆÙ…!':'Train today!'; }
  else                   { streakDelta.className='ind-sub';       streakDelta.textContent=_sLang==='ar'?'Ø§Ø³ØªÙ…Ø±!':'Keep going!'; }

  // PRs card
  document.getElementById('stat-prs').textContent = totalPR;
  const prDelta = document.getElementById('stat-prs-delta');
  prDelta.className = totalPR > 0 ? 'ind-sub good' : 'ind-sub';
  prDelta.textContent = totalPR > 0 ? (_sLang==='ar'?'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©':'Personal records') : (_sLang==='ar'?'Ø³Ø¬Ù‘Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„!':'Set your first PR!');

  // Week sessions card
  document.getElementById('stat-week').textContent = weekSessions;
  const wkDelta = document.getElementById('stat-week-delta');
  if (weekSessions >= 4)      { wkDelta.className='ind-sub good'; wkDelta.textContent=_sLang==='ar'?'Ø£Ø³Ø¨ÙˆØ¹ Ø±Ø§Ø¦Ø¹!':'Excellent week!'; }
  else if (weekSessions >= 2) { wkDelta.className='ind-sub';      wkDelta.textContent=_sLang==='ar'?'ØªÙ‚Ø¯Ù… Ø¬ÙŠØ¯':'Good progress'; }
  else                        { wkDelta.className='ind-sub warn';  wkDelta.textContent=_sLang==='ar'?'Ø§Ø³ØªÙ‡Ø¯Ù 3-5/Ø£Ø³Ø¨ÙˆØ¹':'Aim for 3â€“5/week'; }

  // Add today's BW reps to volume display
  if (typeof bwWorkouts !== 'undefined') {
    const todBw = bwWorkouts.filter(w => new Date(w.date).toDateString() === today());
    const todBwReps = todBw.reduce((a,w) => a + (w.totalReps || 0), 0);
    if (todBwReps > 0 && volDelta) {
      const bwRepsText = _sLang==='ar' ? `Â· ${todBwReps} ØªÙƒØ±Ø§Ø±` : `Â· ${todBwReps} BW reps`;
      volDelta.textContent = volDelta.textContent + ' ' + bwRepsText;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POST-SAVE HOOKS (XP, missions, coach, achievements)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function postSaveHooks() {
  updateXPBar();
  renderMissions();
  renderCoach();
  setTimeout(checkAchievements, 600);
  // â”€â”€ FX: detect level-up after XP update â”€â”€
  if (typeof _checkLevelUp === 'function') setTimeout(_checkLevelUp, 700);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEMES = [
  {
    id: 'forge', name: 'FORGE', emoji: 'âš¡',
    bg:'#080c09', accent:'#39ff8f', dot2:'#2ecc71', dot3:'#1a7a3f',
    desc: 'Dark green / default'
  },
  {
    id: 'ember', name: 'EMBER', emoji: 'ğŸ”¥',
    bg:'#0e0a08', accent:'#ff9f5a', dot2:'#ff6b35', dot3:'#a33d1a',
    desc: 'Volcanic orange'
  },
  {
    id: 'frost', name: 'FROST', emoji: 'â„ï¸',
    bg:'#07090e', accent:'#81d4fa', dot2:'#4fc3f7', dot3:'#0277bd',
    desc: 'Icy blue'
  },
  {
    id: 'neon', name: 'NEON', emoji: 'ğŸŒ†',
    bg:'#08050e', accent:'#e879f9', dot2:'#b447ff', dot3:'#6d28d9',
    desc: 'Cyberpunk purple'
  },
  {
    id: 'midnight', name: 'MIDNIGHT', emoji: 'ğŸŒ‘',
    bg:'#000000', accent:'#ffffff', dot2:'#c0c0c0', dot3:'#888888',
    desc: 'Pure obsidian'
  },
  {
    id: 'solar', name: 'SOLAR', emoji: 'â˜€ï¸',
    bg:'#faf6f0', accent:'#c07000', dot2:'#d4820a', dot3:'#8a5005',
    desc: 'Warm light mode'
  }
];

const ACCENT_COLORS = {
  forge:    ['#39ff8f','#2ecc71','#00ffcc','#a8ff3e','#69ff47'],
  ember:    ['#ff9f5a','#ff6b35','#ffcc44','#ff4500','#ff8c00'],
  frost:    ['#81d4fa','#4fc3f7','#00e5ff','#40c4ff','#80d8ff'],
  neon:     ['#e879f9','#b447ff','#ff2d78','#7c4dff','#ff6dff'],
  midnight: ['#ffffff','#e0e0e0','#bdbdbd','#ff5252','#ffab40'],
  solar:    ['#c07000','#d4820a','#8a5005','#b56b08','#e8900a']
};

let currentTheme = localStorage.getItem('forge_theme') || 'forge';
let currentAccent = localStorage.getItem('forge_accent') || '';

function applyTheme(themeId, accentColor) {
  // â”€â”€ FX: wipe + sound on theme change (guard with typeof â€” FX engine loads after) â”€â”€
  if (themeId !== currentTheme && typeof playThemeWipe === 'function') {
    playThemeWipe();
    if (typeof sndThemeSwitch === 'function') sndThemeSwitch();
  }

  currentTheme = themeId;
  document.body.setAttribute('data-theme', themeId === 'forge' ? '' : themeId);
  if (themeId === 'forge') document.body.removeAttribute('data-theme');
  else document.body.setAttribute('data-theme', themeId);

  // Apply custom accent override
  if (accentColor) {
    currentAccent = accentColor;
    document.documentElement.style.setProperty('--accent', accentColor);
    // Derive glow from accent
    const r = parseInt(accentColor.slice(1,3),16);
    const g = parseInt(accentColor.slice(3,5),16);
    const b = parseInt(accentColor.slice(5,7),16);
    document.documentElement.style.setProperty('--green-glow', `rgba(${r},${g},${b},0.2)`);
  } else {
    currentAccent = '';
    document.documentElement.style.removeProperty('--accent');
    document.documentElement.style.removeProperty('--green-glow');
  }

  localStorage.setItem('forge_theme', themeId);
  localStorage.setItem('forge_accent', accentColor || '');
  renderThemePicker();
}

function renderThemePicker() {
  const grid = document.getElementById('theme-grid');
  if (!grid) return;
  // Sync light mode toggle state
  const lmt = document.getElementById('light-mode-toggle');
  if (lmt) lmt.checked = currentTheme === 'solar';

  grid.innerHTML = THEMES.map(t => `
    <div class="theme-swatch ${currentTheme === t.id ? 'active' : ''}"
         style="background:${t.bg}; border-color:${currentTheme===t.id ? t.accent : 'transparent'};"
         onclick="applyTheme('${t.id}','')">
      <div class="theme-swatch-dots">
        <div class="theme-dot" style="background:${t.accent};box-shadow:0 0 6px ${t.accent}66;"></div>
        <div class="theme-dot" style="background:${t.dot2};"></div>
        <div class="theme-dot" style="background:${t.dot3};"></div>
      </div>
      <div class="theme-swatch-name" style="color:${t.accent};">${t.emoji} ${t.name}</div>
      <div class="theme-swatch-check">âœ“</div>
    </div>
  `).join('');

  // Accent colors for current theme
  const accents = ACCENT_COLORS[currentTheme] || ACCENT_COLORS.forge;
  const accentSection = document.getElementById('accent-section');
  const accentRow = document.getElementById('accent-row');
  if (accentSection && accentRow) {
    accentSection.style.display = 'block';
    accentRow.innerHTML = accents.map(c => `
      <div class="accent-dot-btn ${currentAccent===c ? 'active' : ''}"
           style="background:${c};box-shadow:0 0 8px ${c}55;"
           onclick="applyTheme('${currentTheme}','${c}')"></div>
    `).join('') + `
      <div class="accent-dot-btn ${!currentAccent ? 'active' : ''}"
           style="background:var(--green-dim);border:1px dashed var(--border2);font-size:10px;display:flex;align-items:center;justify-content:center;color:var(--text3);"
           onclick="applyTheme('${currentTheme}','')">AUTO</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USER PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let userProfile = JSON.parse(localStorage.getItem('forge_profile') || '{}');

function saveProfile() {
  userProfile.name   = document.getElementById('profile-name')?.value.trim() || '';
  userProfile.dob    = document.getElementById('profile-dob')?.value || '';
  userProfile.height = parseFloat(document.getElementById('profile-height')?.value) || 0;
  userProfile.heightUnit = document.getElementById('profile-height-unit')?.value || 'cm';
  userProfile.goal   = document.getElementById('profile-goal')?.value || '';
  localStorage.setItem('forge_profile', JSON.stringify(userProfile));
  renderProfile();
}

function renderProfile() {
  const nameInput  = document.getElementById('profile-name');
  const dobInput   = document.getElementById('profile-dob');
  const htInput    = document.getElementById('profile-height');
  const htUnit     = document.getElementById('profile-height-unit');
  const goalSel    = document.getElementById('profile-goal');
  if (!nameInput) return;
  nameInput.value  = userProfile.name || '';
  dobInput.value   = userProfile.dob  || '';
  htInput.value    = userProfile.height || '';
  if (htUnit) htUnit.value = userProfile.heightUnit || 'cm';
  if (goalSel) goalSel.value = userProfile.goal || '';

  // Display name + XP in profile header
  const xp = calcXP();
  const lvl = getCurrentLevel(xp);
  const nameDisplay = document.getElementById('profile-name-display');
  if (nameDisplay) nameDisplay.textContent = userProfile.name || (currentLang === 'ar' ? 'Ø±ÙŠØ§Ø¶ÙŠ' : 'Athlete');
  const _profIsAr = (typeof currentLang !== 'undefined') && currentLang === 'ar';
  const _profRank = _profIsAr ? (lvl.nameAr || lvl.name) : lvl.name;
  const xpMini = document.getElementById('profile-xp-mini');
  if (xpMini) xpMini.textContent = xp + ' XP Â· ' + _profRank;
  const badge = document.getElementById('profile-level-badge');
  if (badge) { badge.textContent = lvl.icon + ' ' + _profRank; badge.style.color = lvl.color; }
  const avatar = document.getElementById('profile-avatar');
  if (avatar) avatar.textContent = lvl.icon;

  // Update header greeting with user's first name
  const greeting = document.getElementById('header-greeting');
  if (greeting) {
    const hour = new Date().getHours();
    const timeGreet = hour < 12 ? 'Morning' : hour < 17 ? 'Afternoon' : 'Evening';
    const firstName = (userProfile.name || '').split(' ')[0];
    greeting.textContent = firstName ? '// ' + timeGreet + ', ' + firstName : '// Gym OS';
  }

  // Age hint
  const ageHint = document.getElementById('profile-age-hint');
  if (ageHint && userProfile.dob) {
    const dob = new Date(userProfile.dob);
    const age = Math.floor((Date.now() - dob) / 31557600000);
    if (age > 0 && age < 120) ageHint.textContent = age + ' years old';
    else ageHint.textContent = '';
  } else if (ageHint) ageHint.textContent = '';

  // Computed stats
  const computed = document.getElementById('profile-computed');
  const hasData = userProfile.dob || userProfile.height;
  if (computed) computed.style.display = hasData ? 'grid' : 'none';

  if (userProfile.dob && userProfile.height) {
    const dob = new Date(userProfile.dob);
    const age = Math.floor((Date.now() - dob) / 31557600000);
    const htCm = userProfile.heightUnit === 'ft'
      ? userProfile.height * 30.48
      : userProfile.height;

    // BMI using latest body weight
    const lastBW = bodyWeight.length ? bodyWeight[bodyWeight.length-1] : null;
    if (lastBW) {
      const wtKg = lastBW.unit === 'lbs' ? lastBW.weight * 0.4536 : lastBW.weight;
      const bmi = (wtKg / ((htCm/100)**2)).toFixed(1);
      const bmiEl = document.getElementById('pc-bmi');
      if (bmiEl) bmiEl.textContent = bmi;
    }
    const ageEl = document.getElementById('pc-age');
    if (ageEl) ageEl.textContent = age > 0 ? age + 'y' : 'â€”';

    // Rough TDEE (Harris-Benedict)
    const lastBWkg = lastBW ? (lastBW.unit === 'lbs' ? lastBW.weight * 0.4536 : lastBW.weight) : 70;
    const bmr = 10 * lastBWkg + 6.25 * htCm - 5 * Math.max(15, age);
    const tdee = Math.round(bmr * 1.55);
    const tdeeEl = document.getElementById('pc-tdee');
    if (tdeeEl) tdeeEl.textContent = tdee + ' kcal';
  }
}

// Profile rendering hook â€” called from switchView

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BODY COMPOSITION (body fat + muscle mass)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentBcompChart = 'weight';

function logBodyWeight() {
  const val  = parseFloat(document.getElementById('bw-input').value);
  const unit = document.getElementById('bw-unit').value;
  const bf   = parseFloat(document.getElementById('bf-input')?.value) || null;
  const mm   = parseFloat(document.getElementById('mm-input')?.value) || null;

  if (!val || val < 20 || val > 500) { showToast('Enter a valid weight!'); return; }
  const entry = { date: new Date().toISOString(), weight: val, unit };
  if (bf !== null && bf > 0) entry.bodyFat = bf;
  if (mm !== null && mm > 0) entry.muscleMass = mm;

  bodyWeight.push(entry);
  save();

  document.getElementById('bw-input').value = '';
  const bfInput = document.getElementById('bf-input');
  const mmInput = document.getElementById('mm-input');
  if (bfInput) bfInput.value = '';
  if (mmInput) mmInput.value = '';

  showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ø³Ù…!' : 'Body composition logged!');
  syncMmUnit();
  renderBcompChart(currentBcompChart);
  renderBWHistory();
  renderCompCards();
}

function syncMmUnit() {
  const unit = document.getElementById('bw-unit')?.value || 'kg';
  const lbl  = document.getElementById('mm-unit-lbl');
  if (lbl) lbl.textContent = unit;
}

function switchBcompChart(type, btn) {
  currentBcompChart = type;
  document.querySelectorAll('.bcomp-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderBcompChart(type);
}

function renderBcompChart(type) {
  // Destroy old chart instance before creating new
  if (bwChrt) { bwChrt.destroy(); bwChrt = null; }
  const ctx  = document.getElementById('bw-chart');
  if (!ctx) return;
  const c = ctx.getContext('2d');
  const data = [...bodyWeight].slice(-30);
  if (!data.length) return;

  let values, color, label;
  if (type === 'weight') {
    values = data.map(d => d.weight);
    color = '#39ff8f'; label = 'Body Weight';
  } else if (type === 'bodyfat') {
    const filtered = data.filter(d => d.bodyFat);
    if (!filtered.length) { showToast('â„¹ï¸ No body fat data yet'); return; }
    values = filtered.map(d => d.bodyFat);
    color = '#f39c12'; label = 'Body Fat %';
    data.length = 0; data.push(...filtered);
  } else {
    const filtered = data.filter(d => d.muscleMass);
    if (!filtered.length) { showToast('â„¹ï¸ No muscle mass data yet'); return; }
    values = filtered.map(d => d.muscleMass);
    color = '#2ecc71'; label = 'Muscle Mass';
    data.length = 0; data.push(...filtered);
  }

  const grad = c.createLinearGradient(0,0,0,180);
  grad.addColorStop(0, hexToRgba(color, 0.25));
  grad.addColorStop(1, hexToRgba(color, 0));
  bwChrt = new Chart(c, {
    type:'line',
    data:{
      labels: data.map(d => new Date(d.date).toLocaleDateString('en-GB',{month:'short',day:'numeric'})),
      datasets:[{
        label, data: values,
        borderColor:color, borderWidth:2, backgroundColor:grad,
        fill:true, tension:.4, pointBackgroundColor:color, pointRadius:4, pointHoverRadius:7
      }]
    },
    options: mkChartOpts()
  });
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// Keep renderBWChart as alias for backward compat
function renderBWChart() { renderBcompChart(currentBcompChart); }

function renderCompCards() {
  if (!bodyWeight.length) return;
  const last = bodyWeight[bodyWeight.length-1];
  const prev = bodyWeight.length > 1 ? bodyWeight[bodyWeight.length-2] : null;

  // Body weight
  const bwVal = document.getElementById('comp-bw-val');
  const bwTrend = document.getElementById('comp-bw-trend');
  if (bwVal) bwVal.textContent = last.weight + ' ' + last.unit;
  if (bwTrend && prev) {
    const diff = (last.weight - prev.weight).toFixed(1);
    bwTrend.textContent = diff > 0 ? '+' + diff : diff;
    bwTrend.style.color = diff > 0 ? 'var(--warn)' : 'var(--green)';
  }

  // Body fat
  const bfVal = document.getElementById('comp-bf-val');
  const bfTrend = document.getElementById('comp-bf-trend');
  const lastBF = [...bodyWeight].reverse().find(d => d.bodyFat);
  const prevBF = bodyWeight.slice(0,-1).reverse().find(d => d.bodyFat);
  if (bfVal) bfVal.textContent = lastBF ? lastBF.bodyFat + '%' : 'â€”';
  if (bfTrend && lastBF && prevBF) {
    const diff = (lastBF.bodyFat - prevBF.bodyFat).toFixed(1);
    bfTrend.textContent = diff > 0 ? '+' + diff + '%' : diff + '%';
    bfTrend.style.color = diff > 0 ? 'var(--danger)' : 'var(--green)';
  }

  // Muscle mass
  const mmVal = document.getElementById('comp-mm-val');
  const mmTrend = document.getElementById('comp-mm-trend');
  const lastMM = [...bodyWeight].reverse().find(d => d.muscleMass);
  const prevMM = bodyWeight.slice(0,-1).reverse().find(d => d.muscleMass);
  if (mmVal) mmVal.textContent = lastMM ? lastMM.muscleMass + ' kg' : 'â€”';
  if (mmTrend && lastMM && prevMM) {
    const diff = (lastMM.muscleMass - prevMM.muscleMass).toFixed(1);
    mmTrend.textContent = diff > 0 ? '+' + diff + ' kg' : diff + ' kg';
    mmTrend.style.color = diff > 0 ? 'var(--green)' : 'var(--text3)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MUSCLE DETAIL OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let overlayMuscle = '';

function openMuscleOverlay(muscle) {
  overlayMuscle = muscle;
  const overlay = document.getElementById('muscle-overlay');

  // Header
  document.getElementById('mo-icon').innerHTML = MUSCLE_ICONS[muscle] || MUSCLE_ICONS['Chest'];
  document.getElementById('mo-name').textContent = muscle.toUpperCase();

  // Stats strip
  const sessions = workouts.filter(w => w.muscle === muscle);
  const totalVol = sessions.reduce((a,w) => a + w.totalVolume, 0);
  const allWeights = sessions.flatMap(w => w.sets.map(s => s.weight));
  const pr = allWeights.length ? Math.max(...allWeights) : null;
  const lastDate = sessions.length
    ? new Date(Math.max(...sessions.map(w => new Date(w.date))))
    : null;

  document.getElementById('mo-sub').textContent = sessions.length + ' session' + (sessions.length !== 1 ? 's' : '') + ' logged';
  document.getElementById('mo-stat-sessions').textContent = sessions.length;
  document.getElementById('mo-stat-vol').textContent = Math.round(totalVol) + (sessions[0]?.sets[0]?.unit || 'kg');
  document.getElementById('mo-stat-pr').textContent = pr ? pr + (sessions.slice(-1)[0]?.sets[0]?.unit || 'kg') : 'â€”';
  document.getElementById('mo-stat-last').textContent = lastDate
    ? lastDate.toLocaleDateString('en-GB',{day:'numeric',month:'short'})
    : 'â€”';

  // Reset to history tab
  moSwitchTab('history', overlay.querySelector('.mo-tab'));
  renderOverlayHistory(muscle);

  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeMuscleOverlay() {
  document.getElementById('muscle-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

function moSwitchTab(tab, btn) {
  document.querySelectorAll('.mo-content').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.mo-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('mo-tab-' + tab).style.display = 'block';
  if (btn) btn.classList.add('active');

  if (tab === 'tips') renderOverlayTips(overlayMuscle);
  if (tab === 'exercises') renderOverlayExercises(overlayMuscle);
}

function renderOverlayHistory(muscle) {
  const list = document.getElementById('mo-history-list');
  const sessions = [...workouts]
    .filter(w => w.muscle === muscle)
    .sort((a,b) => new Date(b.date) - new Date(a.date));

  if (!sessions.length) {
    list.innerHTML = '<div class="mo-empty"><div class="mo-empty-icon">' + (MUSCLE_ICONS[muscle]||'ğŸ’ª') + '</div>No ' + muscle + ' workouts yet.<br>Select this muscle and log your first set!</div>';
    return;
  }

  // Group by exercise
  const byEx = new Map();
  sessions.forEach(w => {
    if (!byEx.has(w.exercise)) byEx.set(w.exercise, []);
    byEx.get(w.exercise).push(w);
  });

  let html = '';
  byEx.forEach((exSessions, exName) => {
    const shown = exSessions.slice(0, 3);
    html += '<div class="mo-history-exercise">';
    html += '<div class="mo-ex-title-bar"><span class="mo-ex-title-name">' + exName + '</span><span class="mo-ex-title-count">' + exSessions.length + ' SESSION' + (exSessions.length!==1?'S':'') + '</span></div>';
    shown.forEach(w => {
      const dateStr = new Date(w.date).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
      const vol = Math.round(w.totalVolume);
      const unit = w.sets[0]?.unit || 'kg';
      html += '<div class="mo-session-card">';
      html += '<div class="mo-session-meta"><span class="mo-session-date"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:3px;opacity:.7;"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' + dateStr + '</span>';
      html += '<div style="display:flex;align-items:center;gap:8px;">';
      if (w.isPR) html += '<span class="mo-session-pr"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:2px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"/></svg> PR</span>';
      html += '<span class="mo-session-vol">Vol: ' + vol + unit + '</span></div></div>';
      html += '<div class="mo-sets-grid-hdr"><span>#</span><span>REPS</span><span>WEIGHT</span><span>VOL</span></div>';
      html += '<div class="mo-sets-grid">';
      w.sets.forEach((s, i) => {
        html += '<div class="mo-set-num">' + (i+1) + '</div>';
        html += '<div class="mo-set-val">' + s.reps + '</div>';
        html += '<div class="mo-set-val">' + s.weight + s.unit + '</div>';
        html += '<div class="mo-set-val">' + Math.round(s.reps*s.weight) + '</div>';
      });
      html += '</div>';
      if (w.notes) html += '<div style="font-family:\'DM Mono\',monospace;font-size:9px;color:var(--text3);margin-top:8px;">' + w.notes + '</div>';
      html += '</div>';
    });
    if (exSessions.length > 3) {
      html += '<button class="mo-show-more" data-ex="' + exName.replace(/"/g,'&quot;') + '" onclick="moShowAllSessions(this)">â–¼ Show all ' + exSessions.length + ' sessions</button>';
    }
    html += '</div>';
  });
  list.innerHTML = html;
}

function moShowAllSessions(btn) {
  const exName = btn.dataset.ex;
  const exSessions = [...workouts].filter(w => w.exercise === exName).sort((a,b) => new Date(b.date)-new Date(a.date));
  const container = btn.closest('.mo-history-exercise');
  const titleBar = container.querySelector('.mo-ex-title-bar');
  let html = '';
  exSessions.forEach(w => {
    const dateStr = new Date(w.date).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
    const vol = Math.round(w.totalVolume);
    const unit = w.sets[0]?.unit || 'kg';
    html += '<div class="mo-session-card">';
    html += '<div class="mo-session-meta"><span class="mo-session-date"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:3px;opacity:.7;"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' + dateStr + '</span>';
    html += '<div style="display:flex;align-items:center;gap:8px;">';
    if (w.isPR) html += '<span class="mo-session-pr"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:2px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"/></svg> PR</span>';
    html += '<span class="mo-session-vol">Vol: ' + vol + unit + '</span></div></div>';
    html += '<div class="mo-sets-grid-hdr"><span>#</span><span>REPS</span><span>WEIGHT</span><span>VOL</span></div>';
    html += '<div class="mo-sets-grid">';
    w.sets.forEach((s, i) => {
      html += '<div class="mo-set-num">' + (i+1) + '</div>';
      html += '<div class="mo-set-val">' + s.reps + '</div>';
      html += '<div class="mo-set-val">' + s.weight + s.unit + '</div>';
      html += '<div class="mo-set-val">' + Math.round(s.reps*s.weight) + '</div>';
    });
    html += '</div>';
    if (w.notes) html += '<div style="font-family:\'DM Mono\',monospace;font-size:9px;color:var(--text3);margin-top:8px;">' + w.notes + '</div>';
    html += '</div>';
  });
  container.innerHTML = '';
  container.appendChild(titleBar);
  container.insertAdjacentHTML('beforeend', html);
}

function renderOverlayTips(muscle) {
  const tips = TIPS[muscle] || [
    {icon:'ğŸ¯',title:'Progressive Overload',text:'Add 2.5â€“5 kg every 2 weeks. Small gains compound into massive results.'},
    {icon:'â±ï¸',title:'Use the Rest Timer',text:'Consistent rest periods (60â€“120s) improve performance across sets.'}
  ];
  document.getElementById('mo-tips-list').innerHTML = tips.map(t =>
    '<div class="tip-card"><div class="tip-icon">' + t.icon + '</div><div><div class="tip-title">' + t.title + '</div><div class="tip-text">' + t.text + '</div></div></div>'
  ).join('');
}

function renderOverlayExercises(muscle) {
  const sessions = workouts.filter(w => w.muscle === muscle);
  if (!sessions.length) {
    document.getElementById('mo-exercises-list').innerHTML = '<div class="mo-empty"><div class="mo-empty-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>No exercises logged yet.</div>';
    return;
  }
  // Group by exercise, get PR and session count
  const exMap = {};
  sessions.forEach(w => {
    if (!exMap[w.exercise]) exMap[w.exercise] = { sessions: 0, pr: 0, unit: 'kg' };
    exMap[w.exercise].sessions++;
    const maxW = Math.max(...w.sets.map(s => s.weight));
    if (maxW > exMap[w.exercise].pr) { exMap[w.exercise].pr = maxW; exMap[w.exercise].unit = w.sets[0]?.unit || 'kg'; }
  });
  const sorted = Object.entries(exMap).sort((a,b) => b[1].sessions - a[1].sessions);
  document.getElementById('mo-exercises-list').innerHTML = sorted.map(([name, data]) =>
    '<div class="mo-ex-item"><div><div class="mo-ex-name">' + name + '</div><div class="mo-ex-stats">' + data.sessions + ' sessions Â· PR: ' + data.pr + data.unit + '</div></div><div class="mo-ex-pr">' + data.pr + '<span style="font-size:10px;color:var(--text3);"> ' + data.unit + '</span></div></div>'
  ).join('');
}

function startWorkoutFromOverlay() {
  closeMuscleOverlay();
  // Select this muscle + switch to log tab (fromOverlay=true skips re-opening overlay)
  selectMuscle(overlayMuscle, true);
  switchView('log', document.getElementById('bnav-log'));
  setTimeout(() => {
    const exInput = document.getElementById('exercise-name');
    if (exInput) exInput.focus();
  }, 400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderTemplates();
updateStatBar();
postSaveHooks();   // renders XP bar, missions, coach on startup
renderTimer();
syncMmUnit();
renderCompCards();
renderProfile();   // sets header greeting + avatar on startup
applyTheme(currentTheme, currentAccent); // apply saved theme on load
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FX OVERLAY ELEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<canvas id="fx-canvas"></canvas>
<div id="save-flash"></div>
<div id="pr-flash"></div>
<div id="theme-wipe"></div>
<div id="levelup-overlay">
  <div class="levelup-card">
    <div class="levelup-icon" id="levelup-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
    <div class="levelup-title">LEVEL UP!</div>
    <div class="levelup-name" id="levelup-rank">WARRIOR</div>
    <div class="levelup-sub">You've reached the next tier</div>
  </div>
</div>
<button class="sound-toggle" id="sound-toggle" onclick="toggleSound()" title="Toggle sound">
  <svg id="sound-icon-on" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
    <path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/>
  </svg>
  <svg id="sound-icon-off" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
    <line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>
  </svg>
</button>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORGE FX ENGINE  â€” Sound Â· Ripple Â· Particles Â· Glow
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SOUND ENGINE  (Web Audio API â€” no files)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _audioCtx = null;
let soundOn = (localStorage.getItem('forge_sound') !== 'off');

function _ctx() {
  if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (_audioCtx.state === 'suspended') _audioCtx.resume();
  return _audioCtx;
}

/* Master volume envelope helper */
function _note(freq, type, startVol, endVol, startT, duration) {
  const ctx = _ctx();
  const osc  = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, ctx.currentTime + startT);
  gain.gain.setValueAtTime(startVol, ctx.currentTime + startT);
  gain.gain.exponentialRampToValueAtTime(Math.max(endVol, 0.0001), ctx.currentTime + startT + duration);
  osc.start(ctx.currentTime + startT);
  osc.stop(ctx.currentTime + startT + duration + 0.02);
}

/* â”€â”€ 1. Tap click â€” soft tick â”€â”€ */
function sndTap() {
  if (!soundOn) return;
  _note(1200, 'sine', 0.08, 0.0001, 0, 0.06);
}

/* â”€â”€ 2. Set logged â€” punchy click â”€â”€ */
function sndSetLog() {
  if (!soundOn) return;
  _note(320, 'triangle', 0.18, 0.0001, 0,    0.08);
  _note(480, 'sine',     0.10, 0.0001, 0.04, 0.06);
}

/* â”€â”€ 3. Workout saved â€” rising chime â”€â”€ */
function sndSave() {
  if (!soundOn) return;
  const notes = [523.25, 659.25, 783.99, 1046.5]; // C5 E5 G5 C6
  notes.forEach((f, i) => _note(f, 'sine', 0.22, 0.0001, i * 0.09, 0.22));
}

/* â”€â”€ 4. PR fanfare â€” triumphant burst â”€â”€ */
function sndPR() {
  if (!soundOn) return;
  // Brass stab
  [[392,0],[523,0.05],[659,0.1],[784,0.15],[1047,0.22]].forEach(([f,t]) => {
    _note(f, 'sawtooth', 0.25, 0.01, t,    0.18);
    _note(f, 'sine',     0.12, 0.01, t,    0.25);
  });
  // Shimmer
  [1318, 1568, 2093].forEach((f, i) => _note(f, 'sine', 0.07, 0.0001, 0.3 + i*0.07, 0.3));
}

/* â”€â”€ 5. Level-up â€” epic ascending â”€â”€ */
function sndLevelUp() {
  if (!soundOn) return;
  const melody = [261.63,329.63,392,523.25,659.25,783.99,1046.5,1318.51];
  melody.forEach((f,i) => {
    _note(f, 'sine',     0.25, 0.0001, i*0.07, 0.25);
    _note(f*2, 'sine',   0.08, 0.0001, i*0.07, 0.20);
  });
  // Final chord hold
  [523.25,659.25,783.99].forEach(f => _note(f, 'sine', 0.15, 0.0001, 0.6, 0.6));
}

/* â”€â”€ 6. Theme switch â€” swoosh â”€â”€ */
function sndThemeSwitch() {
  if (!soundOn) return;
  const ctx = _ctx();
  const osc  = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = 'sine';
  osc.frequency.setValueAtTime(200, ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.3);
  gain.gain.setValueAtTime(0.0001, ctx.currentTime);
  gain.gain.linearRampToValueAtTime(0.18,  ctx.currentTime + 0.05);
  gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.32);
  osc.start(ctx.currentTime);
  osc.stop(ctx.currentTime + 0.35);
}

/* â”€â”€ 7. Timer done â€” alert triple beep â”€â”€ */
function sndTimerDone() {
  if (!soundOn) return;
  [0, 0.18, 0.36].forEach(t => {
    _note(880,  'sine', 0.3, 0.0001, t,      0.12);
    _note(1100, 'sine', 0.2, 0.0001, t+0.06, 0.08);
  });
}

/* â”€â”€ Sound toggle â”€â”€ */
function toggleSound() {
  soundOn = !soundOn;
  localStorage.setItem('forge_sound', soundOn ? 'on' : 'off');
  document.getElementById('sound-icon-on').style.display  = soundOn ? '' : 'none';
  document.getElementById('sound-icon-off').style.display = soundOn ? 'none' : '';
  document.getElementById('sound-toggle').classList.toggle('muted', !soundOn);
  if (soundOn) sndTap();
}

/* Init sound button state */
(function initSoundBtn() {
  const btn = document.getElementById('sound-toggle');
  if (!btn) return;
  document.getElementById('sound-icon-on').style.display  = soundOn ? '' : 'none';
  document.getElementById('sound-icon-off').style.display = soundOn ? 'none' : '';
  btn.classList.toggle('muted', !soundOn);
})();


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RIPPLE EFFECT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addRipple(el, e) {
  if (!el) return;
  /* ensure host has position:relative and overflow:hidden */
  const cs = getComputedStyle(el);
  if (cs.position === 'static') el.style.position = 'relative';
  el.style.overflow = 'hidden';

  const rect = el.getBoundingClientRect();
  const x = (e?.clientX ?? rect.left + rect.width  / 2) - rect.left;
  const y = (e?.clientY ?? rect.top  + rect.height / 2) - rect.top;
  const size = Math.max(rect.width, rect.height) * 1.6;

  const ripple = document.createElement('span');
  ripple.className = 'ripple';
  ripple.style.cssText = `
    width:${size}px; height:${size}px;
    left:${x - size/2}px; top:${y - size/2}px;
    animation:rippleAnim .55s ease-out forwards;
  `;
  el.appendChild(ripple);
  ripple.addEventListener('animationend', () => ripple.remove());
}

/* Wire ripple to all nav + action buttons on load */
function initRipples() {
  const selectors = [
    '.bnav-btn', '.btn', '.timer-preset-btn',
    '.muscle-card', '.body-zone', '.template-card',
    '.coach-tab', '.theme-swatch', '.accent-dot-btn',
    '.mo-tab', '.set-add-btn', '.ind-card'
  ];
  document.addEventListener('pointerdown', (e) => {
    const target = e.target.closest(selectors.join(','));
    if (target) {
      addRipple(target, e);
      sndTap();
    }
  }, { passive: true });
}
initRipples();


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PARTICLE BURST  (canvas confetti)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fxCanvas = document.getElementById('fx-canvas');
const fxCtx    = fxCanvas ? fxCanvas.getContext('2d') : null;
let   particles = [];
let   fxRaf     = null;

function resizeFxCanvas() {
  if (!fxCanvas) return;
  fxCanvas.width  = window.innerWidth;
  fxCanvas.height = window.innerHeight;
}
resizeFxCanvas();
window.addEventListener('resize', resizeFxCanvas, { passive: true });

function spawnParticles(x, y, count, colorList) {
  if (!fxCtx) return;
  const colors = colorList || [
    getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#39ff8f',
    '#ffffff', '#ffdd57', '#ff6b6b'
  ];
  for (let i = 0; i < count; i++) {
    const angle  = Math.random() * Math.PI * 2;
    const speed  = 3 + Math.random() * 7;
    const color  = colors[Math.floor(Math.random() * colors.length)];
    const size   = 3 + Math.random() * 5;
    const shape  = Math.random() > 0.5 ? 'circle' : 'rect';
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 3,
      color, size, shape,
      alpha: 1,
      gravity: 0.25,
      decay:   0.013 + Math.random() * 0.012,
      rot: Math.random() * Math.PI * 2,
      rotV: (Math.random() - 0.5) * 0.2
    });
  }
  if (!fxRaf) fxLoop();
}

function fxLoop() {
  if (!fxCtx) return;
  fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
  particles = particles.filter(p => p.alpha > 0.01);

  particles.forEach(p => {
    p.x  += p.vx;
    p.y  += p.vy;
    p.vy += p.gravity;
    p.vx *= 0.98;
    p.alpha -= p.decay;
    p.rot   += p.rotV;

    fxCtx.save();
    fxCtx.globalAlpha = Math.max(0, p.alpha);
    fxCtx.fillStyle   = p.color;
    fxCtx.translate(p.x, p.y);
    fxCtx.rotate(p.rot);

    if (p.shape === 'circle') {
      fxCtx.beginPath();
      fxCtx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
      fxCtx.fill();
    } else {
      fxCtx.fillRect(-p.size/2, -p.size/3, p.size, p.size * 0.6);
    }
    fxCtx.restore();
  });

  if (particles.length > 0) {
    fxRaf = requestAnimationFrame(fxLoop);
  } else {
    fxRaf = null;
    fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
  }
}

/* Burst helpers */
function burstSave() {
  /* centre-bottom burst */
  const x = window.innerWidth / 2;
  const y = window.innerHeight * 0.72;
  const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#39ff8f';
  spawnParticles(x, y, 55, [accent, '#ffffff', '#aaffdd', '#ffdd57']);
}

function burstPR(btnEl) {
  const rect = btnEl ? btnEl.getBoundingClientRect() : { left: window.innerWidth/2, top: window.innerHeight/2, width:0, height:0 };
  const x = rect.left + rect.width  / 2;
  const y = rect.top  + rect.height / 2;
  spawnParticles(x, y, 90, ['#f39c12','#ffdd57','#ff6b6b','#ffffff','#ffd700']);
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SCREEN FLASH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flashSave() {
  const el = document.getElementById('save-flash');
  if (!el) return;
  el.classList.remove('flash');
  void el.offsetWidth; // reflow
  el.classList.add('flash');
  el.addEventListener('animationend', () => el.classList.remove('flash'), { once: true });
}

function flashPR() {
  const el = document.getElementById('pr-flash');
  if (!el) return;
  el.classList.remove('flash');
  void el.offsetWidth;
  el.classList.add('flash');
  el.addEventListener('animationend', () => el.classList.remove('flash'), { once: true });
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LEVEL-UP OVERLAY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLevelUp(rankName, icon) {
  const overlay = document.getElementById('levelup-overlay');
  const rankEl  = document.getElementById('levelup-rank');
  const iconEl  = document.getElementById('levelup-icon');
  if (!overlay) return;
  if (rankEl) rankEl.textContent = rankName || 'WARRIOR';
  if (iconEl) iconEl.textContent = icon || 'âš¡';
  overlay.classList.remove('show');
  void overlay.offsetWidth;
  overlay.classList.add('show');
  overlay.addEventListener('animationend', () => overlay.classList.remove('show'), { once: true });

  /* Gold confetti rain */
  for (let i = 0; i < 4; i++) {
    setTimeout(() => {
      const x = Math.random() * window.innerWidth;
      spawnParticles(x, -10, 20, ['#ffd700','#ffdd57','#f39c12','#ffffff',
        getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()]);
    }, i * 180);
  }
  sndLevelUp();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BODYWEIGHT EXERCISE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BW_EXERCISES = [
  { name:'Push-Ups',    icon:'ğŸ¤¸', muscle:'Chest'    },
  { name:'Pull-Ups',    icon:'ğŸ‹ï¸', muscle:'Back'     },
  { name:'Burpees',     icon:'âš¡', muscle:'Core'     },
  { name:'Dips',        icon:'ğŸ’ª', muscle:'Triceps'  },
  { name:'Squats',      icon:'ğŸ¦µ', muscle:'Legs'     },
  { name:'Lunges',      icon:'ğŸš¶', muscle:'Legs'     },
  { name:'Plank',       icon:'ğŸ”¥', muscle:'Core'     },
  { name:'Sit-Ups',     icon:'ğŸ§˜', muscle:'Core'     },
  { name:'Chin-Ups',    icon:'ğŸ”', muscle:'Biceps'   },
  { name:'Handstand Push-Ups', icon:'ğŸ™ƒ', muscle:'Shoulders' },
  { name:'Pike Push-Ups', icon:'ğŸ¯', muscle:'Shoulders' },
  { name:'Jump Squats', icon:'ğŸ¦˜', muscle:'Legs'     },
  { name:'Mountain Climbers', icon:'ğŸ§—', muscle:'Core' },
  { name:'Box Jumps',   icon:'ğŸ“¦', muscle:'Legs'     },
  { name:'Free Squats', icon:'ğŸ¦¿', muscle:'Legs'     },
];

let workoutMode = 'weighted'; // 'weighted' | 'bodyweight'
let bwSetCount = 0;

function setWorkoutMode(mode) {
  workoutMode = mode;
  const isWgt = mode === 'weighted';

  document.getElementById('mode-btn-weighted').classList.toggle('active', isWgt);
  document.getElementById('mode-btn-bodyweight').classList.toggle('active', !isWgt);

  // Toggle UI sections
  document.getElementById('weighted-sets-section').style.display = isWgt ? '' : 'none';
  document.getElementById('bw-sets-section').style.display       = isWgt ? 'none' : '';
  document.getElementById('bw-exercise-picker').style.display     = isWgt ? 'none' : '';
  document.getElementById('bw-stats-area').style.display          = isWgt ? 'none' : '';

  // Body map: hide in BW mode, show in weighted
  const bodyMapSection = document.getElementById('section-bodymap');
  const bodyTapHint    = document.getElementById('body-tap-hint-el');
  if (bodyMapSection) bodyMapSection.style.display = isWgt ? '' : 'none';
  if (bodyTapHint)    bodyTapHint.style.display    = isWgt ? '' : 'none';

  // Update panel title + placeholder
  document.getElementById('exercise-panel-title').textContent = isWgt ? 'Exercise Entry' : 'Bodyweight Exercise';
  const exInput = document.getElementById('exercise-name');
  if (exInput) exInput.placeholder = isWgt ? 'e.g. Bench Press, Squatâ€¦' : 'e.g. Push-Ups, Burpeesâ€¦';

  if (!isWgt) {
    renderBwExercisePicker();
    renderBwStats();
    // Clear weighted sets
    document.getElementById('sets-container').innerHTML = '';
    setCount = 0;
    document.getElementById('set-count-badge').textContent = '0 SETS';
    selectedMuscle = '';
  } else {
    // Clear BW sets
    document.getElementById('bw-sets-container').innerHTML = '';
    bwSetCount = 0;
    document.getElementById('set-count-badge').textContent = '0 SETS';
    selectedMuscle = '';
  }
  // Reset exercise name
  document.getElementById('exercise-name').value = '';
  document.getElementById('last-session-hint').style.display = 'none';
}

function renderBwExercisePicker() {
  const grid = document.getElementById('bw-exercises-grid');
  if (!grid) return;
  const currentEx = document.getElementById('exercise-name').value.trim();
  grid.innerHTML = BW_EXERCISES.map(ex => `
    <button class="bw-ex-btn ${currentEx.toLowerCase()===ex.name.toLowerCase()?'selected':''}"
            onclick="pickBwExercise('${ex.name}','${ex.muscle}')">
      <span class="bw-ex-icon">${ex.icon}</span>
      <span>${ex.name.replace(' ','\n')}</span>
    </button>`).join('');
}

function pickBwExercise(name, muscle) {
  document.getElementById('exercise-name').value = name;
  // Auto-select muscle
  selectedMuscle = muscle;
  renderBwExercisePicker();
  renderBwLastSession(name);
  renderBwStats();
  // Pre-fill from last BW session
  const bwPrev = (bwWorkouts || []).slice().reverse().find(w => w.exercise.toLowerCase() === name.toLowerCase());
  if (bwPrev && document.querySelectorAll('#bw-sets-container .bw-set-row').length === 0) {
    bwSetCount = 0;
    document.getElementById('bw-sets-container').innerHTML = '';
    bwPrev.sets.forEach(s => addBwSet(s.reps, s.effort));
  }
}

function renderBwLastSession(name) {
  const prev = (bwWorkouts || []).slice().reverse().find(w => w.exercise.toLowerCase() === name.toLowerCase());
  const hint = document.getElementById('last-session-hint');
  if (!prev || !settings.showHint) { hint.style.display = 'none'; return; }
  const d = new Date(prev.date).toLocaleDateString('en-GB',{month:'short',day:'numeric'});
  const totalReps = prev.sets.reduce((a,s) => a+s.reps, 0);
  const maxReps   = Math.max(...prev.sets.map(s => s.reps));
  hint.style.display = 'block';
  document.getElementById('last-session-content').innerHTML =
    `<b>${d}</b> &nbsp; ${prev.sets.length} sets Â· ${totalReps} total reps Â· Max ${maxReps} reps/set`;
}

function addBwSet(reps, effort) {
  bwSetCount++;
  document.getElementById('set-count-badge').textContent = bwSetCount + ' SETS';
  const container = document.getElementById('bw-sets-container');
  const row = document.createElement('div');
  row.className = 'bw-set-row'; row.id = 'bw-set-' + bwSetCount;
  const prevRow = container.querySelector('.bw-set-row:last-child');
  const prevReps = reps !== undefined ? reps : (prevRow ? prevRow.querySelector('.bw-reps').value : '');
  const prevEff  = effort !== undefined ? effort : (prevRow ? prevRow.querySelector('.bw-effort').value : 'medium');
  row.innerHTML = `
    <div class="set-num">${bwSetCount}</div>
    <input type="number" min="1" inputmode="numeric" placeholder="10" class="bw-reps" value="${prevReps}">
    <select class="bw-effort" style="padding:8px 4px;font-size:13px;">
      <option value="easy" ${prevEff==='easy'?'selected':''}>Easy</option>
      <option value="medium" ${!prevEff||prevEff==='medium'?'selected':''}>Medium</option>
      <option value="hard" ${prevEff==='hard'?'selected':''}>Hard</option>
      <option value="fail" ${prevEff==='fail'?'selected':''}>Failure</option>
    </select>
    <button class="btn-icon" onclick="removeBwSet(${bwSetCount})">Ã—</button>
  `;
  container.appendChild(row);
  row.querySelector('.bw-reps').focus();
}

function removeBwSet(id) {
  const el = document.getElementById('bw-set-' + id);
  if (el) el.remove();
  const rows = document.querySelectorAll('#bw-sets-container .bw-set-row');
  bwSetCount = rows.length;
  rows.forEach((r,i) => r.querySelector('.set-num').textContent = i+1);
  document.getElementById('set-count-badge').textContent = bwSetCount + ' SETS';
}

function renderBwStats() {
  const statsArea = document.getElementById('bw-stats-area');
  const statsStrip = document.getElementById('bw-stats-strip');
  if (!statsStrip) return;
  const name = document.getElementById('exercise-name').value.trim();
  const sessions = (bwWorkouts || []).filter(w => !name || w.exercise.toLowerCase() === name.toLowerCase());
  if (!sessions.length) { statsArea.style.display = 'none'; return; }
  statsArea.style.display = '';
  const totalRepsAll = sessions.reduce((a,w) => a + w.sets.reduce((b,s) => b+s.reps, 0), 0);
  const maxEver = Math.max(...sessions.flatMap(w => w.sets.map(s => s.reps)));
  const totalSessions = sessions.length;
  statsStrip.innerHTML = `
    <div class="bw-stat-card"><div class="bw-stat-val">${totalSessions}</div><div class="bw-stat-lbl">Sessions</div></div>
    <div class="bw-stat-card"><div class="bw-stat-val">${totalRepsAll}</div><div class="bw-stat-lbl">Total Reps</div></div>
    <div class="bw-stat-card"><div class="bw-stat-val">${maxEver}</div><div class="bw-stat-lbl">Best Set</div></div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stepsData = JSON.parse(localStorage.getItem('forge_steps') || '{}');
// stepsData = { 'Mon Feb 17 2025': { steps: 8500, goal: 10000 }, ... }

const STEP_DEFAULTS = { goal: 10000, xpPer1k: 2 };

function todayStepsKey() { return today(); }

function getTodaySteps() {
  const key = todayStepsKey();
  return stepsData[key] || { steps: 0, goal: STEP_DEFAULTS.goal };
}

function saveSteps() {
  localStorage.setItem('forge_steps', JSON.stringify(stepsData));
}

function logSteps(amount) {
  const key = todayStepsKey();
  if (!stepsData[key]) stepsData[key] = { steps: 0, goal: STEP_DEFAULTS.goal };
  stepsData[key].steps = Math.max(0, stepsData[key].steps + amount);
  saveSteps();
  renderStepsPanel();
  postSaveHooks();
  if (stepsData[key].steps >= stepsData[key].goal) {
    showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø¯Ù Ø§Ù„Ø®Ø·ÙˆØ§Øª! +XP' : 'Daily step goal reached! +XP');
    if (typeof sndPR === 'function') sndPR();
  } else {
    showToast(typeof t==='function' && currentLang==='ar' ? `+${amount.toLocaleString()} Ø®Ø·ÙˆØ© Ù…Ø³Ø¬Ù„Ø©!` : `+${amount.toLocaleString()} steps logged!`);
  }
}

function setStepsGoal(newGoal) {
  const key = todayStepsKey();
  if (!stepsData[key]) stepsData[key] = { steps: 0, goal: STEP_DEFAULTS.goal };
  stepsData[key].goal = newGoal;
  saveSteps();
  renderStepsPanel();
}

function renderStepsPanel() {
  const el = document.getElementById('steps-panel');
  if (!el) return;
  const ts = getTodaySteps();
  const steps = ts.steps;
  const goal  = ts.goal || STEP_DEFAULTS.goal;
  const pct   = Math.min(100, Math.round((steps / goal) * 100));
  const remaining = Math.max(0, goal - steps);

  // Last 7 days streak
  let stepStreak = 0;
  for (let i = 0; i < 7; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const k = d.toDateString();
    if (stepsData[k] && stepsData[k].steps >= (stepsData[k].goal || STEP_DEFAULTS.goal)) stepStreak++;
    else if (i > 0) break;
  }

  // Estimate calories burned (rough: 0.04 kcal/step)
  const kcal = Math.round(steps * 0.04);
  // Estimate km (avg step length ~0.75m)
  const km = (steps * 0.00075).toFixed(1);

  const _lang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
  const _t = (typeof t === 'function') ? t : (k => k);
  const stepsWord   = _lang === 'ar' ? 'Ø®Ø·ÙˆØ©' : 'steps';
  const goalWord    = _lang === 'ar' ? 'Ø§Ù„Ù‡Ø¯Ù' : 'Goal';
  const complWord   = _lang === 'ar' ? 'Ù…ÙƒØªÙ…Ù„' : 'complete';
  const toGoWord    = _lang === 'ar' ? 'Ù…ØªØ¨Ù‚ÙŠØ©' : 'to go';
  const streakWord  = _lang === 'ar' ? 'ÙŠÙˆÙ…' : 'd';
  const logWord     = _lang === 'ar' ? 'ØªØ³Ø¬ÙŠÙ„' : 'Log';
  const logBtnWord  = _lang === 'ar' ? 'Ø³Ø¬Ù‘Ù„' : 'LOG';
  const _stepsSVG = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M13 4c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2z"/><path d="M7.5 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2z"/><path d="M15 6l-4 6 4 4-5 6"/><path d="M9 6l1 4-3 2 1 6"/></svg>`;
  const _gearSVG   = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:3px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`;
  const _fireSVG   = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:2px;"><path d="M12 2c0 0-7 6.5-7 12a7 7 0 0 0 14 0c0-5.5-7-12-7-12z"/><path d="M9.5 14.5c.5 1.5 2.5 2.5 4 1.5"/></svg>`;
  const goalBtnWord = _lang === 'ar' ? `${_gearSVG} Ø§Ù„Ù‡Ø¯Ù` : `${_gearSVG} Goal`;
  const titleWord   = _lang === 'ar' ? `${_stepsSVG} Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…` : `${_stepsSVG} TODAY'S STEPS`;
  const phWord      = _lang === 'ar' ? 'Ø®Ø·ÙˆØ§Øª Ù„Ù„Ø¥Ø¶Ø§ÙØ©...' : 'Steps to addâ€¦';

  el.innerHTML = `
    <div class="steps-header">
      <div class="steps-title">${titleWord}</div>
      <button class="steps-add-btn" onclick="openStepsInput()">+ ${logWord}</button>
    </div>
    <div class="steps-big-number">${steps.toLocaleString()}<span>${stepsWord}</span></div>
    <div class="steps-goal-label">${goalWord}: ${goal.toLocaleString()} Â· ${pct}% ${complWord}</div>
    <div class="steps-bar-wrap">
      <div class="steps-bar-fill" style="width:${pct}%;"></div>
    </div>
    <div class="steps-sub-row">
      <span class="steps-sub-stat"><b>${remaining.toLocaleString()}</b> ${toGoWord}</span>
      <span class="steps-sub-stat"><b>~${km}</b> km</span>
      <span class="steps-sub-stat"><b>${kcal}</b> kcal</span>
      ${stepStreak > 0 ? `<span class="steps-sub-stat">${_fireSVG}<b>${stepStreak}${streakWord}</b> streak</span>` : ''}
    </div>
    <div class="steps-input-row" id="steps-input-row" style="display:none;">
      <input type="number" id="steps-input" min="0" inputmode="numeric" placeholder="${phWord}">
      <button class="steps-log-btn" onclick="submitStepsInput()">${logBtnWord}</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
      <button onclick="logSteps(1000)" style="flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:5px;color:var(--text2);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;min-height:36px;">+1K</button>
      <button onclick="logSteps(2000)" style="flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:5px;color:var(--text2);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;min-height:36px;">+2K</button>
      <button onclick="logSteps(5000)" style="flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:5px;color:var(--text2);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;min-height:36px;">+5K</button>
      <button onclick="logSteps(10000)" style="flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:5px;color:var(--text2);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;min-height:36px;">+10K</button>
      <button onclick="openGoalSetter()" style="flex:0 0 auto;background:var(--panel);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:var(--text3);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;min-height:36px;">${goalBtnWord}</button>
    </div>
  `;
}

function openStepsInput() {
  const row = document.getElementById('steps-input-row');
  if (!row) return;
  row.style.display = row.style.display === 'none' ? '' : 'none';
  if (row.style.display !== 'none') {
    const inp = document.getElementById('steps-input');
    if (inp) { inp.value = ''; inp.focus(); }
  }
}

function submitStepsInput() {
  const inp = document.getElementById('steps-input');
  const val = parseInt(inp?.value);
  if (!val || val < 0) { showToast('Enter a valid step count!'); return; }
  logSteps(val);
  const row = document.getElementById('steps-input-row');
  if (row) row.style.display = 'none';
}

function openGoalSetter() {
  const goal = prompt('Set daily step goal:', getTodaySteps().goal || STEP_DEFAULTS.goal);
  const parsed = parseInt(goal);
  if (parsed && parsed > 0) {
    setStepsGoal(parsed);
    showToast(typeof t==='function' && currentLang==='ar' ? `Ù‡Ø¯Ù Ø§Ù„Ø®Ø·ÙˆØ§Øª: ${parsed.toLocaleString()}` : `Step goal set to ${parsed.toLocaleString()}!`);
  }
}

// XP from steps
function calcStepXP() {
  let xp = 0;
  Object.values(stepsData).forEach(d => {
    xp += Math.floor((d.steps || 0) / 1000) * STEP_DEFAULTS.xpPer1k;
    if (d.steps >= (d.goal || STEP_DEFAULTS.goal)) xp += 10; // bonus for hitting goal
  });
  return xp;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BODYWEIGHT WORKOUTS DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bwWorkouts = JSON.parse(localStorage.getItem('forge_bw_workouts') || '[]');

function saveBwData() {
  localStorage.setItem('forge_bw_workouts', JSON.stringify(bwWorkouts));
}

// Override saveWorkout to handle bodyweight mode
function saveWorkout() {
  if (workoutMode === 'bodyweight') {
    saveBwWorkout();
    return;
  }
  _saveWeightedWorkout();
}

function _saveWeightedWorkout() {
  const name  = document.getElementById('exercise-name').value.trim();
  const notes = document.getElementById('session-notes').value.trim();
  if (!selectedMuscle) { showToast('Select a muscle group first!'); return; }
  if (!name)            { showToast('Enter an exercise name!');      return; }
  const rows = document.querySelectorAll('.set-row');
  if (!rows.length)     { showToast('Add at least one set!');        return; }
  const sets = []; let valid = true;
  rows.forEach(r => {
    const reps   = parseFloat(r.querySelector('.set-reps').value);
    const weight = parseFloat(r.querySelector('.set-weight').value);
    const unit   = r.querySelector('.set-unit').value;
    if (!reps || !weight) { valid = false; return; }
    sets.push({ reps, weight, unit });
  });
  if (!valid) { showToast('Fill in all set values!'); return; }

  const btn = document.getElementById('save-btn');
  btn.classList.add('loading'); btn.textContent = 'Savingâ€¦';

  setTimeout(() => {
    const prevMax = workouts.filter(w => w.exercise === name).flatMap(w => w.sets.map(s => s.weight));
    const newMax  = Math.max(...sets.map(s => s.weight));
    const isPR    = prevMax.length === 0 || newMax > Math.max(...prevMax);

    workouts.push({
      id: Date.now(), date: new Date().toISOString(),
      muscle: selectedMuscle, exercise: name, sets, notes,
      totalVolume: sets.reduce((a,s) => a + s.reps * s.weight, 0), isPR
    });
    save();

    document.getElementById('exercise-name').value = '';
    document.getElementById('session-notes').value = '';
    document.getElementById('sets-container').innerHTML = '';
    document.getElementById('last-session-hint').style.display = 'none';
    closeAutocomplete();
    setCount = 0;
    document.getElementById('set-count-badge').textContent = '0 SETS';
    selectedMuscle = '';
    document.querySelectorAll('.body-zone').forEach(z => z.classList.remove('zone-selected'));
    const lbl = document.getElementById('body-selected-label');
    if (lbl) lbl.textContent = '';
    document.getElementById('selected-muscle-badge').textContent = 'TAP BODY';
    document.getElementById('muscle-history-panel').style.display = 'none';
    updateStatBar();
    postSaveHooks();

    btn.classList.remove('loading');
    btn.innerHTML = '<svg class="btn-icon-svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' + (typeof t==='function' && currentLang==='ar' ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'Log Workout');

    if (isPR) {
      showToast(typeof t==='function' ? (currentLang==='ar' ? 'Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'NEW PR! Workout logged!') : 'NEW PR! Workout logged!');
      if (typeof flashPR  === 'function') flashPR();
      if (typeof sndPR    === 'function') sndPR();
      if (typeof burstPR  === 'function') burstPR(btn);
    } else {
      showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†!' : 'Workout logged!');
      if (typeof flashSave === 'function') flashSave();
      if (typeof sndSave   === 'function') sndSave();
      if (typeof burstSave === 'function') burstSave();
    }
    startTimer();
  }, 400);
}

function saveBwWorkout() {
  const name  = document.getElementById('exercise-name').value.trim();
  const notes = document.getElementById('session-notes').value.trim();
  if (!name) { showToast('Enter or pick an exercise!'); return; }

  const rows = document.querySelectorAll('#bw-sets-container .bw-set-row');
  if (!rows.length) { showToast('Add at least one set!'); return; }

  const sets = [];
  rows.forEach(r => {
    const reps   = parseInt(r.querySelector('.bw-reps').value);
    const effort = r.querySelector('.bw-effort').value;
    if (reps > 0) sets.push({ reps, effort });
  });
  if (!sets.length) { showToast('Enter rep counts!'); return; }

  const btn = document.getElementById('save-btn');
  btn.classList.add('loading'); btn.textContent = 'Savingâ€¦';

  setTimeout(() => {
    // Find BW exercise info
    const bwEx = BW_EXERCISES.find(e => e.name.toLowerCase() === name.toLowerCase());
    const muscle = bwEx ? bwEx.muscle : (selectedMuscle || 'Core');

    // Check PR (max reps in a single set)
    const prevSessions = bwWorkouts.filter(w => w.exercise.toLowerCase() === name.toLowerCase());
    const prevMaxReps  = prevSessions.length ? Math.max(...prevSessions.flatMap(w => w.sets.map(s => s.reps))) : 0;
    const newMaxReps   = Math.max(...sets.map(s => s.reps));
    const isPR = newMaxReps > prevMaxReps;

    const totalReps = sets.reduce((a,s) => a+s.reps, 0);

    bwWorkouts.push({
      id: Date.now(), date: new Date().toISOString(),
      exercise: name, muscle, sets, notes,
      totalReps, isPR, type: 'bodyweight'
    });
    saveBwData();

    // Reset form
    document.getElementById('exercise-name').value = '';
    document.getElementById('session-notes').value = '';
    document.getElementById('bw-sets-container').innerHTML = '';
    document.getElementById('last-session-hint').style.display = 'none';
    bwSetCount = 0;
    document.getElementById('set-count-badge').textContent = '0 SETS';
    renderBwExercisePicker();
    renderBwStats();
    updateStatBar();
    postSaveHooks();

    btn.classList.remove('loading');
    btn.innerHTML = '<svg class="btn-icon-svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' + (typeof t==='function' && currentLang==='ar' ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'Log Workout');

    if (isPR) {
      showToast(typeof t==='function' && currentLang==='ar' ? `Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ! ${newMaxReps} ØªÙƒØ±Ø§Ø± â€” Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯!` : `BW PR! ${newMaxReps} reps â€” new record!`);
      if (typeof flashPR  === 'function') flashPR();
      if (typeof sndPR    === 'function') sndPR();
    } else {
      showToast(typeof t==='function' && currentLang==='ar' ? `${name} â€” ${totalReps} ØªÙƒØ±Ø§Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ` : `${name} logged! ${totalReps} total reps`);
      if (typeof flashSave === 'function') flashSave();
      if (typeof sndSave   === 'function') sndSave();
    }
    startTimer();
  }, 300);
}

// BW XP and Steps XP are now inlined directly in calcXP() above (no override needed)
// BW reps appended to volume display inside updateStatBar() directly (see main function above)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI EDIT MODE â€” LAYOUT MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let layoutConfig = JSON.parse(localStorage.getItem('forge_layout') || 'null');
const DEFAULT_SECTION_ORDER = [
  'section-steps', 'section-timer', 'section-indicators', 'section-mission',
  'section-templates', 'section-bodymap', 'section-exercise', 'section-coach', 'section-tips'
];

function saveLayout() {
  // Query ALL log-sections anywhere in the document (some may have escaped view-log)
  const order = [];
  document.querySelectorAll('.log-section').forEach(el => {
    if (el.id) order.push({ id: el.id, hidden: el.dataset.hidden === 'true' });
  });
  layoutConfig = order;
  localStorage.setItem('forge_layout', JSON.stringify(layoutConfig));
}

function applyLayout() {
  const logView = document.getElementById('view-log');
  if (!logView) return;

  // ALWAYS re-parent any orphaned log-sections back into view-log first
  document.querySelectorAll('.log-section').forEach(el => {
    if (el.parentElement !== logView) {
      logView.appendChild(el);
    }
  });

  if (!layoutConfig || !layoutConfig.length) return;

  // Re-order sections according to saved layout
  layoutConfig.forEach(cfg => {
    const el = document.getElementById(cfg.id);
    if (!el) return;
    el.dataset.hidden = cfg.hidden ? 'true' : 'false';
    el.style.display  = cfg.hidden ? 'none' : '';
    logView.appendChild(el); // moves to end in order â€” always inside logView
  });
}

let editModeActive = false;

function toggleEditMode() {
  editModeActive ? exitEditMode() : enterEditMode();
}

function enterEditMode() {
  editModeActive = true;
  document.body.classList.add('edit-mode');
  document.getElementById('edit-mode-bar').classList.add('visible');
  document.getElementById('edit-layout-btn').classList.add('active');
  document.getElementById('edit-layout-btn').innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' + (typeof t==='function' ? t('header.exit')||'Exit' : 'Exit');
  // Make hidden sections visible during edit
  document.querySelectorAll('#view-log .log-section[data-hidden="true"]').forEach(el => {
    el.style.display = '';
  });
  showToast(typeof t==='function' && currentLang==='ar' ? 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ â€” Ø±ØªÙ‘Ø¨ ÙˆØ£Ø®ÙÙ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…' : 'Edit mode â€” reorder & toggle sections', '#f39c12');
}

function exitEditMode() {
  editModeActive = false;
  document.body.classList.remove('edit-mode');
  document.getElementById('edit-mode-bar').classList.remove('visible');
  document.getElementById('edit-layout-btn').classList.remove('active');
  document.getElementById('edit-layout-btn').innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' + (typeof t==='function' ? t('header.edit')||'Edit' : 'Edit');
  // Re-hide hidden sections
  document.querySelectorAll('#view-log .log-section[data-hidden="true"]').forEach(el => {
    el.style.display = 'none';
  });
  saveLayout();
  showToast(typeof t==='function' && currentLang==='ar' ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ®Ø·ÙŠØ·!' : 'Layout saved!');
}

function toggleSectionHidden(sectionId) {
  const el = document.getElementById(sectionId);
  if (!el) return;
  const hidden = el.dataset.hidden === 'true';
  el.dataset.hidden = hidden ? 'false' : 'true';
  // Visual feedback in edit mode â€” don't actually hide during edit
  el.style.opacity  = hidden ? '1' : '0.35';
  showToast(typeof t==='function' && currentLang==='ar' ? (hidden ? 'Ø§Ù„Ù‚Ø³Ù… Ù…Ø±Ø¦ÙŠ' : 'Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ÙÙŠ') : (hidden ? 'Section visible' : 'Section hidden'));
}

function moveSectionUp(sectionId) {
  const el = document.getElementById(sectionId);
  if (!el) return;
  const logView = document.getElementById('view-log');
  // Ensure section is inside view-log before moving
  if (el.parentElement !== logView) logView.appendChild(el);
  let prev = el.previousElementSibling;
  while (prev && !prev.classList.contains('log-section')) prev = prev.previousElementSibling;
  if (prev) {
    logView.insertBefore(el, prev);
    showToast(typeof t==='function' && currentLang==='ar' ? 'â†‘ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù‚Ø³Ù…' : 'â†‘ Section moved up');
  }
}

function moveSectionDown(sectionId) {
  const el = document.getElementById(sectionId);
  if (!el) return;
  const logView = document.getElementById('view-log');
  // Ensure section is inside view-log before moving
  if (el.parentElement !== logView) logView.appendChild(el);
  let next = el.nextElementSibling;
  while (next && !next.classList.contains('log-section')) next = next.nextElementSibling;
  if (next) {
    logView.insertBefore(next, el);
    showToast(typeof t==='function' && currentLang==='ar' ? 'â†“ ØªÙ… Ø®ÙØ¶ Ø§Ù„Ù‚Ø³Ù…' : 'â†“ Section moved down');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  THEME WIPE TRANSITION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playThemeWipe() {
  const el = document.getElementById('theme-wipe');
  if (!el) return;
  el.classList.remove('wipe');
  void el.offsetWidth;
  el.classList.add('wipe');
  el.addEventListener('animationend', () => el.classList.remove('wipe'), { once: true });
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AMBIENT GLOW â€” canvas-less CSS pulse
//  (already handled by CSS ::before + ambientPulse keyframe)
//  We just update --glow-x/--glow-y on mousemove for a spotlight feel
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('pointermove', (e) => {
  const xPct = ((e.clientX / window.innerWidth)  * 100).toFixed(1);
  const yPct = ((e.clientY / window.innerHeight) * 100).toFixed(1);
  document.documentElement.style.setProperty('--glow-x', xPct + '%');
  document.documentElement.style.setProperty('--glow-y', yPct + '%');
}, { passive: true });


// saveWorkout FX are injected directly in saveWorkout() â€” see main script block.

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LEVEL-UP DETECTION  (reads DOM after postSaveHooks updates XP bar)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _RANK_NAMES = {
  'ğŸŒ±': 'ROOKIE',   'ğŸ”©': 'IRON',    'ğŸ¥‰': 'BRONZE',
  'ğŸ¥ˆ': 'SILVER',   'ğŸ¥‡': 'GOLD',    'ğŸ’': 'PLATINUM',
  'ğŸ’ ': 'DIAMOND',  'âš¡': 'MASTER',  'ğŸ”¥': 'GRANDMASTER',
  'ğŸ‘‘': 'LEGEND',   'ğŸ†': 'G.O.A.T.'
};
const _RANK_NAMES_AR = {
  'ğŸŒ±': 'Ù…Ø¨ØªØ¯Ø¦',    'ğŸ”©': 'Ø­Ø¯ÙŠØ¯',    'ğŸ¥‰': 'Ø¨Ø±ÙˆÙ†Ø²',
  'ğŸ¥ˆ': 'ÙØ¶Ø©',      'ğŸ¥‡': 'Ø°Ù‡Ø¨',     'ğŸ’': 'Ø¨Ù„Ø§ØªÙŠÙ†',
  'ğŸ’ ': 'Ø£Ù„Ù…Ø§Ø³',    'âš¡': 'Ø£Ø³ØªØ§Ø°',   'ğŸ”¥': 'Ø³ÙŠØ¯ ÙƒØ¨ÙŠØ±',
  'ğŸ‘‘': 'Ø£Ø³Ø·ÙˆØ±Ø©',   'ğŸ†': 'Ø§Ù„Ø£Ø¹Ø¸Ù…'
};
let _lastLevelIcon = null;

function _checkLevelUp() {
  const el = document.getElementById('level-icon');
  if (!el) return;
  const icon = el.textContent.trim();
  if (_lastLevelIcon === null) { _lastLevelIcon = icon; return; } // seed on first call
  if (icon !== _lastLevelIcon) {
    _lastLevelIcon = icon;
    const _isAr = (typeof currentLang !== 'undefined') && currentLang === 'ar';
    const rName = _isAr ? (_RANK_NAMES_AR[icon] || 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ') : (_RANK_NAMES[icon] || 'NEXT LEVEL');
    showLevelUp(rName, icon);
  }
}

/* Seed on first load after XP bar renders */
setTimeout(() => {
  const el = document.getElementById('level-icon');
  if (el) _lastLevelIcon = el.textContent.trim();
}, 900);


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AMBIENT GLOW CSS VAR INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.documentElement.style.setProperty('--glow-x', '50%');
document.documentElement.style.setProperty('--glow-y', '40%');

</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ARABIC / MULTILINGUAL TRANSLATION SYSTEM
     + ANDROID / MOBILE FIXES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TRANSLATION DICTIONARY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LANGS = {
  en: {
    // Header
    'app.title': 'FORGE',
    'app.subtitle': '// Gym OS',
    'header.edit': 'Edit',
    'header.done': 'DONE',
    'header.editLayout': 'EDIT LAYOUT',
    'header.editHint': 'â†‘â†“ reorder Â· toggle visibility',

    // Mode toggle
    'mode.weighted': 'Weighted',
    'mode.bodyweight': 'Bodyweight',

    // Sections
    'section.steps': 'Steps',
    'section.timer': 'Rest Timer',
    'section.indicators': 'Smart Stats',
    'section.mission': "Today's Mission",
    'section.templates': 'Templates',
    'section.bodymap': 'Body Map',
    'section.coach': 'AI Coach',

    // Steps panel
    'steps.title': 'Daily Steps',
    'steps.goal': 'Goal',
    'steps.add': '+ Add Steps',
    'steps.addBtn': 'Add',
    'steps.streak': 'Day Streak',
    'steps.today': 'Today',
    'steps.placeholder': 'Enter steps...',

    // Timer
    'timer.title': 'Rest Timer',
    'timer.start': 'â–¶ Start',
    'timer.reset': 'â–  Reset',
    'timer.go': 'GO!',

    // Indicators
    'ind.volume': "Today's Volume",
    'ind.streak': 'Day Streak',
    'ind.prs': 'Total PRs',
    'ind.week': 'This Week',
    'ind.allTime': 'All time',
    'ind.sessions': 'Sessions',
    'ind.start': 'Start logging',
    'ind.keepGoing': 'Keep going!',

    // Mission
    'mission.title': "TODAY'S MISSION",
    'mission.complete': 'COMPLETE',
    'mission.locked': 'LOCKED',
    'mission.reward': 'Reward',

    // Workout form
    'form.muscle': 'Muscle Group',
    'form.exercise': 'Exercise',
    'form.sets': 'Sets',
    'form.weight': 'Weight',
    'form.reps': 'Reps',
    'form.addSet': '+ Add Set',
    'form.save': 'Save Workout',
    'form.lastHint': 'Last session',
    'form.unit': 'Unit',
    'form.notes': 'Notes',
    'form.selectMuscle': 'Select Muscle',
    'form.selectExercise': 'Select Exercise',

    // BW workout
    'bw.title': 'Bodyweight Workout',
    'bw.exercise': 'Exercise',
    'bw.effort': 'Effort',
    'bw.reps': 'Reps',
    'bw.sets': 'Sets',
    'bw.save': 'Save BW Workout',
    'bw.easy': 'Easy',
    'bw.medium': 'Medium',
    'bw.hard': 'Hard',
    'bw.max': 'MAX',
    'bw.addSet': '+ Add Set',
    'bw.selectExercise': 'Select Exercise',

    // History
    'history.title': 'WORKOUT LOG',
    'history.filter.muscle': 'All Muscles',
    'history.filter.exercise': 'Search exercise...',
    'history.filter.newest': 'Newest First',
    'history.filter.oldest': 'Oldest First',
    'history.filter.volume': 'Most Volume',
    'history.empty': 'No workouts yet',
    'history.emptyHint': 'Log your first session!',
    'history.set': 'set',
    'history.sets': 'sets',
    'history.reps': 'reps',
    'history.vol': 'vol',
    'history.pr': 'PR',
    'history.sessions': 'Sessions',
    'history.totalReps': 'Total Reps',
    'history.bestSet': 'Best Set',

    // PRs
    'prs.title': 'PERSONAL RECORDS',
    'prs.weighted': 'WEIGHTED PRs',
    'prs.bodyweight': 'BODYWEIGHT PRs',
    'prs.empty': 'No PRs yet',
    'prs.emptyHint': 'Start logging to set records!',
    'prs.best': 'Best',
    'prs.reps': 'reps',

    // Dashboard
    'dash.title': 'STATS',
    'dash.volume': 'Volume Split',
    'dash.frequency': 'Frequency',
    'dash.water': 'Water Tracker',
    'dash.body': 'Body Composition',
    'dash.today': 'Today',
    'dash.week': 'This Week',
    'dash.month': 'This Month',
    'dash.addWater': '+ Glass',
    'dash.waterGoal': 'Daily goal',
    'dash.glasses': 'glasses',

    // More view
    'more.profile': 'Profile',
    'more.settings': 'Settings',
    'more.templates': 'My Templates',
    'more.data': 'Data & Export',
    'more.install': 'Install on Phone',
    'more.bwHistory': 'Bodyweight History',
    'more.bodyComp': 'Body Composition',

    // Profile
    'profile.level': 'Level',
    'profile.xp': 'XP',
    'profile.workouts': 'Workouts',
    'profile.streak': 'Streak',
    'profile.prs': 'PRs',
    'profile.editName': 'Edit Name',

    // Settings
    'settings.title': 'Settings',
    'settings.unit': 'Weight Unit',
    'settings.sound': 'Rest Timer Sound',
    'settings.soundHint': 'Vibrate & beep when rest ends',
    'settings.hint': 'Show Last Session Hint',
    'settings.hintHint': 'Shows previous sets when logging',
    'settings.language': 'Language',
    'settings.theme': 'Theme',

    // Data
    'data.export': 'Export Workouts (CSV)',
    'data.backup': 'Backup All Data (JSON)',
    'data.restore': 'Restore from Backup',
    'data.clear': 'Clear All Data',

    // Install
    'install.android': 'Android (Chrome)',
    'install.androidText': 'Tap the three-dot menu â†’ "Add to Home screen" â†’ Install.',
    'install.ios': 'iPhone (Safari)',
    'install.iosText': 'Tap the Share button â†’ "Add to Home Screen" â†’ Add.',
    'install.apk': 'Get a Real APK',
    'install.apkText': 'Host on GitHub Pages, then use pwabuilder.com for an APK.',

    // Body map
    'bodymap.title': 'Body Map',
    'bodymap.front': 'Front',
    'bodymap.back': 'Back',
    'bodymap.tap': 'Tap a muscle to log',
    'bodymap.selected': 'Selected',
    'bodymap.train': 'Train This Muscle',

    // Muscle overlay
    'overlay.history': 'History',
    'overlay.tips': 'Tips',
    'overlay.exercises': 'Exercises',
    'overlay.sessions': 'sessions logged',
    'overlay.totalVol': 'Total Vol',
    'overlay.bestPR': 'Best PR',
    'overlay.lastTrained': 'Last Trained',
    'overlay.noWorkouts': 'No workouts yet',

    // Coach tabs & status
    'coach.tab.insights':  'Insights',
    'coach.tab.plan':      'Week Plan',
    'coach.tab.nutrition': 'Nutrition',
    'coach.tab.prs':       'PRs',
    'coach.status.init':   'Analysing your trainingâ€¦',

    // Smart Tips
    'section.tips': 'Smart Tips',
    'section.tipsbadge': 'HINTS',
    'tip.overload.title': 'Progressive Overload',
    'tip.overload.text': 'Aim to add 2.5â€“5 kg every 2 weeks. Small gains compound into massive results.',
    'tip.timer.title': 'Use the Rest Timer',
    'tip.timer.text': 'Consistent rest periods (60â€“120s) lead to better strength performance across sets.',

    // Dashboard stats bar
    'dash.statVol': 'Total Volume',
    'dash.statSessions': 'Sessions',
    'dash.statSets': 'Total Sets',
    'dash.statPR': 'Personal Best',
    'dash.allTime': 'All time',
    // Dashboard section headers
    'dash.wgtSection': 'Weight Lifting',
    'dash.bwSection': 'Bodyweight',
    // BW stat cards
    'dash.bwSessions': 'BW Sessions',
    'dash.bwSets': 'BW Sets',
    'dash.bwTopEx': 'Top Exercise',
    'dash.bwStreak': 'BW Streak',
    // History view
    'hist.title': 'Workout History',
    'hist.sub': 'All your sessions & personal records',
    'hist.prs': 'Personal Records',
    'hist.filter': 'Filter & Search',
    'hist.filterMuscle': 'Muscle',
    'hist.filterEx': 'Exercise',
    'hist.filterSort': 'Sort',
    'hist.log': 'Workout Log',
    // More/Settings view heroes
    'more.title': 'Settings & Tools',
    'more.sub': 'Profile, themes, data & more',
    // Settings toggles (new keys)
    'settings.lightMode': 'Light Mode',
    'settings.lightModeSub': 'Switch to SOLAR warm theme',
    'settings.unitSub': 'Sets will default to this unit',
    'settings.soundSub': 'Vibrate & beep when rest ends',
    'settings.hintSub': 'Shows previous sets when logging',

    // Toasts / messages
    'toast.saved': 'Workout saved!',
    'toast.deleted': 'Deleted',
    'toast.pr': 'New PR!',
    'toast.cleared': 'All data cleared',
    'toast.imported': 'Data imported!',
    'toast.exported': 'Exported!',
    'toast.stepsSaved': 'Steps saved!',
    'toast.noSteps': 'Enter steps first',

    // Achievements
    'ach.title': 'ACHIEVEMENT UNLOCKED',

    // Templates
    'tmpl.name': 'Template Name',
    'tmpl.muscle': 'Muscle Group',
    'tmpl.exercises': 'Exercises (comma-separated)',
    'tmpl.icon': 'Emoji Icon',
    'tmpl.save': 'Save Template',
    'tmpl.new': 'New Template',
    'tmpl.load': 'Load',
    'tmpl.delete': 'Delete',
    'tmpl.placeholder': 'e.g. Push Day A',
    'tmpl.exPlaceholder': 'Bench Press, Incline DB, Cable Fly',

    // Nav
    'nav.log': 'Log',
    'nav.stats': 'Stats',
    'nav.history': 'History',
    'nav.more': 'More',

    // General
    'btn.save': 'Save',
    'btn.cancel': 'Cancel',
    'btn.confirm': 'Confirm',
    'btn.delete': 'Delete',
    'btn.edit': 'Edit',
    'btn.close': 'âœ•',
    'lbl.kg': 'kg',
    'lbl.lbs': 'lbs',
    'lbl.days': 'd',
  },

  ar: {
    // Header
    'app.title': 'ÙÙˆØ±Ø¬',
    'app.subtitle': '// ØªØªØ¨Ø¹ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†',
    'header.edit': 'ØªØ¹Ø¯ÙŠÙ„',
    'header.done': 'ØªÙ…',
    'header.editLayout': 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ®Ø·ÙŠØ·',
    'header.editHint': 'â†‘â†“ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Â· Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±',

    // Mode toggle
    'mode.weighted': 'Ø£ÙˆØ²Ø§Ù†',
    'mode.bodyweight': 'ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…',

    // Sections
    'section.steps': 'Ø§Ù„Ø®Ø·ÙˆØ§Øª',
    'section.timer': 'Ù…Ø¤Ù‚Øª Ø§Ù„Ø±Ø§Ø­Ø©',
    'section.indicators': 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
    'section.mission': 'Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…',
    'section.templates': 'Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨',
    'section.bodymap': 'Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø³Ù…',
    'section.coach': 'Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø°ÙƒÙŠ',

    // Steps panel
    'steps.title': 'Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…',
    'steps.goal': 'Ø§Ù„Ù‡Ø¯Ù',
    'steps.add': '+ Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ§Øª',
    'steps.addBtn': 'Ø¥Ø¶Ø§ÙØ©',
    'steps.streak': 'Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©',
    'steps.today': 'Ø§Ù„ÙŠÙˆÙ…',
    'steps.placeholder': 'Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª...',

    // Timer
    'timer.title': 'Ù…Ø¤Ù‚Øª Ø§Ù„Ø±Ø§Ø­Ø©',
    'timer.start': 'â–¶ Ø¨Ø¯Ø¡',
    'timer.reset': 'â–  Ø¥Ø¹Ø§Ø¯Ø©',
    'timer.go': 'Ø§Ù†Ø·Ù„Ù‚!',

    // Indicators
    'ind.volume': 'Ø­Ø¬Ù… ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…',
    'ind.streak': 'Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©',
    'ind.prs': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©',
    'ind.week': 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
    'ind.allTime': 'ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª',
    'ind.sessions': 'Ø¬Ù„Ø³Ø§Øª',
    'ind.start': 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
    'ind.keepGoing': 'Ø§Ø³ØªÙ…Ø±!',

    // Mission
    'mission.title': 'Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…',
    'mission.complete': 'Ù…ÙƒØªÙ…Ù„Ø©',
    'mission.locked': 'Ù…Ù‚ÙÙ„Ø©',
    'mission.reward': 'Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©',

    // Workout form
    'form.muscle': 'Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø¶Ù„Ø§Øª',
    'form.exercise': 'Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
    'form.sets': 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
    'form.weight': 'Ø§Ù„ÙˆØ²Ù†',
    'form.reps': 'Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª',
    'form.addSet': '+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©',
    'form.save': 'Ø­ÙØ¸ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
    'form.lastHint': 'Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©',
    'form.unit': 'Ø§Ù„ÙˆØ­Ø¯Ø©',
    'form.notes': 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
    'form.selectMuscle': 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¶Ù„Ø©',
    'form.selectExercise': 'Ø§Ø®ØªØ± Ø§Ù„ØªÙ…Ø±ÙŠÙ†',

    // BW workout
    'bw.title': 'ØªÙ…Ø±ÙŠÙ† ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…',
    'bw.exercise': 'Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
    'bw.effort': 'Ø§Ù„Ø¬Ù‡Ø¯',
    'bw.reps': 'ØªÙƒØ±Ø§Ø±Ø§Øª',
    'bw.sets': 'Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
    'bw.save': 'Ø­ÙØ¸ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
    'bw.easy': 'Ø³Ù‡Ù„',
    'bw.medium': 'Ù…ØªÙˆØ³Ø·',
    'bw.hard': 'ØµØ¹Ø¨',
    'bw.max': 'Ø£Ù‚ØµÙ‰',
    'bw.addSet': '+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©',
    'bw.selectExercise': 'Ø§Ø®ØªØ± Ø§Ù„ØªÙ…Ø±ÙŠÙ†',

    // History
    'history.title': 'Ø³Ø¬Ù„ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†',
    'history.filter.muscle': 'ÙƒÙ„ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª',
    'history.filter.exercise': 'Ø§Ø¨Ø­Ø« Ø¹Ù† ØªÙ…Ø±ÙŠÙ†...',
    'history.filter.newest': 'Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹',
    'history.filter.oldest': 'Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹',
    'history.filter.volume': 'Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø­Ø¬Ù…Ø§Ù‹',
    'history.empty': 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ…Ø§Ø±ÙŠÙ† Ø¨Ø¹Ø¯',
    'history.emptyHint': 'Ø³Ø¬Ù‘Ù„ Ø¬Ù„Ø³ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰!',
    'history.set': 'Ù…Ø¬Ù…ÙˆØ¹Ø©',
    'history.sets': 'Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
    'history.reps': 'ØªÙƒØ±Ø§Ø±',
    'history.vol': 'Ø­Ø¬Ù…',
    'history.pr': 'Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ',
    'history.sessions': 'Ø¬Ù„Ø³Ø§Øª',
    'history.totalReps': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª',
    'history.bestSet': 'Ø£ÙØ¶Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø©',

    // PRs
    'prs.title': 'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©',
    'prs.weighted': 'Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£ÙˆØ²Ø§Ù†',
    'prs.bodyweight': 'Ø£Ø±Ù‚Ø§Ù… ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…',
    'prs.empty': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù‚ÙŠØ§Ø³ÙŠØ© Ø¨Ø¹Ø¯',
    'prs.emptyHint': 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…!',
    'prs.best': 'Ø§Ù„Ø£ÙØ¶Ù„',
    'prs.reps': 'ØªÙƒØ±Ø§Ø±',

    // Dashboard
    'dash.title': 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
    'dash.volume': 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¬Ù…',
    'dash.frequency': 'Ø§Ù„ØªÙƒØ±Ø§Ø±',
    'dash.water': 'Ù…ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø§Ø¡',
    'dash.body': 'ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ø³Ù…',
    'dash.today': 'Ø§Ù„ÙŠÙˆÙ…',
    'dash.week': 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
    'dash.month': 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
    'dash.addWater': '+ ÙƒÙˆØ¨',
    'dash.waterGoal': 'Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ',
    'dash.glasses': 'Ø£ÙƒÙˆØ§Ø¨',

    // More view
    'more.profile': 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
    'more.settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
    'more.templates': 'Ù‚ÙˆØ§Ù„Ø¨ÙŠ',
    'more.data': 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØµØ¯ÙŠØ±',
    'more.install': 'Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ',
    'more.bwHistory': 'Ø³Ø¬Ù„ ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…',
    'more.bodyComp': 'ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ø³Ù…',

    // Profile
    'profile.level': 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰',
    'profile.xp': 'Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø©',
    'profile.workouts': 'Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†',
    'profile.streak': 'Ø§Ù„ØªØªØ§Ù„ÙŠ',
    'profile.prs': 'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©',
    'profile.editName': 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…',

    // Settings
    'settings.title': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
    'settings.unit': 'ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ²Ù†',
    'settings.sound': 'ØµÙˆØª Ù…Ø¤Ù‚Øª Ø§Ù„Ø±Ø§Ø­Ø©',
    'settings.soundHint': 'Ø§Ù‡ØªØ²Ø§Ø² ÙˆØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø§Ø­Ø©',
    'settings.hint': 'Ø¹Ø±Ø¶ ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©',
    'settings.hintHint': 'ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
    'settings.language': 'Ø§Ù„Ù„ØºØ©',
    'settings.theme': 'Ø§Ù„Ù…Ø¸Ù‡Ø±',

    // Data
    'data.export': 'ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† (CSV)',
    'data.backup': 'Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)',
    'data.restore': 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
    'data.clear': 'Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',

    // Install
    'install.android': 'Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (Chrome)',
    'install.androidText': 'Ø§Ø¶ØºØ· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â† "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" â† ØªØ«Ø¨ÙŠØª.',
    'install.ios': 'Ø¢ÙŠÙÙˆÙ† (Safari)',
    'install.iosText': 'Ø§Ø¶ØºØ· Ù…Ø´Ø§Ø±ÙƒØ© â† "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" â† Ø¥Ø¶Ø§ÙØ©.',
    'install.apk': 'Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ APK',
    'install.apkText': 'Ø§Ø³ØªØ¶Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ GitHub Pages Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù… pwabuilder.com Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ APK.',

    // Body map
    'bodymap.title': 'Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø³Ù…',
    'bodymap.front': 'Ø£Ù…Ø§Ù…ÙŠ',
    'bodymap.back': 'Ø®Ù„ÙÙŠ',
    'bodymap.tap': 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ø¶Ù„Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„',
    'bodymap.selected': 'Ø§Ù„Ù…Ø®ØªØ§Ø±',
    'bodymap.train': 'ØªØ¯Ø±ÙŠØ¨ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø¶Ù„Ø©',

    // Muscle overlay
    'overlay.history': 'Ø§Ù„Ø³Ø¬Ù„',
    'overlay.tips': 'Ù†ØµØ§Ø¦Ø­',
    'overlay.exercises': 'Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†',
    'overlay.sessions': 'Ø¬Ù„Ø³Ø§Øª Ù…Ø³Ø¬Ù„Ø©',
    'overlay.totalVol': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬Ù…',
    'overlay.bestPR': 'Ø£ÙØ¶Ù„ Ø±Ù‚Ù…',
    'overlay.lastTrained': 'Ø¢Ø®Ø± ØªØ¯Ø±ÙŠØ¨',
    'overlay.noWorkouts': 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ…Ø§Ø±ÙŠÙ† Ø¨Ø¹Ø¯',

    // Coach tabs & status
    'coach.tab.insights':  'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª',
    'coach.tab.plan':      'Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©',
    'coach.tab.nutrition': 'Ø§Ù„ØªØºØ°ÙŠØ©',
    'coach.tab.prs':       'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©',
    'coach.status.init':   'Ø¬Ø§Ø±Ù ØªØ­Ù„ÙŠÙ„ ØªØ¯Ø±ÙŠØ¨Ùƒâ€¦',

    // Smart Tips
    'section.tips': 'Ù†ØµØ§Ø¦Ø­ Ø°ÙƒÙŠØ©',
    'section.tipsbadge': 'ØªÙ„Ù…ÙŠØ­Ø§Øª',
    'tip.overload.title': 'Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ',
    'tip.overload.text': 'Ø§Ø³ØªÙ‡Ø¯Ù Ø¥Ø¶Ø§ÙØ© 2.5â€“5 ÙƒØº ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†. Ø§Ù„Ù…ÙƒØ§Ø³Ø¨ Ø§Ù„ØµØºÙŠØ±Ø© ØªØªØ±Ø§ÙƒÙ… Ù„Ù†ØªØ§Ø¦Ø¬ Ø¶Ø®Ù…Ø©.',
    'tip.timer.title': 'Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚Øª Ø§Ù„Ø±Ø§Ø­Ø©',
    'tip.timer.text': 'ÙØªØ±Ø§Øª Ø±Ø§Ø­Ø© Ù…Ù†ØªØ¸Ù…Ø© (60â€“120 Ø«Ø§Ù†ÙŠØ©) ØªØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ù‚ÙˆØ© Ø£ÙØ¶Ù„ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.',

    // Dashboard stats bar
    'dash.statVol': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬Ù…',
    'dash.statSessions': 'Ø§Ù„Ø¬Ù„Ø³Ø§Øª',
    'dash.statSets': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
    'dash.statPR': 'Ø£ÙØ¶Ù„ Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ',
    'dash.allTime': 'ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª',
    // Dashboard section headers
    'dash.wgtSection': 'Ø±ÙØ¹ Ø§Ù„Ø£Ø«Ù‚Ø§Ù„',
    'dash.bwSection': 'ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ø¬Ø³Ù…',
    // BW stat cards
    'dash.bwSessions': 'Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø¬Ø³Ù…',
    'dash.bwSets': 'Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¬Ø³Ù…',
    'dash.bwTopEx': 'Ø£ÙØ¶Ù„ ØªÙ…Ø±ÙŠÙ†',
    'dash.bwStreak': 'Ø§Ù„ØªØ³Ù„Ø³Ù„',
    // History view
    'hist.title': 'Ø³Ø¬Ù„ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†',
    'hist.sub': 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©',
    'hist.prs': 'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©',
    'hist.filter': 'ØªØµÙÙŠØ© ÙˆØ¨Ø­Ø«',
    'hist.filterMuscle': 'Ø§Ù„Ø¹Ø¶Ù„Ø©',
    'hist.filterEx': 'Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
    'hist.filterSort': 'ØªØ±ØªÙŠØ¨',
    'hist.log': 'Ø³Ø¬Ù„ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†',
    // More/Settings view
    'more.title': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª',
    'more.sub': 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„Ø³Ù…Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
    'more.profile': 'Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ',
    'more.templates': 'Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨',
    'more.bodyComp': 'ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ø³Ù…',
    'more.settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
    'more.data': 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØµØ¯ÙŠØ±',
    // Settings toggles
    'settings.lightMode': 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ',
    'settings.lightModeSub': 'Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù…Ø© SOLAR Ø§Ù„Ø¯Ø§ÙØ¦Ø©',
    'settings.unit': 'ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©',
    'settings.unitSub': 'Ø³ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
    'settings.sound': 'ØµÙˆØª Ù…Ø¤Ù‚Øª Ø§Ù„Ø±Ø§Ø­Ø©',
    'settings.soundSub': 'Ø§Ù‡ØªØ²Ø§Ø² ÙˆØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø§Ø­Ø©',
    'settings.hint': 'Ø¥Ø¸Ù‡Ø§Ø± ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©',
    'settings.hintSub': 'ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',

    // Toasts
    'toast.saved': 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ…Ø±ÙŠÙ†!',
    'toast.deleted': 'ØªÙ… Ø§Ù„Ø­Ø°Ù',
    'toast.pr': 'Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!',
    'toast.cleared': 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
    'toast.imported': 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!',
    'toast.exported': 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±!',
    'toast.stepsSaved': 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·ÙˆØ§Øª!',
    'toast.noSteps': 'Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹',

    // Achievements
    'ach.title': 'Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯!',

    // Templates
    'tmpl.name': 'Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨',
    'tmpl.muscle': 'Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø¶Ù„Ø§Øª',
    'tmpl.exercises': 'Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)',
    'tmpl.icon': 'Ø£ÙŠÙ‚ÙˆÙ†Ø©',
    'tmpl.save': 'Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨',
    'tmpl.new': 'Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯',
    'tmpl.load': 'ØªØ­Ù…ÙŠÙ„',
    'tmpl.delete': 'Ø­Ø°Ù',
    'tmpl.placeholder': 'Ù…Ø«Ø§Ù„: ÙŠÙˆÙ… Ø§Ù„Ø¯ÙØ¹ A',
    'tmpl.exPlaceholder': 'Ø¶ØºØ· ØµØ¯Ø±ØŒ Ø¯Ù…Ø¨Ù„ Ù…Ø§Ø¦Ù„ØŒ ÙƒÙŠØ¨Ù„',

    // Nav
    'nav.log': 'ØªØ³Ø¬ÙŠÙ„',
    'nav.stats': 'Ø¥Ø­ØµØ§Ø¡',
    'nav.history': 'Ø§Ù„Ø³Ø¬Ù„',
    'nav.more': 'Ø§Ù„Ù…Ø²ÙŠØ¯',

    // General
    'btn.save': 'Ø­ÙØ¸',
    'btn.cancel': 'Ø¥Ù„ØºØ§Ø¡',
    'btn.confirm': 'ØªØ£ÙƒÙŠØ¯',
    'btn.delete': 'Ø­Ø°Ù',
    'btn.edit': 'ØªØ¹Ø¯ÙŠÙ„',
    'btn.close': 'âœ•',
    'lbl.kg': 'ÙƒØº',
    'lbl.lbs': 'Ø±Ø·Ù„',
    'lbl.days': 'ÙŠ',
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TRANSLATION ENGINE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentLang = localStorage.getItem('forge_lang') || 'en';

/** Translate a key â€” falls back to English if key missing in Arabic */
function t(key) {
  return (LANGS[currentLang] && LANGS[currentLang][key]) || LANGS.en[key] || key;
}

function toggleLanguage() {
  currentLang = currentLang === 'en' ? 'ar' : 'en';
  localStorage.setItem('forge_lang', currentLang);
  applyLanguage();
}

function applyLanguage() {
  const isAr = currentLang === 'ar';
  const html = document.documentElement;

  // Set dir and lang attributes
  html.setAttribute('dir', isAr ? 'rtl' : 'ltr');
  html.setAttribute('lang', isAr ? 'ar' : 'en');

  // Update language button
  const btn = document.getElementById('lang-toggle-btn');
  if (btn) btn.textContent = isAr ? 'EN' : 'AR';

  // Translate all static data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const attr = el.getAttribute('data-i18n-attr');
    if (attr) {
      el.setAttribute(attr, t(key));
    } else {
      el.textContent = t(key);
    }
  });

  // Translate placeholder attributes
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });

  // Translate specific dynamic elements by ID
  translateDynamicElements();

  // Re-render dynamic panels (they use JS-generated HTML)
  if (typeof renderStepsPanel === 'function') renderStepsPanel();
  if (typeof renderMissions === 'function') renderMissions();
  // Re-render XP bar so rank name updates in the correct language
  if (typeof updateXPBar === 'function') updateXPBar();
  if (typeof renderProfile === 'function') renderProfile();
  // Always refresh stat bar and coach on language switch so text updates immediately
  if (typeof updateStatBar === 'function') updateStatBar();
  if (typeof renderCoach === 'function') renderCoach();
  if (typeof renderCoachPlan === 'function') renderCoachPlan();
  if (typeof renderCoachNutrition === 'function') renderCoachNutrition();
  if (typeof renderCoachPRs === 'function') renderCoachPRs();
  const vHistory = document.getElementById('view-history');
  if (typeof renderHistory === 'function' && vHistory && vHistory.classList.contains('active')) {
    renderHistory(); if (typeof renderPRs === 'function') renderPRs();
  }
  const vDash = document.getElementById('view-dashboard');
  if (typeof renderDashboard === 'function' && vDash && vDash.classList.contains('active')) {
    renderDashboard();
  }
  const vMore = document.getElementById('view-more');
  if (typeof renderMyTemplates === 'function' && vMore && vMore.classList.contains('active')) {
    renderMyTemplates();
  }

  // Update nav labels
  updateNavLabels();
  // Update mode buttons
  updateModeButtons();
  // Update form labels
  updateFormLabels();
  // Update static section labels
  updateStaticLabels();
}

function translateDynamicElements() {
  // Edit mode bar
  const eml = document.querySelector('.edit-mode-label');
  if (eml) eml.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' + t('header.editLayout');
  const emh = document.querySelector('.edit-hint');
  if (emh) emh.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>' + t('header.editHint');
  const editBtn = document.getElementById('edit-layout-btn');
  if (editBtn && !editBtn.classList.contains('active')) editBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' + t('header.edit');
  const doneBtn = document.querySelector('.edit-done-btn');
  if (doneBtn) doneBtn.textContent = t('header.done');

  // App subtitle
  const tag = document.getElementById('header-greeting');
  // only update if it still shows the default subtitle (don't overwrite greeting)
  if (tag && (tag.textContent === '// Gym OS' || tag.textContent === '// ØªØªØ¨Ø¹ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†')) {
    tag.textContent = t('app.subtitle');
  }

  // Timer section
  const timerLabel = document.querySelector('.timer-widget .section-label');
  if (timerLabel) timerLabel.textContent = t('timer.title');
  const startBtn = document.querySelector('.timer-controls .btn-ghost:first-child');
  const resetBtn = document.querySelector('.timer-controls .btn-ghost:last-child');
  // Use querySelectorAll for timer buttons
  const timerBtns = document.querySelectorAll('.timer-controls .btn.btn-ghost.btn-sm');
  if (timerBtns[0]) timerBtns[0].textContent = t('timer.start');
  if (timerBtns[1]) timerBtns[1].textContent = t('timer.reset');

  // Stat indicator labels
  const labels = {
    'stat-vol': { label: 'ind.volume', sub: 'stat-vol-delta' },
    'stat-streak': { label: 'ind.streak', sub: 'stat-streak-delta' },
    'stat-prs': { label: 'ind.prs', sub: 'stat-prs-delta' },
    'stat-week': { label: 'ind.week', sub: 'stat-week-delta' },
  };
  document.querySelectorAll('.ind-card').forEach((card, i) => {
    const labelEl = card.querySelector('.ind-label');
    const subEl   = card.querySelector('.ind-sub');
    const keys = [
      { label: 'ind.volume', sub: null },
      { label: 'ind.streak', sub: null },
      { label: 'ind.prs',    sub: null },
      { label: 'ind.week',   sub: 'ind.sessions' },
    ];
    if (keys[i] && labelEl) labelEl.textContent = t(keys[i].label);
    if (keys[i] && keys[i].sub && subEl && subEl.textContent === 'Sessions') {
      subEl.textContent = t('ind.sessions');
    }
  });

  // History filter options
  const fm = document.getElementById('filter-muscle');
  if (fm && fm.options[0]) fm.options[0].text = t('history.filter.muscle');
  const fsort = document.getElementById('filter-sort');
  if (fsort) {
    const sortMap = ['history.filter.newest', 'history.filter.oldest', 'history.filter.volume'];
    Array.from(fsort.options).forEach((opt, i) => {
      if (sortMap[i]) opt.text = t(sortMap[i]);
    });
  }
  const fex = document.getElementById('filter-exercise');
  if (fex) fex.placeholder = t('history.filter.exercise');

  // Modal - template
  const tmplTitle = document.querySelector('#template-modal .modal-sheet > div:first-of-type');
  if (tmplTitle) tmplTitle.textContent = t('tmpl.new');
  const tmplLabels = document.querySelectorAll('#template-modal .form-group label');
  const tmplLabelKeys = ['tmpl.name', 'tmpl.muscle', 'tmpl.exercises', 'tmpl.icon'];
  tmplLabels.forEach((el, i) => { if (tmplLabelKeys[i]) el.textContent = t(tmplLabelKeys[i]); });
  const tmplSaveBtn = document.querySelector('#template-modal .btn-primary');
  if (tmplSaveBtn) tmplSaveBtn.textContent = t('tmpl.save');

  // Achievement popup title
  const achTitle = document.querySelector('.ach-title');
  if (achTitle) achTitle.textContent = t('ach.title');

  // Muscle overlay tabs
  const moTabs = document.querySelectorAll('.mo-tab');
  const moTabKeys = ['overlay.history', 'overlay.tips', 'overlay.exercises'];
  moTabs.forEach((tab, i) => { if (moTabKeys[i]) tab.textContent = t(moTabKeys[i]); });

  // Muscle overlay stat labels
  const moStatLbls = document.querySelectorAll('.mo-stat-lbl');
  const moStatKeys = ['overlay.sessions', 'overlay.totalVol', 'overlay.bestPR', 'overlay.lastTrained'];
  moStatLbls.forEach((el, i) => { if (moStatKeys[i]) el.textContent = t(moStatKeys[i]); });

  // Muscle overlay CTA
  const moCta = document.getElementById('mo-cta-btn');
  if (moCta) moCta.querySelector('span').textContent = t('bodymap.train');

  // Muscle overlay sub line (sessions count text)
  const moSub = document.getElementById('mo-sub');
  if (moSub) {
    const count = moSub.textContent.split(' ')[0];
    moSub.textContent = count + ' ' + t('overlay.sessions');
  }

  // Body map front/back buttons
  const bodyBtns = document.querySelectorAll('.body-map-controls button, .body-view-btn');
  if (bodyBtns[0]) bodyBtns[0].textContent = t('bodymap.front');
  if (bodyBtns[1]) bodyBtns[1].textContent = t('bodymap.back');

  // History panel title
  const histTitle = document.querySelector('#view-history .section-label:first-child, .history-title');
  if (histTitle) histTitle.textContent = t('history.title');

  // PRs title
  const prsTitle = document.querySelector('.prs-title, #prs-panel .section-label');
  if (prsTitle) prsTitle.textContent = t('prs.title');

  // More view section labels
  translateMoreView();

  // Settings panel
  translateSettings();

  // Data panel buttons
  translateDataPanel();

  // Install guide
  translateInstallGuide();

  // PWA install banner
  const pwaBannerTitle = document.getElementById('pwa-banner-title');
  const pwaBannerSub   = document.getElementById('pwa-banner-sub');
  const pwaInstallBtn  = document.getElementById('pwa-install-btn');
  const isAr = (typeof currentLang !== 'undefined') && currentLang === 'ar';
  if (pwaBannerTitle) pwaBannerTitle.textContent = isAr ? 'ØªØ«Ø¨ÙŠØª ÙÙˆØ±Ø¬' : 'Install FORGE';
  if (pwaBannerSub)   pwaBannerSub.textContent   = isAr ? 'Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„Ø©' : 'Add to home screen for the full app experience';
  if (pwaInstallBtn)  pwaInstallBtn.textContent   = isAr ? 'ØªØ«Ø¨ÙŠØª' : 'INSTALL';
}

function updateNavLabels() {
  const navMap = {
    'bnav-log': 'nav.log',
    'bnav-dashboard': 'nav.stats',
    'bnav-history': 'nav.history',
    'bnav-more': 'nav.more',
  };
  Object.entries(navMap).forEach(([id, key]) => {
    const btn = document.getElementById(id);
    if (!btn) return;
    // Nav button has SVG + text node
    const textNodes = Array.from(btn.childNodes).filter(n => n.nodeType === 3);
    if (textNodes.length) {
      textNodes[textNodes.length - 1].textContent = t(key);
    }
  });
}

function updateModeButtons() {
  const wb = document.getElementById('mode-btn-weighted');
  const bb = document.getElementById('mode-btn-bodyweight');
  if (wb) wb.innerHTML = '<svg class="mode-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><line x1="6" y1="5" x2="6" y2="19"/><line x1="18" y1="5" x2="18" y2="19"/><line x1="2" y1="12" x2="22" y2="12"/><rect x="1" y="9" width="5" height="6" rx="1"/><rect x="18" y="9" width="5" height="6" rx="1"/><rect x="9" y="7" width="6" height="10" rx="1"/></svg>' + t('mode.weighted');
  if (bb) bb.innerHTML = '<svg class="mode-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:5px;"><circle cx="12" cy="5" r="2"/><path d="M12 7v8"/><path d="M8 17l4 4 4-4"/><path d="M9 12l-2 2"/><path d="M15 12l2 2"/></svg>' + t('mode.bodyweight');
}

function updateFormLabels() {
  // Main workout form labels
  const formLabelMap = [
    { sel: '#muscle-select', prev: true, key: 'form.muscle' },
    { sel: '#exercise-select', prev: true, key: 'form.exercise' },
  ];
  // Muscle group select in main form
  const muscleLabel = document.querySelector('label[for="muscle-select"]');
  if (muscleLabel) muscleLabel.textContent = t('form.muscle');
  const exerciseLabel = document.querySelector('label[for="exercise-select"]');
  if (exerciseLabel) exerciseLabel.textContent = t('form.exercise');

  // Save button
  const saveBtn = document.querySelector('[onclick="saveWorkout()"]');
  if (saveBtn) saveBtn.textContent = t('form.save');
  const saveBwBtn = document.querySelector('[onclick="saveBwWorkout()"]');
  if (saveBwBtn) saveBwBtn.textContent = t('bw.save');

  // Add set buttons
  document.querySelectorAll('[onclick="addSet()"]').forEach(btn => btn.textContent = t('form.addSet'));
  document.querySelectorAll('[onclick="addBwSet()"]').forEach(btn => btn.textContent = t('bw.addSet'));
}

function updateStaticLabels() {
  // Section labels (Rest Timer title, etc.)
  document.querySelectorAll('.section-label').forEach(el => {
    const txt = el.textContent.trim();
    if (txt === 'Rest Timer' || txt === 'Ù…Ø¤Ù‚Øª Ø§Ù„Ø±Ø§Ø­Ø©') el.textContent = t('timer.title');
    if (txt === 'EDIT LAYOUT' || txt === 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ®Ø·ÙŠØ·') return; // handled elsewhere
  });
}

function translateMoreView() {
  // Panel titles in More view - use text content matching
  document.querySelectorAll('#view-more .panel-title').forEach(el => {
    const txt = el.textContent.trim();
    const map = {
      'My Profile': t('more.profile'),
      'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ': t('more.profile'),
      'Settings': t('more.settings'),
      'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª': t('more.settings'),
      'My Templates': t('more.templates'),
      'Ù‚ÙˆØ§Ù„Ø¨ÙŠ': t('more.templates'),
      'Data & Export': t('more.data'),
      'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØµØ¯ÙŠØ±': t('more.data'),
      'Install on Phone': t('more.install'),
      'Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ': t('more.install'),
      'Bodyweight History': t('more.bwHistory'),
      'Ø³Ø¬Ù„ ÙˆØ²Ù† Ø§Ù„Ø¬Ø³Ù…': t('more.bwHistory'),
      'Body Composition': t('more.bodyComp'),
      'ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ø³Ù…': t('more.bodyComp'),
    };
    if (map[txt]) el.textContent = map[txt];
  });
  // Profile edit button
  const profEdit = document.querySelector('[onclick="editName()"]');
  if (profEdit) profEdit.textContent = t('profile.editName');
}

function translateSettings() {
  document.querySelectorAll('.toggle-label').forEach(el => {
    const txt = el.textContent.trim();
    const map = {
      'Rest Timer Sound': t('settings.sound'),
      'ØµÙˆØª Ù…Ø¤Ù‚Øª Ø§Ù„Ø±Ø§Ø­Ø©': t('settings.sound'),
      'Show Last Session Hint': t('settings.hint'),
      'Ø¹Ø±Ø¶ ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©': t('settings.hint'),
    };
    if (map[txt]) el.textContent = map[txt];
  });
  // Hint text under toggles
  document.querySelectorAll('.toggle-row > div > div:nth-child(2)').forEach(el => {
    const txt = el.textContent.trim();
    const map = {
      'Vibrate & beep when rest ends': t('settings.soundHint'),
      'Ø§Ù‡ØªØ²Ø§Ø² ÙˆØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø§Ø­Ø©': t('settings.soundHint'),
      'Shows previous sets when logging': t('settings.hintHint'),
      'ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„': t('settings.hintHint'),
    };
    if (map[txt]) el.textContent = map[txt];
  });
}

function translateDataPanel() {
  document.querySelectorAll('#view-more .panel-body .btn').forEach(el => {
    // Preserve SVG child node, only replace text nodes
    const svgEl = el.querySelector('svg');
    const txt = el.textContent.trim();
    const replaceText = (newTxt) => {
      // Remove all text nodes, keep child elements (SVG)
      Array.from(el.childNodes).forEach(n => { if (n.nodeType === 3) n.remove(); });
      el.appendChild(document.createTextNode(newTxt));
    };
    if (txt.includes('Export') || txt.includes('ØªØµØ¯ÙŠØ±')) {
      replaceText(t('data.export'));
    } else if (txt.includes('Backup') || txt.includes('Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ')) {
      replaceText(t('data.backup'));
    } else if (txt.includes('Clear') || txt.includes('Ù…Ø³Ø­')) {
      replaceText(t('data.clear'));
    } else if (txt.includes('Restore') || txt.includes('Ø§Ø³ØªØ¹Ø§Ø¯Ø©')) {
      // label has hidden file input â€” preserve it
      const input = el.querySelector('input');
      Array.from(el.childNodes).forEach(n => { if (n.nodeType === 3) n.remove(); });
      el.appendChild(document.createTextNode(t('data.restore')));
      if (input) el.appendChild(input);
    }
  });
}

function translateInstallGuide() {
  const tipCards = document.querySelectorAll('#view-more .tip-card');
  tipCards.forEach(card => {
    const titleEl = card.querySelector('.tip-title');
    const textEl  = card.querySelector('.tip-text');
    if (!titleEl || !textEl) return;
    const title = titleEl.textContent.trim();
    const map = {
      'Android (Chrome)':   { title: t('install.android'), text: t('install.androidText') },
      'Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (Chrome)':   { title: t('install.android'), text: t('install.androidText') },
      'iPhone (Safari)':    { title: t('install.ios'),     text: t('install.iosText') },
      'Ø¢ÙŠÙÙˆÙ† (Safari)':     { title: t('install.ios'),     text: t('install.iosText') },
      'Get a Real APK':     { title: t('install.apk'),     text: t('install.apkText') },
      'Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ APK':     { title: t('install.apk'),     text: t('install.apkText') },
    };
    if (map[title]) {
      titleEl.textContent = map[title].title;
      textEl.textContent  = map[title].text;
    }
  });
}

// renderStepsPanel already handles Arabic internally â€” no patch needed.

// showToast is defined in the main script â€” no override needed.
// Use the global t() function to translate strings before passing to showToast().

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ANDROID / MOBILE FIXES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// 1. Fast tap on buttons (removes 300ms delay on Android)
// Only preventDefault on non-scrollable button elements to avoid scroll interference
let _lastTouchTime = 0;
document.addEventListener('touchend', function(e) {
  const tgt = e.target.closest('button:not([data-scroll]), .bnav-btn, .mode-toggle-btn');
  if (!tgt) return;
  const now = Date.now();
  if (now - _lastTouchTime < 350) { e.preventDefault(); } // prevent double-tap zoom only
  _lastTouchTime = now;
}, { passive: false });

// 2. Fix viewport height on Android (address bar changes vh)
function setVh() {
  document.documentElement.style.setProperty('--real-vh', window.innerHeight * 0.01 + 'px');
}
setVh();
window.addEventListener('resize', setVh, { passive: true });
window.addEventListener('orientationchange', () => setTimeout(setVh, 300), { passive: true });

// 3. Prevent body scroll when modal is open (Android scroll lock)
function lockBodyScroll()   { document.body.style.overflow = 'hidden'; }
function unlockBodyScroll() { document.body.style.overflow = ''; }

// 4. Fix input zoom on Android â€” ensure all number inputs have inputmode
function fixMobileInputs() {
  document.querySelectorAll('input[type="number"]').forEach(inp => {
    if (!inp.getAttribute('inputmode')) inp.setAttribute('inputmode', 'numeric');
  });
  document.querySelectorAll('input[type="text"]').forEach(inp => {
    if (!inp.getAttribute('inputmode')) inp.setAttribute('inputmode', 'text');
  });
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', fixMobileInputs, { once: true });
} else {
  fixMobileInputs();
}
// Re-run after dynamic content renders
setTimeout(fixMobileInputs, 1500);

// 5. Smooth scroll fix for Android
document.querySelectorAll('.panel-body, .view, .mo-content').forEach(el => {
  el.style.webkitOverflowScrolling = 'touch';
  el.style.overflowY = 'auto';
});

// 6. Add active state visual feedback for touch (Android doesn't show :hover)
document.addEventListener('touchstart', function(e) {
  const tgt = e.target.closest('button, .btn, .bnav-btn, .ind-card, .wk-entry');
  if (tgt) tgt.classList.add('touch-active');
}, { passive: true });
document.addEventListener('touchend', function(e) {
  document.querySelectorAll('.touch-active').forEach(el => el.classList.remove('touch-active'));
}, { passive: true });

// Add touch-active CSS + comprehensive Android fixes via JS
(function() {
  const style = document.createElement('style');
  style.textContent = `
    /* Touch feedback */
    .touch-active { opacity: 0.75 !important; transform: scale(0.97) !important; transition: none !important; }

    /* Android safe-area & layout */
    @media (max-width: 767px) {
      .bottom-nav { height: calc(64px + env(safe-area-inset-bottom, 0px)); }
      body {
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 72px);
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
      }
      /* Larger touch targets */
      .bnav-btn { min-height: 56px; padding-bottom: env(safe-area-inset-bottom, 0px); }
      .btn { min-height: 44px; }
      /* All inputs at 16px to prevent auto-zoom on Android & iOS */
      input, select, textarea { font-size: 16px !important; }
      /* Smooth scrolling in panels â€” NOT .view (view display is controlled by JS/CSS separately) */
      .panel-body, .mo-content, .view-scroll, .view-inner {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }
      /* Prevent accidental text selection on tap */
      button, .btn, .bnav-btn, .mode-toggle-btn, .tip-card, .ind-card {
        -webkit-user-select: none;
        user-select: none;
      }
    }

    /* PWA Install Banner */
    #pwa-install-banner {
      display: none;
      position: fixed;
      bottom: calc(72px + env(safe-area-inset-bottom, 0px));
      left: 12px; right: 12px;
      background: var(--panel);
      border: 1px solid var(--green);
      border-radius: 14px;
      padding: 14px 16px;
      z-index: 9999;
      box-shadow: 0 4px 24px #0008;
      animation: slideUp .3s ease;
    }
    #pwa-install-banner.show { display: flex; align-items: center; gap: 12px; }
    #pwa-install-banner .pwa-icon { font-size: 28px; flex-shrink: 0; }
    #pwa-install-banner .pwa-text { flex: 1; }
    #pwa-install-banner .pwa-title { font-family: 'Bebas Neue', sans-serif; font-size: 16px; color: var(--green); letter-spacing: 1px; }
    #pwa-install-banner .pwa-sub { font-size: 11px; color: var(--text2); margin-top: 2px; }
    #pwa-install-banner .pwa-btn { background: var(--green); color: #000; border: none; border-radius: 8px; padding: 8px 14px; font-family: 'Bebas Neue', sans-serif; font-size: 14px; letter-spacing: 1px; cursor: pointer; flex-shrink: 0; }
    #pwa-install-banner .pwa-dismiss { background: none; border: none; color: var(--text3); font-size: 18px; cursor: pointer; padding: 4px 8px; flex-shrink: 0; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  `;
  document.head.appendChild(style);
})();

// PWA Install Banner (Android Chrome "beforeinstallprompt")
(function() {
  let _deferredPrompt = null;
  const BANNER_DISMISSED_KEY = 'forge_install_dismissed';

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    _deferredPrompt = e;

    // Don't show if user already dismissed or app is already installed
    if (localStorage.getItem(BANNER_DISMISSED_KEY)) return;
    if (window.matchMedia('(display-mode: standalone)').matches) return;

    // Show banner after 3 seconds
    setTimeout(() => {
      const banner = document.getElementById('pwa-install-banner');
      if (banner) banner.classList.add('show');
    }, 3000);
  });

  // Install button click
  document.addEventListener('click', function(e) {
    if (e.target.closest('#pwa-install-btn')) {
      if (_deferredPrompt) {
        _deferredPrompt.prompt();
        _deferredPrompt.userChoice.then(choice => {
          _deferredPrompt = null;
          const banner = document.getElementById('pwa-install-banner');
          if (banner) banner.classList.remove('show');
          if (choice.outcome === 'accepted') localStorage.setItem(BANNER_DISMISSED_KEY, '1');
        });
      }
    }
    if (e.target.closest('#pwa-dismiss-btn')) {
      const banner = document.getElementById('pwa-install-banner');
      if (banner) banner.classList.remove('show');
      localStorage.setItem(BANNER_DISMISSED_KEY, '1');
    }
  });

  // Hide banner if already installed
  if (window.matchMedia('(display-mode: standalone)').matches) {
    const banner = document.getElementById('pwa-install-banner');
    if (banner) banner.classList.remove('show');
  }
})();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT â€” Apply saved language on page load
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initLanguage() {
  // Always set the button label correctly on load
  function setLangBtn() {
    const btn = document.getElementById('lang-toggle-btn');
    if (btn) btn.textContent = currentLang === 'ar' ? 'EN' : 'AR';
  }

  if (currentLang === 'ar') {
    // Apply RTL and translate after DOM + all scripts are fully ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => setTimeout(applyLanguage, 400));
    } else {
      // DOM already loaded â€” apply after a generous delay so renderMissions/renderStepsPanel etc. are ready
      setTimeout(applyLanguage, 400);
    }
  }

  // Set button label
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setLangBtn);
  } else {
    setLangBtn();
  }
})();

</script>

<!-- PWA Install Banner (shown by JS when beforeinstallprompt fires on Android Chrome) -->
<div id="pwa-install-banner" role="dialog" aria-label="Install FORGE">
  <div class="pwa-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
  <div class="pwa-text">
    <div class="pwa-title" id="pwa-banner-title">Install FORGE</div>
    <div class="pwa-sub" id="pwa-banner-sub">Add to home screen for the full app experience</div>
  </div>
  <button class="pwa-btn" id="pwa-install-btn">INSTALL</button>
  <button class="pwa-dismiss" id="pwa-dismiss-btn" aria-label="Dismiss">âœ•</button>
</div>

<!-- SERVICE WORKER -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('[FORGE SW] Registered:', reg.scope))
      .catch(err => console.log('[FORGE SW] Not available (local file mode)'));
  });
}
</script>
</body>
</html>
